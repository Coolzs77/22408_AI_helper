<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â˜ï¸ 22408 å¤‡è€ƒå°çª v4.1 (Latexå¢å¼ºç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Marked for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- KaTeX for Math -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- html2pdf.js for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        cream: '#fdfbf7',
                        sidebar: '#fffefc',
                        darkbg: '#0f172a',
                        darkcard: '#1e293b',
                        darksidebar: '#020617',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                        cute: ['"Comic Sans MS"', '"Chalkboard SE"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace']
                    },
                    animation: {
                        'float': 'float 4s ease-in-out infinite',
                        'breathe': 'breathe 4s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-6px)' },
                        },
                        breathe: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' },
                        }
                    },
                    typography: (theme) => ({
                        DEFAULT: {
                            css: {
                                color: theme('colors.slate.600'),
                                strong: { color: theme('colors.pink.500') },
                                'ul > li::marker': { color: theme('colors.slate.400') },
                            },
                        },
                        dark: {
                            css: {
                                color: theme('colors.slate.300'),
                                strong: { color: theme('colors.pink.400') },
                            }
                        }
                    }),
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&family=Fredoka:wght@400;600&family=JetBrains+Mono:wght@500&display=swap');
        
        body { font-family: 'Noto Sans SC', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .font-cute { font-family: 'Fredoka', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Sidebar Active State */
        .nav-item.active {
            background-color: #fce7f3; 
            color: #db2777; 
            font-weight: 700;
            box-shadow: 0 2px 10px rgba(244, 114, 182, 0.1);
        }
        .dark .nav-item.active {
            background-color: #831843; 
            color: #fbcfe8; 
            box-shadow: none;
        }
        
        /* Timeline & Checkbox */
        .timeline-line {
            position: absolute; left: 24px; top: 35px; bottom: -20px; width: 2px; background-color: #e2e8f0; z-index: 0;
        }
        .dark .timeline-line { background-color: #334155; }
        .timeline-item:last-child .timeline-line { display: none; }

        .checkbox-wrapper input { display: none; }
        .checkbox-wrapper label {
            cursor: pointer; width: 20px; height: 20px; border-radius: 50%;
            border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; background: white; position: relative; z-index: 10;
        }
        .dark .checkbox-wrapper label { background: #1e293b; border-color: #475569; }
        
        .checkbox-wrapper input:checked + label {
            background-color: #f472b6; border-color: #f472b6; color: white;
        }

        /* Glass Card */
        .glass-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(148, 163, 184, 0.05);
            border: 1px solid #f1f5f9;
            transition: transform 0.2s, background-color 0.3s, border-color 0.3s;
        }
        .dark .glass-card {
            background: #1e293b; 
            border-color: #334155;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .glass-card:hover { transform: translateY(-2px); }
        
        /* AI Response Typography - Clean & Readable */
        .ai-content { font-size: 0.95rem; line-height: 1.7; color: #334155; }
        .dark .ai-content { color: #e2e8f0; }
        
        /* Colorful headings with gradient effects - FIXED: Higher specificity to prevent override */
        .ai-content h1 { 
            margin-top: 1.2em; margin-bottom: 0.6em; font-weight: 800; 
            color: #1e40af !important; letter-spacing: -0.02em; font-size: 1.5em;
        }
        .ai-content h2 { 
            margin-top: 1.2em; margin-bottom: 0.6em; font-weight: 800; 
            color: #0891b2 !important; letter-spacing: -0.02em; font-size: 1.3em;
        }
        .ai-content h3 { 
            margin-top: 1.2em; margin-bottom: 0.6em; font-weight: 800; 
            color: #059669 !important; letter-spacing: -0.02em; font-size: 1.15em;
        }
        .ai-content h4 { 
            margin-top: 1em; margin-bottom: 0.5em; font-weight: 700; 
            color: #7c3aed !important; letter-spacing: -0.02em;
        }
        .dark .ai-content h1 { color: #60a5fa !important; }
        .dark .ai-content h2 { color: #22d3ee !important; }
        .dark .ai-content h3 { color: #34d399 !important; }
        .dark .ai-content h4 { color: #a78bfa !important; }
        
        .ai-content p { margin-bottom: 1em; }
        
        .ai-content ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .ai-content ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .ai-content li { margin-bottom: 0.4em; }
        
        /* Bold text colors - Applied via JavaScript for accurate per-section coloring */
        .ai-content strong { font-weight: 700; }
        
        /* Tables in ai-content */
        .ai-content table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        .ai-content table th,
        .ai-content table td { border: 1px solid #e2e8f0; padding: 0.5em; text-align: left; }
        .dark .ai-content table th,
        .dark .ai-content table td { border-color: #475569; }
        .ai-content table th { background: #f8fafc; font-weight: 700; }
        .dark .ai-content table th { background: #1e293b; }
        
        .ai-content blockquote { 
            border-left: 4px solid #3b82f6; padding-left: 1em; 
            color: #1e40af; font-style: italic; margin-bottom: 1em; 
            background: #eff6ff; padding: 0.5em 1em; border-radius: 0 8px 8px 0;
        }
        .dark .ai-content blockquote { 
            border-color: #60a5fa; color: #93c5fd; background: #1e3a8a; 
        }

        .ai-content code { 
            background-color: #f0fdf4; color: #16a34a; padding: 0.1em 0.3em; 
            border-radius: 0.2em; font-family: 'JetBrains Mono', monospace; font-size: 0.9em;
            border: 1px solid #bbf7d0;
        }
        .dark .ai-content code { background-color: #14532d; color: #86efac; border-color: #166534; }
        
        .katex-display { overflow-x: auto; overflow-y: hidden; padding: 0.5em 0; }
        
        /* Tabs */
        .tab-btn.active {
            background-color: #eff6ff; color: #3b82f6; border-bottom: 2px solid #3b82f6;
        }
        .dark .tab-btn.active {
            background-color: #1e293b; color: #60a5fa; border-bottom: 2px solid #60a5fa;
        }

        /* Upload Box Style */
        .upload-box {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='10%2c 10' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s;
        }
        .dark .upload-box {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23475569FF' stroke-width='2' stroke-dasharray='10%2c 10' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .upload-box:hover {
            background-color: #f8fafc;
        }
        .dark .upload-box:hover {
            background-color: #1e293b;
        }
        
        /* Modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        /* Mistake Note Styles */
        .mistake-card {
            transition: all 0.2s;
        }
        .mistake-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .tag-math { @apply bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300; }
        .tag-cs { @apply bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-300; }
        .tag-eng { @apply bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-300; }
        .tag-pol { @apply bg-pink-100 text-pink-600 dark:bg-pink-900/30 dark:text-pink-300; }

        /* Mistake Preview Truncation handled carefully with Math */
        .mistake-preview-content {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden selection:bg-pink-100 bg-[#fdfbf7] dark:bg-darkbg text-slate-600 dark:text-slate-300">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="w-64 bg-sidebar dark:bg-darksidebar border-r border-slate-100 dark:border-slate-800 hidden md:flex flex-col p-6 z-50 transition-all duration-300">
        <div class="flex items-center gap-3 mb-10 px-2">
            <div class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900/50 rounded-full flex items-center justify-center text-xl shadow-sm">ğŸ¦†</div>
            <div>
                <h1 class="font-black text-slate-700 dark:text-slate-200 tracking-tight text-lg">22408 å°çª</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Target: 380+</p>
            </div>
        </div>
        
        <nav class="space-y-2 flex-1">
            <button onclick="showView('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i data-lucide="home" class="w-5 h-5"></i> å°çªé¦–é¡µ
            </button>
            <button onclick="showView('schedule')" id="nav-schedule" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i data-lucide="calendar-heart" class="w-5 h-5"></i> å…¨å¤©è®¡åˆ’
            </button>
            <button onclick="showView('grader')" id="nav-grader" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i data-lucide="file-check" class="w-5 h-5"></i> AI é˜…å·å®¤
            </button>
            <button onclick="showView('notebook')" id="nav-notebook" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i data-lucide="book-x" class="w-5 h-5"></i> æ™ºèƒ½é”™é¢˜æœ¬
            </button>
            <button onclick="showView('focus')" id="nav-focus" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i data-lucide="hourglass" class="w-5 h-5"></i> ä¸“æ³¨æ°”æ³¡
            </button>
        </nav>

        <div class="space-y-3 mt-auto">
             <!-- API Key Settings Button -->
             <button onclick="toggleKeyModal()" class="w-full flex items-center justify-center gap-2 py-2 rounded-2xl border border-indigo-100 dark:border-indigo-900 bg-indigo-50 dark:bg-indigo-900/20 text-xs font-bold text-indigo-500 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition-colors">
                <i data-lucide="key" class="w-4 h-4"></i>
                <span id="key-status-text">è®¾ç½® API Key</span>
            </button>

            <!-- Data Backup Button -->
            <div class="flex gap-2">
                <button onclick="exportData()" class="flex-1 flex items-center justify-center gap-1 py-2 rounded-2xl border border-slate-200 dark:border-slate-700 text-xs font-bold text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" title="å¯¼å‡ºæ•°æ®">
                    <i data-lucide="download" class="w-4 h-4"></i> å¤‡ä»½
                </button>
                <button onclick="document.getElementById('import-file').click()" class="flex-1 flex items-center justify-center gap-1 py-2 rounded-2xl border border-slate-200 dark:border-slate-700 text-xs font-bold text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" title="å¯¼å…¥æ•°æ®">
                    <i data-lucide="upload" class="w-4 h-4"></i> æ¢å¤
                </button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
            </div>

            <button onclick="toggleDarkMode()" class="w-full flex items-center justify-center gap-2 py-2 rounded-2xl border border-slate-200 dark:border-slate-700 text-xs font-bold text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <i data-lucide="moon" class="w-4 h-4 dark:hidden"></i>
                <i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i>
                <span id="theme-text">åˆ‡æ¢å¤œé—´æ¨¡å¼</span>
            </button>
        </div>
    </aside>

    <!-- MOBILE NAV -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-darksidebar/90 backdrop-blur-md border-t border-slate-100 dark:border-slate-800 z-50 flex justify-around p-3 pb-6">
        <button onclick="showView('dashboard')" class="text-pink-500"><i data-lucide="home"></i></button>
        <button onclick="showView('notebook')" class="text-slate-400"><i data-lucide="book-x"></i></button>
        <button onclick="showView('grader')" class="text-slate-400"><i data-lucide="file-check"></i></button>
        <button onclick="toggleKeyModal()" class="text-indigo-500"><i data-lucide="key"></i></button>
    </nav>

    <!-- SIDEBAR TOGGLE BUTTON -->
    <button id="sidebar-toggle" onclick="toggleSidebar()" style="left: calc(16rem + 1rem);" class="hidden md:flex fixed top-4 z-50 w-10 h-10 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-full items-center justify-center text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all shadow-md">
        <i data-lucide="panel-left-close" class="w-5 h-5" id="sidebar-icon"></i>
    </button>

    <!-- MAIN CONTENT -->
    <main id="main-content" class="flex-1 h-full overflow-y-auto p-4 md:p-10 relative scroll-smooth transition-all duration-300">
        <div class="absolute top-0 left-0 right-0 h-1.5 bg-gradient-to-r from-blue-200 via-pink-200 to-yellow-200 dark:opacity-50"></div>

        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
            <div>
                <h2 class="text-2xl md:text-3xl font-black text-slate-700 dark:text-slate-100 mb-1" id="greeting-title">æ—©ä¸Šå¥½ï¼â˜€ï¸</h2>
                <p class="text-sm text-slate-400 dark:text-slate-500 font-medium" id="greeting-sub">ç›®æ ‡ 380ï¼Œä»Šå¤©ä¹Ÿè¦å…¨åŠ›ä»¥èµ´ã€‚</p>
            </div>
            <div class="bg-white dark:bg-darkcard px-5 py-3 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex items-center gap-4 transition-colors">
                <div class="text-right">
                    <div class="text-[10px] text-pink-400 font-bold uppercase tracking-widest">Countdown</div>
                    <div class="font-cute text-2xl font-black text-slate-700 dark:text-slate-200 tabular-nums leading-none" id="main-countdown-days">
                        28 <span class="text-sm text-slate-400 font-sans font-normal">Days</span>
                    </div>
                </div>
                <div class="h-8 w-px bg-slate-100 dark:bg-slate-700"></div>
                <div class="font-mono text-lg text-slate-500 dark:text-slate-400 tabular-nums" id="main-countdown-time">00:00:00</div>
            </div>
        </header>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="space-y-6 animate-in fade-in zoom-in duration-300">
            
            <!-- ğŸ¦† AI Emotional Support Duck -->
            <div class="bg-white dark:bg-darkcard rounded-[30px] p-6 md:p-8 shadow-sm border border-slate-100 dark:border-slate-700 relative overflow-hidden group transition-colors">
                <div class="absolute top-0 right-0 w-64 h-64 bg-yellow-50 dark:bg-yellow-500/10 rounded-full blur-3xl -mr-20 -mt-20 opacity-60"></div>
                <div class="relative z-10 flex flex-col md:flex-row gap-6 items-start">
                    
                    <div class="flex-shrink-0 flex flex-col items-center gap-2">
                        <div class="w-24 h-24 bg-yellow-100 dark:bg-yellow-900/40 rounded-full flex items-center justify-center text-5xl shadow-sm animate-float cursor-pointer select-none border-4 border-white dark:border-darkcard" onclick="changeQuote()">ğŸ¦†</div>
                        <button onclick="speakDuck()" class="p-2 rounded-full bg-white dark:bg-slate-800 shadow-sm hover:text-pink-500 transition-colors text-slate-400" title="å¬é¸­é¸­è¯´è¯">
                            <i data-lucide="volume-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="flex-1 w-full">
                        <div class="bg-slate-50 dark:bg-slate-800/50 px-5 py-4 rounded-2xl rounded-bl-none mb-4 border border-slate-100 dark:border-slate-700 relative min-h-[80px]">
                            <div class="absolute -left-2 bottom-0 w-4 h-4 bg-slate-50 dark:bg-slate-800/50 transform skew-x-12 z-0"></div>
                            <div id="duck-quote-container" class="relative z-10">
                                <p class="text-slate-600 dark:text-slate-300 text-sm md:text-base leading-relaxed font-medium ai-content" id="duck-quote">
                                    â€œå˜¿ï¼åˆ«æ‹…å¿ƒä½ çš„408å¤§é¢˜ï¼Œåªè¦å†™æ»¡é€»è¾‘å°±æœ‰åˆ†ï¼å–å£æ°´ï¼Œæˆ‘ä»¬ç»§ç»­ï¼Ÿâ€
                                </p>
                            </div>
                            <div id="ai-chat-container" class="hidden relative z-10 flex flex-col gap-3">
                                <div id="ai-response-area" class="text-slate-700 dark:text-slate-200 text-sm md:text-base leading-relaxed max-h-[500px] overflow-y-auto pr-2 space-y-4">
                                    <div class="flex gap-2 items-start">
                                        <div class="flex-shrink-0 w-8 h-8 bg-yellow-100 dark:bg-yellow-900/40 rounded-full flex items-center justify-center text-xl">ğŸ¦†</div>
                                        <div class="flex-1 bg-slate-100 dark:bg-slate-700/50 rounded-2xl rounded-tl-none px-4 py-2 text-sm ai-content">
                                            <p>æˆ‘æ˜¯ä½ çš„é¸­é¸­åŠ©æ‰‹ï¼Œå¯ä»¥é™ªä½ èŠå¤©ã€å‡ºé¢˜ã€æˆ–è€…è§£é‡Šåè¯å“¦ï¼ğŸ¦†</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar" id="quick-actions">
                                    <button onclick="triggerQuickAction('è§£é‡Šåè¯ï¼š')" class="whitespace-nowrap px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs text-slate-500 hover:text-indigo-500 hover:border-indigo-200 transition-colors">
                                        ğŸ“– è§£é‡Šåè¯
                                    </button>
                                    <button onclick="triggerQuickAction('å‡ºä¸€é“22408ç›¸å…³çš„é€‰æ‹©é¢˜ï¼Œå¹¶ç»™å‡ºè§£æ')" class="whitespace-nowrap px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs text-slate-500 hover:text-indigo-500 hover:border-indigo-200 transition-colors">
                                        â“ å‡ºä¸€é“é¢˜
                                    </button>
                                    <button onclick="triggerQuickAction('æˆ‘å¾ˆç„¦è™‘ï¼Œå¤‡è€ƒå‹åŠ›å¾ˆå¤§ï¼Œè¯·é¼“åŠ±æˆ‘')" class="whitespace-nowrap px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs text-slate-500 hover:text-pink-500 hover:border-pink-200 transition-colors">
                                        ğŸ†˜ å“„æˆ‘ç¡è§‰
                                    </button>
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="ai-input" class="flex-1 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-pink-400 transition-colors" placeholder="æƒ³é—®ä»€ä¹ˆï¼Ÿ..." onkeypress="handleEnter(event)">
                                    <button onclick="askDuck()" id="ai-send-btn" class="bg-pink-400 hover:bg-pink-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">å‘é€</button>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap justify-between items-center gap-2">
                            <div class="flex flex-wrap gap-2" id="mood-buttons">
                                <button onclick="getAIMoodMessage('tired')" class="px-3 py-1 rounded-full bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 hover:text-blue-500 transition">ğŸ˜« ç´¯äº†</button>
                                <button onclick="getAIMoodMessage('anxious')" class="px-3 py-1 rounded-full bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400 hover:bg-pink-50 dark:hover:bg-pink-900/30 hover:text-pink-500 transition">ğŸ˜° ç„¦è™‘</button>
                                <button onclick="getAIMoodMessage('confident')" class="px-3 py-1 rounded-full bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400 hover:bg-green-50 dark:hover:bg-green-900/30 hover:text-green-500 transition">ğŸ”¥ èƒ½ä¸Šå²¸</button>
                            </div>
                            <button onclick="toggleAIMode()" id="ai-toggle-btn" class="px-4 py-1.5 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-xs font-bold shadow-md hover:shadow-lg hover:scale-105 transition-all flex items-center gap-1">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> é—®é—®é¸­é¸­
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Knowledge Center -->
            <div class="grid grid-cols-1 gap-6">
                <div class="glass-card p-6 relative group min-h-[350px]">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-3 text-sm flex items-center gap-2">
                        <i data-lucide="book-open-check" class="w-4 h-4 text-indigo-500"></i> AI æ™ºå›Šå›¢
                    </h3>
                    <div class="flex items-center gap-4 border-b border-slate-100 dark:border-slate-700 mb-4 pb-2 overflow-x-auto no-scrollbar">
                        <button onclick="switchAiTab('vision')" id="tab-vision" class="tab-btn active whitespace-nowrap text-xs font-bold text-slate-500 pb-2 flex items-center gap-1">
                            <i data-lucide="camera" class="w-3 h-3"></i> æ‹ç…§æœé¢˜
                        </button>
                        <button onclick="switchAiTab('quiz')" id="tab-quiz" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 flex items-center gap-1">
                            <i data-lucide="graduation-cap" class="w-3 h-3"></i> æ¯æ—¥ä¸€ç»ƒ
                        </button>
                        <button onclick="switchAiTab('eng-write-small')" id="tab-eng-write-small" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 hover:text-slate-800 dark:hover:text-slate-200 transition-colors flex items-center gap-1">
                            <i data-lucide="pen-tool" class="w-3 h-3"></i> è‹±è¯­å°ä½œæ–‡
                        </button>
                        <button onclick="switchAiTab('eng-write-big')" id="tab-eng-write-big" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 hover:text-slate-800 dark:hover:text-slate-200 transition-colors flex items-center gap-1">
                            <i data-lucide="pen-tool" class="w-3 h-3"></i> è‹±è¯­å¤§ä½œæ–‡
                        </button>
                        <button onclick="switchAiTab('sentence')" id="tab-sentence" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 hover:text-slate-800 dark:hover:text-slate-200 transition-colors flex items-center gap-1">
                            <i data-lucide="languages" class="w-3 h-3"></i> é•¿éš¾å¥æ‹†è§£
                        </button>
                         <button onclick="switchAiTab('code')" id="tab-code" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 hover:text-slate-800 dark:hover:text-slate-200 transition-colors flex items-center gap-1">
                            <i data-lucide="code-2" class="w-3 h-3"></i> ä»£ç æ¨¡æ¿
                        </button>
                        <button onclick="switchAiTab('memory')" id="tab-memory" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 hover:text-slate-800 dark:hover:text-slate-200 transition-colors flex items-center gap-1">
                            <i data-lucide="brain" class="w-3 h-3"></i> è®°å¿†å®«æ®¿
                        </button>
                        <button onclick="switchAiTab('concept')" id="tab-concept" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 flex items-center gap-1">
                            <i data-lucide="puzzle" class="w-3 h-3"></i> æ¦‚å¿µå¡ç‰‡
                        </button>
                         <button onclick="switchAiTab('interview')" id="tab-interview" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 flex items-center gap-1 hover:text-slate-800 dark:hover:text-slate-200 transition-colors">
                            <i data-lucide="mic" class="w-3 h-3"></i> æ¨¡æ‹Ÿé¢è¯•
                        </button>
                        <button onclick="switchAiTab('doc')" id="tab-doc" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 flex items-center gap-1 hover:text-slate-800 dark:hover:text-slate-200 transition-colors">
                            <i data-lucide="file-text" class="w-3 h-3"></i> æ–‡æ¡£æå–
                        </button>
                    </div>
                    
                    <!-- Content: Vision (Text + Image) -->
                    <div id="content-vision" class="space-y-4">
                        <div class="flex flex-col gap-3">
                            <textarea id="vision-text" class="w-full h-20 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm focus:outline-none focus:border-indigo-400 resize-none" placeholder="è¾“å…¥é—®é¢˜æè¿°ï¼ˆå¯é€‰ï¼Œå¦‚æœ‰å›¾ç‰‡å¯ä¸å¡«ï¼‰..."></textarea>
                            
                            <label class="upload-box flex flex-col items-center justify-center w-full h-24 rounded-xl cursor-pointer group">
                                <div class="flex flex-col items-center justify-center">
                                    <i data-lucide="image-plus" class="w-6 h-6 text-slate-400 mb-1 group-hover:text-indigo-500 transition-colors"></i>
                                    <p class="text-[10px] text-slate-500 dark:text-slate-400">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ (å¯é€‰)</p>
                                </div>
                                <input type="file" class="hidden" id="vision-file" accept="image/*" onchange="handleGenericImageUpload(event, 'vision-preview', 'vision-file')">
                            </label>
                            
                            <div id="vision-preview-container" class="hidden relative rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700">
                                <img id="vision-preview" class="w-full h-48 object-contain bg-black/5 dark:bg-black/20">
                                <button onclick="clearGenericImage('vision-preview', 'vision-file')" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full hover:bg-red-600"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                            
                            <button onclick="analyzeImage()" id="vision-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">å¼€å§‹è§£æ</button>
                        </div>
                        <div id="vision-output" class="hidden bg-indigo-50/50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl p-5 text-sm shadow-sm max-h-[600px] overflow-y-auto space-y-4"></div>
                        <div class="flex items-center justify-between mt-2 gap-2">
                            <button onclick="clearConversation('vision-output')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-red-500" id="vision-clear-btn"><i data-lucide="trash-2" class="w-3 h-3"></i> æ¸…ç©ºå¯¹è¯</button>
                            <div class="flex gap-2 ml-auto">
                                <button onclick="saveResultToNotebook('vision', 'vision-text', 'vision-output')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-indigo-500" id="vision-save-btn"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                                <button onclick="exportToPDF('vision-output', 'AIæ™ºå›Šå›¢', 'æ‹ç…§æœé¢˜')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500" id="vision-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                            </div>
                        </div>
                    </div>

                    <!-- Content: Quiz -->
                    <div id="content-quiz" class="hidden space-y-4">
                        <div class="flex gap-2 mb-4">
                            <select id="quiz-subject" class="bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-400 flex-1">
                                <option value="408 (Computer Science)">408 (CS)</option>
                                <option value="æ•°å­¦ (Math)">æ•°å­¦ (Math)</option>
                                <option value="æ”¿æ²» (Politics)">æ”¿æ²» (Pol)</option>
                                <option value="è‹±è¯­ (English)">è‹±è¯­ (English)</option>
                            </select>
                            <button onclick="generateQuiz()" id="quiz-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold">å‡ºé¢˜</button>
                        </div>
                        <div id="quiz-output" class="hidden bg-indigo-50/50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl p-5 text-sm shadow-sm max-h-[600px] overflow-y-auto space-y-4"></div>
                        <div class="flex items-center justify-between mt-2 gap-2">
                            <button onclick="clearConversation('quiz-output')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-red-500" id="quiz-clear-btn"><i data-lucide="trash-2" class="w-3 h-3"></i> æ¸…ç©ºå¯¹è¯</button>
                            <div class="flex gap-2 ml-auto">
                                <button onclick="saveResultToNotebook('quiz', 'quiz-subject', 'quiz-output')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-indigo-500" id="quiz-save-btn"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                                <button onclick="exportToPDF('quiz-output', 'AIæ™ºå›Šå›¢', 'æ¯æ—¥ä¸€ç»ƒ')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500" id="quiz-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                            </div>
                        </div>
                    </div>

                    <!-- Content: English Small Composition -->
                    <div id="content-eng-write-small" class="hidden space-y-4">
                        <div class="bg-green-50 dark:bg-green-900/10 p-3 rounded-lg border border-green-100 dark:border-green-900/50">
                            <p class="text-xs text-green-600 dark:text-green-300">ğŸ“ è‹±è¯­äºŒÂ·å°ä½œæ–‡æ¨¡æ¿ç”Ÿæˆï¼ˆä¹¦ä¿¡ç±»ï¼šé€šçŸ¥ã€é‚€è¯·ã€å»ºè®®ã€æ„Ÿè°¢ã€é“æ­‰ç­‰ï¼‰</p>
                        </div>
                        <textarea id="eng-write-small-input" class="w-full h-24 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm focus:outline-none focus:border-green-400 resize-none" placeholder="è¾“å…¥å°ä½œæ–‡å…³é”®è¯/ä¸»é¢˜ï¼ˆä¾‹å¦‚ï¼šé€šçŸ¥ã€é‚€è¯·ä¿¡ã€å»ºè®®ä¿¡ã€æ„Ÿè°¢ä¿¡ã€é“æ­‰ä¿¡...ï¼‰"></textarea>
                        <button onclick="generateEngComposition('small')" id="eng-write-small-btn" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">ç”Ÿæˆå°ä½œæ–‡æ¨¡æ¿ & æŠ€å·§</button>
                        <div id="eng-write-small-output" class="hidden bg-green-50/50 dark:bg-green-900/20 border border-green-100 dark:border-green-800 rounded-xl p-5 text-sm shadow-sm max-h-[600px] overflow-y-auto space-y-4"></div>
                        <div class="flex items-center justify-between mt-2 gap-2">
                            <button onclick="clearConversation('eng-write-small-output')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-red-500" id="eng-write-small-clear-btn"><i data-lucide="trash-2" class="w-3 h-3"></i> æ¸…ç©ºå¯¹è¯</button>
                            <div class="flex gap-2 ml-auto">
                                <button onclick="saveResultToNotebook('eng-write-small', 'eng-write-small-input', 'eng-write-small-output')" id="eng-write-small-save-btn" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-green-500"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                                <button onclick="exportToPDF('eng-write-small-output', 'AIæ™ºå›Šå›¢', 'è‹±è¯­å°ä½œæ–‡')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500" id="eng-write-small-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                            </div>
                        </div>
                    </div>

                    <!-- Content: English Big Composition -->
                    <div id="content-eng-write-big" class="hidden space-y-4">
                        <div class="bg-blue-50 dark:bg-blue-900/10 p-3 rounded-lg border border-blue-100 dark:border-blue-900/50">
                            <p class="text-xs text-blue-600 dark:text-blue-300">ğŸ“Š è‹±è¯­äºŒÂ·å¤§ä½œæ–‡æ¨¡æ¿ç”Ÿæˆï¼ˆå›¾è¡¨ç±»ï¼šæŸ±çŠ¶å›¾ã€é¥¼å›¾ã€æŠ˜çº¿å›¾ã€è¡¨æ ¼ç­‰ï¼‰</p>
                        </div>
                        <textarea id="eng-write-big-input" class="w-full h-24 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-400 resize-none" placeholder="è¾“å…¥å¤§ä½œæ–‡å…³é”®è¯/ä¸»é¢˜ï¼ˆä¾‹å¦‚ï¼šæŸ±çŠ¶å›¾ã€é¥¼å›¾ã€æŠ˜çº¿å›¾ã€æ‰‹æœºä¾èµ–ã€ç¯ä¿ã€æ•™è‚²...ï¼‰"></textarea>
                        <button onclick="generateEngComposition('big')" id="eng-write-big-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">ç”Ÿæˆå¤§ä½œæ–‡æ¨¡æ¿ & æŠ€å·§</button>
                        <div id="eng-write-big-output" class="hidden bg-blue-50/50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded-xl p-5 text-sm shadow-sm max-h-[600px] overflow-y-auto space-y-4"></div>
                        <div class="flex items-center justify-between mt-2 gap-2">
                            <button onclick="clearConversation('eng-write-big-output')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-red-500" id="eng-write-big-clear-btn"><i data-lucide="trash-2" class="w-3 h-3"></i> æ¸…ç©ºå¯¹è¯</button>
                            <div class="flex gap-2 ml-auto">
                                <button onclick="saveResultToNotebook('eng-write-big', 'eng-write-big-input', 'eng-write-big-output')" id="eng-write-big-save-btn" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-blue-500"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                                <button onclick="exportToPDF('eng-write-big-output', 'AIæ™ºå›Šå›¢', 'è‹±è¯­å¤§ä½œæ–‡')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500" id="eng-write-big-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                            </div>
                        </div>
                    </div>

                    <!-- Content: Sentence (Image + Text) -->
                    <div id="content-sentence" class="hidden space-y-4">
                        <p class="text-xs text-slate-400">è¾“å…¥æˆ–æ‹ç…§ä¸Šä¼ çœ‹ä¸æ‡‚çš„è‹±è¯­é•¿éš¾å¥ã€‚</p>
                        <textarea id="sentence-input" class="w-full h-20 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm focus:outline-none focus:border-indigo-400 resize-none" placeholder="Paste sentence here..."></textarea>
                        <label class="flex items-center gap-2 cursor-pointer w-fit">
                            <span class="bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded text-xs text-slate-500 hover:bg-slate-200"><i data-lucide="image-plus" class="w-3 h-3 inline mr-1"></i> ä¸Šä¼ å›¾ç‰‡</span>
                            <input type="file" class="hidden" id="sentence-file" accept="image/*" onchange="handleGenericImageUpload(event, 'sentence-preview', 'sentence-file')">
                        </label>
                        <div id="sentence-preview-container" class="hidden relative rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700 w-full">
                            <img id="sentence-preview" class="h-24 object-contain bg-black/5 dark:bg-black/20">
                            <button onclick="clearGenericImage('sentence-preview', 'sentence-file')" class="absolute top-1 left-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                        <button onclick="breakSentence()" id="sentence-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">ä¸€é”®æ‹†è§£</button>
                        <div id="sentence-output" class="hidden bg-indigo-50/50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl p-5 text-sm shadow-sm max-h-[600px] overflow-y-auto space-y-4"></div>
                        <div class="flex items-center justify-between mt-2 gap-2">
                            <button onclick="clearConversation('sentence-output')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-red-500" id="sentence-clear-btn"><i data-lucide="trash-2" class="w-3 h-3"></i> æ¸…ç©ºå¯¹è¯</button>
                            <div class="flex gap-2 ml-auto">
                                <button onclick="saveResultToNotebook('sentence', 'sentence-input', 'sentence-output')" id="sentence-save-btn" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-indigo-500"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                                <button onclick="exportToPDF('sentence-output', 'AIæ™ºå›Šå›¢', 'é•¿éš¾å¥æ‹†è§£')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500" id="sentence-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                            </div>
                        </div>
                    </div>

                    <!-- Content: Memory -->
                    <div id="content-memory" class="hidden space-y-4">
                        <p class="text-xs text-slate-400">è¾“å…¥éš¾èƒŒçš„çŸ¥è¯†ç‚¹åˆ—è¡¨ï¼ŒAI ç”Ÿæˆè®°å¿†å£è¯€ã€‚</p>
                        <textarea id="memory-input" class="w-full h-24 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm focus:outline-none focus:border-indigo-400 resize-none" placeholder="ä¾‹å¦‚ï¼šäº’æ–¥ã€è¯·æ±‚ä¸ä¿æŒã€ä¸å‰¥å¤ºã€å¾ªç¯ç­‰å¾…"></textarea>
                        <button onclick="generateMnemonic()" id="memory-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">ç”Ÿæˆè®°å¿†å®«æ®¿</button>
                        <div id="memory-output" class="hidden bg-indigo-50/50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl p-5 text-sm shadow-sm max-h-[600px] overflow-y-auto space-y-4"></div>
                        <div class="flex items-center justify-between mt-2 gap-2">
                            <button onclick="clearConversation('memory-output')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-red-500" id="memory-clear-btn"><i data-lucide="trash-2" class="w-3 h-3"></i> æ¸…ç©ºå¯¹è¯</button>
                            <div class="flex gap-2 ml-auto">
                                <button onclick="saveResultToNotebook('memory', 'memory-input', 'memory-output')" id="memory-save-btn" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-indigo-500"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                                <button onclick="exportToPDF('memory-output', 'AIæ™ºå›Šå›¢', 'è®°å¿†å®«æ®¿')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500" id="memory-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                            </div>
                        </div>
                    </div>

                    <!-- Content: Concept -->
                    <div id="content-concept" class="hidden space-y-4">
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="concept-input" class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-purple-400" placeholder="ä¾‹å¦‚: KMP, è™šæ‹Ÿå†…å­˜...">
                            <button onclick="explainConcept()" id="concept-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold">ç”Ÿæˆ</button>
                        </div>
                        <div id="concept-output" class="hidden bg-purple-50/50 dark:bg-purple-900/20 border border-purple-100 dark:border-purple-800 rounded-xl p-5 text-sm shadow-sm max-h-[600px] overflow-y-auto space-y-4"></div>
                        <div class="flex items-center justify-between mt-2 gap-2">
                            <button onclick="clearConversation('concept-output')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-red-500" id="concept-clear-btn"><i data-lucide="trash-2" class="w-3 h-3"></i> æ¸…ç©ºå¯¹è¯</button>
                            <div class="flex gap-2 ml-auto">
                                <button onclick="saveResultToNotebook('concept', 'concept-input', 'concept-output')" id="concept-save-btn" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-purple-500"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                                <button onclick="exportToPDF('concept-output', 'AIæ™ºå›Šå›¢', 'æ¦‚å¿µå¡ç‰‡')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500" id="concept-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                            </div>
                        </div>
                    </div>

                    <!-- Content: Document AI -->
                    <div id="content-doc" class="hidden space-y-4">
                        <p class="text-xs text-slate-400">ä¸Šä¼ æ‰«æè®²ä¹‰/ç¬”è®°å›¾ç‰‡ï¼ŒAI ä¸€é”®æå–æ–‡å­—å¹¶ç”Ÿæˆæ‘˜è¦ã€‚</p>
                        <div class="flex flex-col gap-3">
                            <label class="upload-box flex flex-col items-center justify-center w-full h-32 rounded-xl cursor-pointer group">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <i data-lucide="scan-text" class="w-8 h-8 text-slate-400 mb-2 group-hover:text-orange-500 transition-colors"></i>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</p>
                                </div>
                                <input type="file" class="hidden" id="doc-file" accept="image/*" onchange="handleGenericImageUpload(event, 'doc-preview', 'doc-file')">
                            </label>
                            
                            <div id="doc-preview-container" class="hidden relative rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700">
                                <img id="doc-preview" class="w-full h-48 object-contain bg-black/5 dark:bg-black/20">
                                <button onclick="clearGenericImage('doc-preview', 'doc-file')" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full hover:bg-red-600"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                            
                            <button onclick="processDoc()" id="doc-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">æå–æ–‡å­— & æ‘˜è¦</button>
                        </div>
                        <div id="doc-result" class="hidden space-y-4">
                            <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-100 dark:border-orange-800 rounded-xl p-4">
                                <h4 class="font-bold text-orange-600 dark:text-orange-300 mb-2 text-xs uppercase tracking-wider flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> æ™ºèƒ½æ‘˜è¦</h4>
                                <div id="doc-summary" class="ai-content text-sm text-slate-700 dark:text-slate-300"></div>
                            </div>
                            <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-4 relative">
                                <button onclick="copyDocText()" class="absolute top-2 right-2 text-slate-400 hover:text-indigo-500" title="å¤åˆ¶å…¨æ–‡"><i data-lucide="copy" class="w-4 h-4"></i></button>
                                <h4 class="font-bold text-slate-500 dark:text-slate-400 mb-2 text-xs uppercase tracking-wider">æå–åŸæ–‡</h4>
                                <div id="doc-text" class="text-xs font-mono text-slate-600 dark:text-slate-400 whitespace-pre-wrap max-h-60 overflow-y-auto"></div>
                            </div>
                            <div class="flex items-center justify-between">
                                <button onclick="saveResultToNotebook('doc', 'doc-preview', 'doc-summary')" class="text-xs flex items-center gap-1 text-slate-400 hover:text-orange-500"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                                <button onclick="exportDocToPDF()" class="text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500 ml-auto" id="doc-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                            </div>
                        </div>
                    </div>

                    <!-- Content: Code Templates (UPDATED) -->
                    <div id="content-code" class="hidden space-y-4">
                        <p class="text-xs text-slate-400">è¾“å…¥ç®—æ³•åç§°ï¼ŒAI ç”Ÿæˆ408æ‰‹å†™é€‚ç”¨çš„æ ‡å‡†ä»£ç æ¨¡æ¿ã€‚</p>
                        <textarea id="code-input" class="w-full h-16 bg-slate-900 text-slate-300 border border-slate-700 rounded-lg p-3 text-xs font-mono focus:outline-none focus:border-blue-500 resize-none" placeholder="ä¾‹å¦‚ï¼šQuickSort (å¿«é€Ÿæ’åº), Dijkstraç®—æ³•..."></textarea>
                        <button onclick="explainCode()" id="code-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">ç”Ÿæˆä»£ç æ¨¡æ¿</button>
                        <div id="code-output" class="hidden bg-slate-900 border border-slate-700 rounded-xl p-5 text-sm shadow-sm max-h-[600px] overflow-y-auto space-y-4"></div>
                        <div class="flex items-center justify-between mt-2 gap-2">
                            <button onclick="clearConversation('code-output')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-red-500" id="code-clear-btn"><i data-lucide="trash-2" class="w-3 h-3"></i> æ¸…ç©ºå¯¹è¯</button>
                            <div class="flex gap-2 ml-auto">
                                <button onclick="saveResultToNotebook('code', 'code-input', 'code-output')" id="code-save-btn" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-blue-500"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                                <button onclick="exportToPDF('code-output', 'AIæ™ºå›Šå›¢', 'ä»£ç æ¨¡æ¿')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500" id="code-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                            </div>
                        </div>
                    </div>

                    <!-- Content: Mock Interview (NEW) -->
                    <div id="content-interview" class="hidden space-y-4">
                        <div class="flex gap-2 mb-4">
                            <select id="interview-topic" class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm">
                                <option value="è®¡ç®—æœºç½‘ç»œ">è®¡ç®—æœºç½‘ç»œ</option>
                                <option value="æ“ä½œç³»ç»Ÿ">æ“ä½œç³»ç»Ÿ</option>
                                <option value="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</option>
                                <option value="è®¡ç®—æœºç»„æˆåŸç†">è®¡ç®—æœºç»„æˆåŸç†</option>
                            </select>
                            <button onclick="startInterview()" id="interview-start-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold">å¼€å§‹é¢è¯•</button>
                        </div>
                        <div id="interview-area" class="hidden space-y-4">
                            <div class="bg-slate-100 dark:bg-slate-800/50 p-4 rounded-xl border-l-4 border-green-500">
                                <p class="text-xs font-bold text-slate-500 mb-1">é¢è¯•å®˜ (AI)</p>
                                <div id="interview-question" class="text-sm font-medium text-slate-800 dark:text-slate-200"></div>
                            </div>
                            <textarea id="interview-answer" class="w-full h-24 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm resize-none focus:border-green-500 outline-none" placeholder="è¾“å…¥ä½ çš„å›ç­”..."></textarea>
                            <button onclick="submitInterviewAnswer()" id="interview-submit-btn" class="w-full bg-slate-800 hover:bg-slate-900 dark:bg-slate-700 dark:hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-bold">æäº¤å›ç­”</button>
                            <div id="interview-feedback" class="hidden ai-content bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-800 rounded-xl p-4 text-sm"></div>
                            <div class="flex items-center justify-between mt-2">
                                <button onclick="saveResultToNotebook('interview', 'interview-question', 'interview-feedback')" id="interview-save-btn" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-green-500"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                                <button onclick="exportInterviewToPDF()" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500 ml-auto" id="interview-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Phase Cards (Visual Only) -->
            <div class="glass-card p-6">
                <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4 text-sm"><i data-lucide="map" class="w-4 h-4 text-blue-400 inline mr-1"></i> å†²åˆºé˜¶æ®µ</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="bg-blue-50/30 dark:bg-blue-900/10 p-3 rounded-xl border border-blue-100 dark:border-slate-700">
                        <div class="text-[10px] font-bold text-blue-500 mb-1">å€’è®¡æ—¶ 30 å¤©</div>
                        <p class="text-xs text-slate-500">å›å½’çœŸé¢˜ï¼Œå…¨çœŸæ¨¡æ‹Ÿã€‚</p>
                    </div>
                    <div class="bg-yellow-50/30 dark:bg-yellow-900/10 p-3 rounded-xl border border-yellow-100 dark:border-slate-700">
                        <div class="text-[10px] font-bold text-yellow-600 mb-1">Day 11-20: ä»¿çœŸ</div>
                        <p class="text-xs text-slate-500 dark:text-slate-400">8:30åšæ•°å­¦ï¼Œ14:00åš408ã€‚ä¸¥æ ¼é™æ—¶ï¼Œå¿…é¡»æ‰‹å†™ã€‚</p>
                    </div>
                    <div class="bg-pink-50/30 dark:bg-pink-900/10 p-3 rounded-xl border border-pink-100 dark:border-slate-700">
                        <div class="text-[10px] font-bold text-pink-500 mb-1">Day 21-28: æŠ¼é¢˜</div>
                        <p class="text-xs text-slate-500 dark:text-slate-400">ç‹‚èƒŒè‚–å››åˆ†æé¢˜ã€‚è¿‡ä¸€éOS/ç½‘ç»œåè®®ç»†èŠ‚ã€‚</p>
                    </div>
                </div>
            </div>

             <!-- 4. Scores & Memo & Wellness -->
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Score Goals -->
                <div class="glass-card p-6 h-full flex flex-col justify-center">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold text-slate-700 dark:text-slate-200 text-sm flex items-center gap-2">
                            <i data-lucide="target" class="w-4 h-4 text-blue-400"></i> ç›®æ ‡ 380+
                        </h4>
                        <span class="text-lg font-black text-slate-700 dark:text-white" id="total-score">380</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center"><input type="number" id="s-pol" value="65" class="w-full text-center bg-pink-50 dark:bg-pink-900/20 rounded py-2 text-sm font-bold text-pink-500" oninput="calcTotal()"><label class="text-[10px] text-slate-400 mt-1 block">æ”¿æ²» Politics</label></div>
                        <div class="text-center"><input type="number" id="s-eng" value="75" class="w-full text-center bg-green-50 dark:bg-green-900/20 rounded py-2 text-sm font-bold text-green-500" oninput="calcTotal()"><label class="text-[10px] text-slate-400 mt-1 block">è‹±è¯­ English</label></div>
                        <div class="text-center"><input type="number" id="s-math" value="120" class="w-full text-center bg-blue-50 dark:bg-blue-900/20 rounded py-2 text-sm font-bold text-blue-500" oninput="calcTotal()"><label class="text-[10px] text-slate-400 mt-1 block">æ•°å­¦ Math</label></div>
                        <div class="text-center"><input type="number" id="s-cs" value="120" class="w-full text-center bg-purple-50 dark:bg-purple-900/20 rounded py-2 text-sm font-bold text-purple-500" oninput="calcTotal()"><label class="text-[10px] text-slate-400 mt-1 block">408 CS</label></div>
                    </div>
                </div>

                <!-- Quick Memo -->
                <div class="glass-card p-6 h-full relative group">
                    <h4 class="font-bold text-slate-700 dark:text-slate-200 text-sm mb-3 flex items-center gap-2"><i data-lucide="sticky-note" class="w-4 h-4 text-yellow-400"></i> éšå¿ƒä¾¿åˆ©è´´</h4>
                    <textarea id="quick-memo" class="w-full h-32 bg-yellow-50 dark:bg-slate-800/50 border-0 rounded-xl p-3 text-xs text-slate-600 dark:text-slate-300 resize-none focus:ring-2 focus:ring-yellow-100 dark:focus:ring-slate-600 lined-paper" placeholder="è®°ä¸‹çªç„¶æƒ³åˆ°çš„å…¬å¼ã€å¾…åŠ..."></textarea>
                    <div class="absolute bottom-6 right-6 text-[10px] text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity">Auto-saved</div>
                </div>

                <!-- Wellness Bar -->
                <div class="glass-card p-6 h-full flex flex-col justify-center">
                    <h4 class="font-bold text-slate-700 dark:text-slate-200 text-sm mb-4 flex items-center gap-2"><i data-lucide="heart" class="w-4 h-4 text-red-400"></i> æ¯æ—¥å…ƒæ°”</h4>
                    <div class="flex justify-between px-2">
                        <button onclick="toggleWellness('w-water')" id="w-water" class="wellness-btn flex flex-col items-center gap-2"><div class="w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-400"><i data-lucide="glass-water" class="w-5 h-5"></i></div><span class="text-[10px] text-slate-400">å–æ°´</span></button>
                        <button onclick="toggleWellness('w-fruit')" id="w-fruit" class="wellness-btn flex flex-col items-center gap-2"><div class="w-10 h-10 rounded-full bg-green-50 dark:bg-green-900/30 flex items-center justify-center text-green-400"><i data-lucide="apple" class="w-5 h-5"></i></div><span class="text-[10px] text-slate-400">æ°´æœ</span></button>
                        <button onclick="toggleWellness('w-eye')" id="w-eye" class="wellness-btn flex flex-col items-center gap-2"><div class="w-10 h-10 rounded-full bg-orange-50 dark:bg-orange-900/30 flex items-center justify-center text-orange-400"><i data-lucide="eye" class="w-5 h-5"></i></div><span class="text-[10px] text-slate-400">æŠ¤çœ¼</span></button>
                        <button onclick="toggleWellness('w-sleep')" id="w-sleep" class="wellness-btn flex flex-col items-center gap-2"><div class="w-10 h-10 rounded-full bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-400"><i data-lucide="moon" class="w-5 h-5"></i></div><span class="text-[10px] text-slate-400">æ—©ç¡</span></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: SCHEDULE -->
        <div id="view-schedule" class="hidden space-y-6 animate-in fade-in slide-in-from-right-4 duration-300 pb-10">
            <div class="flex justify-between items-end mb-4">
                <h2 class="text-xl font-bold text-slate-700 dark:text-slate-200">å…¨å¤©å€™æ—¶åˆ»è¡¨</h2>
                <button onclick="resetTasks()" class="text-xs px-3 py-1 bg-white dark:bg-darkcard rounded-full border border-slate-200 dark:border-slate-700 text-slate-400 hover:text-pink-500 transition">å¼€å¯æ–°çš„ä¸€å¤©</button>
            </div>
            <div class="relative pl-2 pb-6">
                <div class="timeline-item relative pl-10 pb-8"><div class="timeline-line"></div><div class="absolute left-0 top-1 checkbox-wrapper"><input type="checkbox" id="t1" onchange="saveProgress()"><label for="t1"><i data-lucide="sun" class="w-3 h-3"></i></label></div><div class="glass-card p-4 shadow-sm"><span class="text-xs font-bold text-orange-500 bg-orange-50 dark:bg-orange-900/20 px-2 py-0.5 rounded">07:00</span><h4 class="font-bold text-slate-700 dark:text-slate-200 text-sm mt-1">èµ·åºŠ & è‚–å››è¯µè¯»</h4></div></div>
                <div class="timeline-item relative pl-10 pb-8"><div class="timeline-line"></div><div class="absolute left-0 top-1 checkbox-wrapper"><input type="checkbox" id="t2" onchange="saveProgress()"><label for="t2"><i data-lucide="pen-tool" class="w-3 h-3"></i></label></div><div class="bg-blue-50 dark:bg-blue-900/20 p-5 rounded-2xl border border-blue-100 dark:border-blue-900/50"><span class="text-xs font-bold text-blue-600 dark:text-blue-300 mb-1 block">08:30 - 11:30</span><h4 class="font-bold text-slate-700 dark:text-white text-base">æ•°å­¦ / æ”¿æ²» æ¨¡è€ƒ</h4></div></div>
                <div class="timeline-item relative pl-10 pb-8"><div class="timeline-line"></div><div class="absolute left-0 top-1 checkbox-wrapper"><input type="checkbox" id="t3" onchange="saveProgress()"><label for="t3"><i data-lucide="coffee" class="w-3 h-3"></i></label></div><div class="glass-card bg-white/60 p-3"><h4 class="font-bold text-slate-600 dark:text-slate-300 text-sm mt-1">åˆé¤ & ä¼‘æ¯</h4></div></div>
                <div class="timeline-item relative pl-10 pb-8"><div class="timeline-line"></div><div class="absolute left-0 top-1 checkbox-wrapper"><input type="checkbox" id="t4" onchange="saveProgress()"><label for="t4"><i data-lucide="cpu" class="w-3 h-3"></i></label></div><div class="bg-purple-50 dark:bg-purple-900/20 p-5 rounded-2xl border border-purple-100 dark:border-purple-900/50"><span class="text-xs font-bold text-purple-600 dark:text-purple-300 mb-1 block">14:00 - 17:00</span><h4 class="font-bold text-slate-700 dark:text-white text-base">408 / è‹±è¯­ æ¨¡è€ƒ</h4></div></div>
                <div class="timeline-item relative pl-10 pb-8"><div class="timeline-line"></div><div class="absolute left-0 top-1 checkbox-wrapper"><input type="checkbox" id="t5" onchange="saveProgress()"><label for="t5"><i data-lucide="moon" class="w-3 h-3"></i></label></div><div class="glass-card p-4 shadow-sm"><span class="text-xs font-bold text-indigo-400 bg-indigo-50 dark:bg-indigo-900/20 px-2 py-0.5 rounded">19:00</span><h4 class="font-bold text-slate-700 dark:text-slate-200 text-sm mt-1">å¤ç›˜ & é”™é¢˜æ•´ç†</h4></div></div>
                <div class="timeline-item relative pl-10"><div class="absolute left-0 top-1 checkbox-wrapper"><input type="checkbox" id="t6" onchange="saveProgress()"><label for="t6"><i data-lucide="bed" class="w-3 h-3"></i></label></div><div class="bg-slate-800 p-4 rounded-2xl shadow-sm text-white"><h4 class="font-bold text-white text-sm mt-1">å…³æœºç¡è§‰ (23:00)</h4></div></div>
            </div>
            <button onclick="generateDailyReport()" id="report-btn" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-xl font-bold shadow-lg">âœ¨ ç”Ÿæˆä»Šæ—¥å¤ç›˜æˆ˜æŠ¥</button>
            <div id="report-area" class="mt-4 hidden bg-white dark:bg-darkcard p-4 rounded-xl ai-content"></div>
        </div>

        <!-- VIEW: GRADER (UPDATED TO V4.0) -->
        <div id="view-grader" class="hidden space-y-6 animate-in fade-in zoom-in duration-300">
            <div class="glass-card p-6 min-h-screen md:min-h-0">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center text-pink-500"><i data-lucide="pen-tool" class="w-4 h-4"></i></div>
                    <h2 class="text-xl font-bold text-slate-700 dark:text-slate-200">AI é˜…å·å®¤ 4.0</h2>
                </div>
                
                <!-- 4-Tab Structure -->
                <div class="flex gap-2 border-b border-slate-200 dark:border-slate-700 mb-6 overflow-x-auto no-scrollbar">
                    <button onclick="switchGraderTab('cs')" id="tab-grader-cs" class="tab-btn active pb-3 px-3 text-sm font-bold text-slate-500 whitespace-nowrap transition-colors flex items-center gap-1">ğŸ’» 408 å¤§é¢˜</button>
                    <button onclick="switchGraderTab('eng')" id="tab-grader-eng" class="tab-btn pb-3 px-3 text-sm font-bold text-slate-500 whitespace-nowrap transition-colors flex items-center gap-1">ğŸ“ è‹±è¯­ä½œæ–‡</button>
                    <button onclick="switchGraderTab('trans')" id="tab-grader-trans" class="tab-btn pb-3 px-3 text-sm font-bold text-slate-500 whitespace-nowrap transition-colors flex items-center gap-1">ğŸ”¤ ç¿»è¯‘Â·åŒå›¾</button>
                    <button onclick="switchGraderTab('pol')" id="tab-grader-pol" class="tab-btn pb-3 px-3 text-sm font-bold text-slate-500 whitespace-nowrap transition-colors flex items-center gap-1">âš–ï¸ æ”¿æ²»å¤§é¢˜</button>
                </div>

                <!-- 1. CS 408 Grader (NEW) -->
                <div id="grader-cs" class="space-y-4">
                     <div class="bg-purple-50 dark:bg-purple-900/10 p-3 rounded-lg border border-purple-100 dark:border-purple-900/50 flex items-start gap-2">
                        <i data-lucide="cpu" class="w-4 h-4 text-purple-500 mt-0.5"></i>
                        <p class="text-xs text-purple-600 dark:text-purple-300">ä¸Šä¼  408 å¤§é¢˜æ‰‹å†™ç­”æ¡ˆï¼ˆæˆ–ä»…ä¸Šä¼ é¢˜ç›®ï¼‰ï¼ŒAI å¸®ä½ æ‰¹æ”¹é€»è¾‘å¹¶ç»™å‡ºæ ‡å‡†æ­¥éª¤ã€‚</p>
                    </div>

                    <label class="upload-box flex flex-col items-center justify-center w-full h-40 rounded-xl cursor-pointer group">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i data-lucide="image-plus" class="w-8 h-8 text-slate-400 mb-2 group-hover:text-purple-500 transition-colors"></i>
                            <p class="text-xs text-slate-500 font-medium">æ‹ç…§ä¸Šä¼ é¢˜ç›®/ç­”æ¡ˆ</p>
                        </div>
                        <input type="file" class="hidden" id="cs-grader-file" accept="image/*" onchange="handleGenericImageUpload(event, 'cs-grader-preview', 'cs-grader-file')">
                    </label>

                    <div id="cs-grader-preview-container" class="hidden relative rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 shadow-sm">
                        <img id="cs-grader-preview" class="w-full h-auto max-h-64 object-contain bg-black/5">
                        <button onclick="clearGenericImage('cs-grader-preview', 'cs-grader-file')" class="absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600 shadow-md"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>

                    <button onclick="gradeCS()" id="cs-grade-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-xl font-bold transition-all shadow-md active:scale-95">å¼€å§‹ 408 æ‰¹æ”¹</button>
                    
                    <div id="cs-grade-result" class="hidden bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl p-5 text-sm shadow-sm max-h-[600px] overflow-y-auto space-y-4"></div>
                    <div class="flex items-center justify-between mt-2 gap-2">
                        <button onclick="clearConversation('cs-grade-result')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-red-500" id="cs-clear-btn"><i data-lucide="trash-2" class="w-3 h-3"></i> æ¸…ç©ºå¯¹è¯</button>
                        <div class="flex gap-2 ml-auto">
                            <button onclick="saveResultToNotebook('grader-cs', 'cs-grader-preview', 'cs-grade-result')" id="cs-save-btn" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-purple-500"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                            <button onclick="exportToPDF('cs-grade-result', 'AIé˜…å·å®¤', '408å¤§é¢˜æ‰¹æ”¹')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500" id="cs-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                        </div>
                    </div>
                </div>

                <!-- 2. English Essay Grader -->
                <div id="grader-eng" class="hidden space-y-4">
                    <div class="bg-blue-50 dark:bg-blue-900/10 p-3 rounded-lg border border-blue-100 dark:border-blue-900/50 flex items-start gap-2">
                        <i data-lucide="info" class="w-4 h-4 text-blue-500 mt-0.5"></i>
                        <p class="text-xs text-blue-600 dark:text-blue-300">AI å°†æ¨¡ä»¿é˜…å·è€å¸ˆï¼Œå…ˆçœ‹å­—è¿¹å·¥æ•´åº¦ï¼ˆå·é¢åˆ†ï¼‰ï¼Œå†çœ‹è¯­æ³•é€»è¾‘ï¼Œæœ€åç»™å‡ºâ€œç‹ å¿ƒâ€æ‰“åˆ†ã€‚</p>
                    </div>

                    <label class="upload-box flex flex-col items-center justify-center w-full h-40 rounded-xl cursor-pointer group">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i data-lucide="camera" class="w-8 h-8 text-slate-400 mb-2 group-hover:text-pink-500 transition-colors"></i>
                            <p class="text-xs text-slate-500 font-medium">æ‹ç…§ä¸Šä¼ æ‰‹å†™ä½œæ–‡</p>
                        </div>
                        <input type="file" class="hidden" id="eng-essay-file" accept="image/*" onchange="handleGenericImageUpload(event, 'eng-preview', 'eng-essay-file')">
                    </label>

                    <div id="eng-preview-container" class="hidden relative rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 shadow-sm">
                        <img id="eng-preview" class="w-full h-auto max-h-64 object-contain bg-black/5">
                        <button onclick="clearGenericImage('eng-preview', 'eng-essay-file')" class="absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600 shadow-md"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>

                    <button onclick="gradeEssay('english')" id="eng-grade-btn" class="w-full bg-pink-500 hover:bg-pink-600 text-white py-3 rounded-xl font-bold transition-all shadow-md active:scale-95">å¼€å§‹æ®‹é…·é˜…å·</button>
                    
                    <div id="eng-result" class="hidden bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl p-5 text-sm shadow-sm max-h-[600px] overflow-y-auto space-y-4"></div>
                    <div class="flex items-center justify-between mt-2 gap-2">
                        <button onclick="clearConversation('eng-result')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-red-500" id="eng-clear-btn"><i data-lucide="trash-2" class="w-3 h-3"></i> æ¸…ç©ºå¯¹è¯</button>
                        <div class="flex gap-2 ml-auto">
                            <button onclick="saveResultToNotebook('grader-eng', 'eng-preview', 'eng-result')" id="eng-save-btn" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                            <button onclick="exportToPDF('eng-result', 'AIé˜…å·å®¤', 'è‹±è¯­ä½œæ–‡æ‰¹æ”¹')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500" id="eng-grader-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                        </div>
                    </div>
                </div>

                <!-- 3. Translation Dual-Image Grader -->
                <div id="grader-trans" class="hidden space-y-6">
                    <div class="bg-indigo-50 dark:bg-indigo-900/10 p-3 rounded-lg border border-indigo-100 dark:border-indigo-900/50 flex items-start gap-2">
                        <i data-lucide="sparkles" class="w-4 h-4 text-indigo-500 mt-0.5"></i>
                        <p class="text-xs text-indigo-600 dark:text-indigo-300">ç‹¬å®¶åŒæµåˆ†æï¼šåŒæ—¶ä¸Šä¼ ã€è¯•å·åŸæ–‡ã€‘å’Œã€ä½ çš„æ‰‹å†™è¯‘æ–‡ã€‘ï¼ŒAI å·¦å³å¯¹ç…§æ‰¾æ¼è¯‘ã€‚</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Left: Source -->
                        <div class="space-y-2">
                            <p class="text-xs font-bold text-slate-500 ml-1">å›¾1ï¼šè¯•å·åŸæ–‡</p>
                            <label class="upload-box flex flex-col items-center justify-center w-full h-32 rounded-xl cursor-pointer group bg-slate-50 dark:bg-slate-800/50">
                                <div class="flex flex-col items-center justify-center">
                                    <i data-lucide="file-text" class="w-6 h-6 text-slate-400 mb-2 group-hover:text-indigo-500"></i>
                                    <p class="text-[10px] text-slate-400">ä¸Šä¼ è‹±è¯­åŸæ–‡</p>
                                </div>
                                <input type="file" class="hidden" id="trans-source-file" accept="image/*" onchange="handleGenericImageUpload(event, 'trans-source-preview', 'trans-source-file')">
                            </label>
                            <div id="trans-source-preview-container" class="hidden relative rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700">
                                <img id="trans-source-preview" class="w-full h-24 object-cover">
                                <button onclick="clearGenericImage('trans-source-preview', 'trans-source-file')" class="absolute top-1 right-1 bg-black/50 text-white p-1 rounded-full"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                        </div>

                        <!-- Right: Target -->
                        <div class="space-y-2">
                            <p class="text-xs font-bold text-slate-500 ml-1">å›¾2ï¼šä½ çš„è¯‘æ–‡</p>
                            <label class="upload-box flex flex-col items-center justify-center w-full h-32 rounded-xl cursor-pointer group bg-slate-50 dark:bg-slate-800/50">
                                <div class="flex flex-col items-center justify-center">
                                    <i data-lucide="pen-line" class="w-6 h-6 text-slate-400 mb-2 group-hover:text-pink-500"></i>
                                    <p class="text-[10px] text-slate-400">ä¸Šä¼ æ‰‹å†™è¯‘æ–‡</p>
                                </div>
                                <input type="file" class="hidden" id="trans-target-file" accept="image/*" onchange="handleGenericImageUpload(event, 'trans-target-preview', 'trans-target-file')">
                            </label>
                            <div id="trans-target-preview-container" class="hidden relative rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700">
                                <img id="trans-target-preview" class="w-full h-24 object-cover">
                                <button onclick="clearGenericImage('trans-target-preview', 'trans-target-file')" class="absolute top-1 right-1 bg-black/50 text-white p-1 rounded-full"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                    </div>

                    <button onclick="gradeTranslation()" id="trans-grade-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white py-3 rounded-xl font-bold transition-all shadow-md active:scale-95">å¼€å§‹åŒå›¾å¯¹ç…§æ‰¹æ”¹</button>
                    <div id="trans-result" class="hidden bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl p-5 text-sm shadow-sm max-h-[600px] overflow-y-auto space-y-4"></div>
                    <div class="flex items-center justify-between mt-2 gap-2">
                        <button onclick="clearConversation('trans-result')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-red-500" id="trans-clear-btn"><i data-lucide="trash-2" class="w-3 h-3"></i> æ¸…ç©ºå¯¹è¯</button>
                        <div class="flex gap-2 ml-auto">
                            <button onclick="saveResultToNotebook('grader-trans', 'trans-source-preview', 'trans-result')" id="trans-save-btn" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-indigo-500"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                            <button onclick="exportToPDF('trans-result', 'AIé˜…å·å®¤', 'ç¿»è¯‘æ‰¹æ”¹')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500" id="trans-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                        </div>
                    </div>
                </div>

                <!-- 4. Politics Template Generator (UPDATED) -->
                <div id="grader-pol" class="hidden space-y-4">
                     <div class="bg-orange-50 dark:bg-orange-900/10 p-3 rounded-lg border border-orange-100 dark:border-orange-900/50 flex items-start gap-2">
                        <i data-lucide="alert-circle" class="w-4 h-4 text-orange-500 mt-0.5"></i>
                        <p class="text-xs text-orange-600 dark:text-orange-300">è¾“å…¥å…³é”®è¯æˆ–ä¸Šä¼ é¢˜ç›®ï¼ŒAI å°†ç”Ÿæˆæ ‡å‡†çš„ã€å¯èƒŒè¯µçš„ç­”é¢˜æ¨¡æ¿ã€‚</p>
                    </div>

                    <textarea id="pol-q-input" class="w-full h-20 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm focus:outline-none focus:border-orange-400 mb-2" placeholder="è¾“å…¥é¢˜ç›®/å…³é”®è¯ï¼ˆä¾‹å¦‚ï¼šé©¬åŸ è®¤è¯†è®º ç»“åˆææ–™...ï¼‰"></textarea>

                    <label class="upload-box flex flex-col items-center justify-center w-full h-24 rounded-xl cursor-pointer group">
                        <div class="flex flex-col items-center justify-center pt-2 pb-2">
                            <i data-lucide="scroll-text" class="w-6 h-6 text-slate-400 mb-1 group-hover:text-orange-500 transition-colors"></i>
                            <p class="text-xs text-slate-500">ä¸Šä¼ é¢˜ç›®å›¾ç‰‡(å¯é€‰)</p>
                        </div>
                        <input type="file" class="hidden" id="pol-answer-file" accept="image/*" onchange="handleGenericImageUpload(event, 'pol-preview', 'pol-answer-file')">
                    </label>

                    <div id="pol-preview-container" class="hidden relative rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 shadow-sm">
                        <img id="pol-preview" class="w-full h-auto max-h-48 object-contain bg-black/5">
                        <button onclick="clearGenericImage('pol-preview', 'pol-answer-file')" class="absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600 shadow-md"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>

                    <button onclick="solvePolitics()" id="pol-grade-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-xl font-bold transition-all shadow-md active:scale-95">ç”Ÿæˆæ ‡å‡†ç­”é¢˜æ¨¡æ¿</button>
                    <div id="pol-result" class="hidden bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl p-5 text-sm shadow-sm max-h-[600px] overflow-y-auto space-y-4"></div>
                    <div class="flex items-center justify-between mt-2 gap-2">
                        <button onclick="clearConversation('pol-result')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-red-500" id="pol-clear-btn"><i data-lucide="trash-2" class="w-3 h-3"></i> æ¸…ç©ºå¯¹è¯</button>
                        <div class="flex gap-2 ml-auto">
                            <button onclick="saveResultToNotebook('grader-pol', 'pol-q-input', 'pol-result')" id="pol-save-btn" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-orange-500"><i data-lucide="bookmark-plus" class="w-3 h-3"></i> å­˜å…¥é”™é¢˜æœ¬</button>
                            <button onclick="exportToPDF('pol-result', 'AIé˜…å·å®¤', 'æ”¿æ²»å¤§é¢˜')" class="hidden text-xs flex items-center gap-1 text-slate-400 hover:text-pink-500" id="pol-export-btn"><i data-lucide="file-down" class="w-3 h-3"></i> å¯¼å‡º PDF</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: NOTEBOOK -->
        <div id="view-notebook" class="hidden space-y-6 animate-in fade-in zoom-in duration-300">
            <div class="glass-card p-6 min-h-[80vh]">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center"><i data-lucide="book-x" class="w-4 h-4"></i></div>
                        <h2 class="text-xl font-bold text-slate-700 dark:text-slate-200">æ™ºèƒ½é”™é¢˜æœ¬</h2>
                    </div>
                    <button onclick="showAddMistakeModal()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-1 shadow-sm transition-all active:scale-95">
                        <i data-lucide="plus" class="w-3 h-3"></i> è®°ä¸€é¢˜
                    </button>
                </div>

                <!-- Empty State -->
                <div id="notebook-empty" class="hidden flex-col items-center justify-center py-20 text-slate-400">
                    <i data-lucide="clipboard-list" class="w-12 h-12 mb-4 opacity-20"></i>
                    <p class="text-sm">æš‚æ— é”™é¢˜è®°å½•ï¼Œå¤ªæ£’äº†ï¼(æˆ–è€…è¿˜æ²¡å¼€å§‹è®°ï¼Ÿ)</p>
                </div>

                <!-- Mistake List -->
                <div id="mistake-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>

        <!-- VIEW: FOCUS -->
        <div id="view-focus" class="hidden h-full flex flex-col items-center justify-center animate-in fade-in zoom-in duration-500">
            <div class="relative w-full max-w-md text-center p-8">
                <div class="w-64 h-64 mx-auto bg-gradient-to-b from-blue-100 to-pink-100 dark:from-blue-900 dark:to-pink-900 rounded-full flex flex-col items-center justify-center shadow-[0_0_60px_rgba(236,72,153,0.1)] animate-breathe relative group cursor-pointer border-4 border-white dark:border-slate-700" onclick="toggleTimer()">
                    <div class="text-5xl font-cute font-black text-slate-700 dark:text-white tabular-nums z-10" id="timer-display">45:00</div>
                    <div class="text-xs text-slate-400 mt-2 z-10 font-bold tracking-widest uppercase" id="timer-status">Tap to Start</div>
                    <div class="absolute top-8 left-12 w-16 h-8 bg-white opacity-40 rounded-full transform -rotate-45 blur-sm dark:opacity-10"></div>
                </div>
                <div class="mt-12 flex flex-col items-center gap-4">
                    <div class="flex gap-3">
                        <button onclick="setTimer(45)" class="px-4 py-2 rounded-full bg-white dark:bg-darkcard shadow-sm border border-slate-100 dark:border-slate-700 text-xs font-bold text-slate-500 dark:text-slate-400 hover:text-pink-500 hover:border-pink-200 transition">45m æ·±åº¦</button>
                        <button onclick="setTimer(180)" class="px-4 py-2 rounded-full bg-white dark:bg-darkcard shadow-sm border border-slate-100 dark:border-slate-700 text-xs font-bold text-slate-500 dark:text-slate-400 hover:text-purple-500 hover:border-purple-200 transition">3h æ¨¡è€ƒ</button>
                        <button onclick="resetTimer()" class="w-10 h-10 rounded-full bg-white dark:bg-darkcard shadow-sm border border-slate-100 dark:border-slate-700 flex items-center justify-center text-slate-400 hover:text-slate-600 dark:hover:text-white"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- API KEY MODAL -->
    <div id="key-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4 animate-in fade-in duration-200">
        <div class="bg-white dark:bg-darkcard w-full max-w-md rounded-2xl p-6 shadow-2xl transform scale-100 border border-slate-200 dark:border-slate-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <i data-lucide="key" class="w-5 h-5 text-indigo-500"></i> é…ç½® API Key
                </h3>
                <button onclick="toggleKeyModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-4 leading-relaxed">
                ä¸ºäº†ä½¿ç”¨ AI åŠŸèƒ½ï¼Œä½ éœ€è¦å¡«å…¥è‡ªå·±çš„ Google Gemini API Keyã€‚<br>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-500 underline font-bold hover:text-indigo-600">ç‚¹å‡»è¿™é‡Œè·å–å…è´¹ Key</a>
            </p>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wide">API Key</label>
                    <input type="password" id="user-api-key-input" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 transition-colors" placeholder="AIzaSy...">
                </div>
                <button onclick="saveUserApiKey()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2.5 rounded-lg transition-all active:scale-95">ä¿å­˜é…ç½®</button>
                <p class="text-[10px] text-center text-slate-400">Key ä»…ä¿å­˜åœ¨ä½ çš„æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•ä¸­é—´æœåŠ¡å™¨ã€‚</p>
            </div>
        </div>
    </div>

    <!-- ADD MISTAKE MODAL -->
    <div id="mistake-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4 animate-in fade-in duration-200">
        <div class="bg-white dark:bg-darkcard w-full max-w-lg rounded-2xl p-6 shadow-2xl border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">è®°å½•é”™é¢˜</h3>
            <div class="space-y-3">
                <select id="m-subject" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm">
                    <option value="math">æ•°å­¦</option>
                    <option value="cs">408</option>
                    <option value="eng">è‹±è¯­</option>
                    <option value="pol">æ”¿æ²»</option>
                </select>
                <textarea id="m-question" class="w-full h-24 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 text-sm resize-none" placeholder="é¢˜ç›®æè¿° / çŸ¥è¯†ç‚¹ (æ”¯æŒ Markdown & Latex)..."></textarea>
                <textarea id="m-note" class="w-full h-20 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 text-sm resize-none" placeholder="AI è§£æ / æˆ‘çš„ç¬”è®°..."></textarea>
                <div class="flex gap-2 justify-end mt-4">
                    <button onclick="document.getElementById('mistake-modal').classList.add('hidden')" class="px-4 py-2 rounded-lg text-sm text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800">å–æ¶ˆ</button>
                    <button onclick="saveMistake()" class="px-4 py-2 rounded-lg text-sm bg-indigo-500 text-white hover:bg-indigo-600 font-bold">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MISTAKE DETAIL MODAL -->
    <div id="mistake-detail-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4 animate-in fade-in duration-200">
        <div class="bg-white dark:bg-darkcard w-full max-w-2xl max-h-[80vh] overflow-y-auto rounded-2xl p-6 shadow-2xl border border-slate-200 dark:border-slate-700 relative">
            <button onclick="document.getElementById('mistake-detail-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div id="md-content" class="space-y-4"></div>
            <div id="md-analysis" class="mt-6 pt-6 border-t border-slate-100 dark:border-slate-700 hidden">
                <h4 class="font-bold text-indigo-500 mb-2 flex items-center gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i> AI è¯Šæ–­åˆ†æ</h4>
                <div id="md-analysis-content" class="ai-content text-sm bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl"></div>
            </div>
        </div>
    </div>

    <script>
        const examDate = new Date();
        examDate.setMonth(11); // 12æœˆ
        examDate.setDate(20);
        examDate.setHours(0, 0, 0, 0);
        
        const duckQuotes = [
            "â€œå˜¿ï¼åˆ«æ‹…å¿ƒä½ çš„408å¤§é¢˜ï¼Œåªè¦å†™æ»¡é€»è¾‘å°±æœ‰åˆ†ï¼â€",
            "â€œæ•°å­¦åšä¸å‡ºæ¥ï¼Ÿæ²¡å…³ç³»ï¼ŒçœŸé¢˜é‡Œé‚£é“æ¶å¿ƒçš„ç§¯åˆ†é¢˜å¤§å®¶éƒ½ä¸ä¼šåšï¼â€",
            "â€œå“‡ï¼Œä½ å·²ç»åšæŒåˆ°ç°åœ¨äº†ï¼Œè¿™æœ¬èº«å°±å¾ˆäº†ä¸èµ·ï¼æ‘¸æ‘¸å¤´ ğŸ¦†â€",
            "â€œè‹±è¯­ä½œæ–‡æ¨¡æ¿èƒŒç†Ÿäº†å—ï¼Ÿè®°å¾—å­—å†™å¤§ä¸€ç‚¹å“¦ã€‚â€",
            "â€œæ”¿æ²»ä¸éœ€è¦æ™ºå•†ï¼Œåªéœ€è¦ä½ å“ªæ€•å¤šçœ‹ä¸€çœ¼è‚–å››ã€‚â€",
            "â€œæ·±å‘¼å¸â€”â€”å¸æ°”â€”â€”å‘¼æ°”â€”â€”å¤§è„‘é‡å¯æˆåŠŸï¼â€"
        ];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            lucide.createIcons();
            startCountdown();
            setGreeting();
            loadData();
            changeQuote();
            updateProgress();
            checkApiKeyStatus(); 
            renderMistakes();
            
            if(localStorage.getItem('theme') === 'dark') {
                document.documentElement.classList.add('dark');
            }
            
            const memo = document.getElementById('quick-memo');
            if(memo) {
                memo.addEventListener('input', () => {
                    localStorage.setItem('22408_v22_memo', memo.value);
                });
                memo.value = localStorage.getItem('22408_v22_memo') || '';
            }
        }

        // --- COMMON UTIL ---
        
        function renderMath(elementId) {
            const element = document.getElementById(elementId);
            if(element) {
                renderMathInElement(element, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }
        }
        // --- API & AI CORE ---
        // AUTO INJECT API KEY FROM ENVIRONMENT
        const apiKey = ""; 

        function toggleKeyModal() {
            const modal = document.getElementById('key-modal');
            modal.classList.toggle('hidden');
            if(!modal.classList.contains('hidden')) {
                document.getElementById('user-api-key-input').value = localStorage.getItem('gemini_user_key') || '';
            }
        }

        function saveUserApiKey() {
            const val = document.getElementById('user-api-key-input').value.trim();
            if(val) {
                localStorage.setItem('gemini_user_key', val);
                alert("API Key å·²ä¿å­˜ï¼ç°åœ¨å¯ä»¥ä½¿ç”¨ AI åŠŸèƒ½äº†ã€‚");
                toggleKeyModal();
                checkApiKeyStatus();
            } else {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ Key");
            }
        }

        function checkApiKeyStatus() {
            const hasKey = !!getUserKey();
            const txt = document.getElementById('key-status-text');
            if(txt) txt.innerText = hasKey ? "API Key å·²é…ç½®" : "è®¾ç½® API Key (æœªé…ç½®)";
        }

        function getUserKey() {
            if (apiKey) return apiKey; // Use Environment Key if available
            return localStorage.getItem('gemini_user_key');
        }

        async function callGemini(userQuery, persona, imageData = null) {
            const userKey = getUserKey();
            if (!userKey) {
                toggleKeyModal();
                throw new Error("Missing API Key");
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey}`;
            
            let systemPrompt = "ä½ æ˜¯è€ƒç ”å¤‡è€ƒå°çªçš„æ™ºèƒ½åŠ©æ‰‹ã€‚è¯·å§‹ç»ˆä½¿ç”¨ä¸­æ–‡ç®€ä½“å›ç­”ã€‚";
            //systemPrompt += " IMPORTANT: å¯¹äºæ•°å­¦å…¬å¼ï¼Œå¿…é¡»ä½¿ç”¨æ ‡å‡†LaTeXæ ¼å¼ã€‚è¡Œå†…å…¬å¼ä½¿ç”¨ `\\(` å’Œ `\\)` åŒ…è£¹ã€‚ç‹¬ç«‹å…¬å¼å—ä½¿ç”¨ `\\[` å’Œ `\\]` åŒ…è£¹ã€‚ç¦æ­¢ä½¿ç”¨ `$` æˆ– `$$`ã€‚";

            if(persona === "duck") {
                systemPrompt += " ä½ çš„è¯´è¯é£æ ¼è¦å¯çˆ±ã€æ²»æ„ˆã€å¹½é»˜ï¼ˆå¶å°”å¸¦ç‚¹'å˜'ï¼‰ã€‚å›å¤ç®€çŸ­ï¼ˆ150å­—å†…ï¼‰ã€‚";
            } else if (persona === "tutor") {
                systemPrompt += ` ä½ æ˜¯ä¸“ä¸šçš„è€ƒç ”è¾…å¯¼è€å¸ˆã€‚è¯·æä¾›ç»“æ„åŒ–ã€æœ‰æ¡ç†çš„å›ç­”ï¼š
                
**å›ç­”è¦æ±‚ï¼š**
1. ä½¿ç”¨æ¸…æ™°çš„æ ‡é¢˜å’Œåˆ†ç‚¹è¯´æ˜
2. å¯¹äº408è®¡ç®—æœºç§‘å­¦ï¼š
   - è¯¦ç»†è§£é‡Šç®—æ³•åŸç†å’Œæ­¥éª¤
   - æä¾›æ—¶é—´/ç©ºé—´å¤æ‚åº¦åˆ†æï¼ˆä½¿ç”¨LaTeXï¼‰
   - ç»™å‡ºæ˜“äºè®°å¿†çš„ä»£ç æ¨¡æ¿
   - æŒ‡å‡ºè€ƒè¯•é‡ç‚¹å’Œæ˜“é”™ç‚¹
3. å¯¹äºæ•°å­¦äºŒï¼š
   - åˆ—å‡ºå®Œæ•´çš„è§£é¢˜æ­¥éª¤
   - ä½¿ç”¨LaTeXæ ‡å‡†æ ¼å¼ä¹¦å†™å…¬å¼ï¼ˆè¡Œå†…ç”¨ \\( \\)ï¼Œç‹¬ç«‹ç”¨ \\[ \\]ï¼‰
   - æ€»ç»“å…³é”®å®šç†å’Œå…¬å¼
   - æä¾›å˜å¼é¢˜å‹æ€è·¯
4. é€»è¾‘ä¸¥å¯†ï¼Œå±‚æ¬¡åˆ†æ˜ï¼Œä¾¿äºç†è§£å’Œè®°å¿†`;
            } else if (persona === "grader") {
                systemPrompt += ` ä½ æ˜¯èµ„æ·±è€ƒç ”é˜…å·è€å¸ˆã€‚è¯·æŒ‰ä»¥ä¸‹ç»“æ„ä¸¥æ ¼è¯„åˆ†ï¼š
                
**è¯„åˆ†æ ‡å‡†ï¼š**
1. **é¢˜ç›®è¯†åˆ«**ï¼šå‡†ç¡®è¯´æ˜é¢˜ç›®è¦æ±‚
2. **ç­”æ¡ˆåˆ†æ**ï¼š
   - é€æ­¥æ£€æŸ¥è§£é¢˜æ€è·¯æ˜¯å¦æ­£ç¡®
   - æŒ‡å‡ºå…·ä½“çš„é”™è¯¯å’Œä¸è¶³
   - è¯„ä¼°ç­”æ¡ˆå®Œæ•´æ€§
3. **è¯„åˆ†**ï¼šç»™å‡ºå…·ä½“åˆ†æ•°å’Œæ‰£åˆ†ç‚¹
4. **æ ‡å‡†ç­”æ¡ˆ**ï¼šæä¾›å®Œæ•´è§„èŒƒçš„æ ‡å‡†è§£ç­”
5. **æ”¹è¿›å»ºè®®**ï¼šè¯´æ˜å¦‚ä½•æå‡ç­”é¢˜è´¨é‡

ä½¿ç”¨Markdownæ ¼å¼ï¼Œé‡ç‚¹å†…å®¹ç”¨**åŠ ç²—**æ ‡æ³¨ã€‚`;
            } else if (persona === "eng-tutor") {
                systemPrompt += ` ä½ æ˜¯è€ƒç ”è‹±è¯­äºŒï¼ˆEnglish IIï¼‰çš„èµ„æ·±ä¸“å®¶ã€‚è¯·æä¾›ä¸“ä¸šæŒ‡å¯¼ï¼š
                
**è‹±è¯­äºŒä¸“é¡¹è¦æ±‚ï¼š**
1. **ä½œæ–‡æ¨¡æ¿**ï¼š
   - æŒ‰å°ä½œæ–‡ï¼ˆåº”ç”¨æ–‡ï¼‰å’Œå¤§ä½œæ–‡ï¼ˆå›¾è¡¨ï¼‰åˆ†ç±»
   - æä¾›ä¸‡èƒ½å¥å¼å’Œé«˜åˆ†çŸ­è¯­
   - æ ‡æ³¨å¯æ›¿æ¢è¯æ±‡
   - ç»™å‡ºè®°å¿†æŠ€å·§
2. **é•¿éš¾å¥åˆ†æ**ï¼š
   - æ ‡æ³¨å¥å­ä¸»å¹²ï¼ˆä¸»è°“å®¾ï¼‰
   - åˆ†æä»å¥ç±»å‹å’Œä¿®é¥°å…³ç³»
   - æä¾›å‡†ç¡®çš„ä¸­æ–‡ç¿»è¯‘
   - åˆ—å‡ºé‡ç‚¹è¯æ±‡
3. ä½¿ç”¨**åŠ ç²—**æ ‡æ³¨å…³é”®ä¿¡æ¯
4. æ ¼å¼æ¸…æ™°ï¼Œä¾¿äºèƒŒè¯µ`;
            } else if (persona === "pol-tutor") {
                systemPrompt += ` ä½ æ˜¯è€ƒç ”æ”¿æ²»ä¸“å®¶ï¼Œç†Ÿæ‚‰è‚–ç§€è£ã€å¾æ¶›ç­‰ä¸»æµä½“ç³»ã€‚è¯·æä¾›æ ‡å‡†ç­”é¢˜æ¨¡æ¿ï¼š
                
**æ”¿æ²»ç­”é¢˜è¦æ±‚ï¼š**
1. **åŸç†é˜è¿°**ï¼š
   - æ˜ç¡®æŒ‡å‡ºæ¶‰åŠçš„é©¬å…‹æ€ä¸»ä¹‰åŸç†/æ¯›æ³½ä¸œæ€æƒ³/ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰ç†è®º
   - ç”¨æ ‡å‡†æœ¯è¯­è¡¨è¿°æ ¸å¿ƒè§‚ç‚¹
2. **æ ‡å‡†ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰**ï¼š
   - åˆ†ç‚¹ä½œç­”ï¼ˆåºå·æ¸…æ™°ï¼‰
   - ä½¿ç”¨è€ƒè¯•è¯„åˆ†æ ‡å‡†çš„å…³é”®è¯
   - æ ¼å¼è§„èŒƒï¼Œä¾¿äºç›´æ¥è®°å¿†
3. **å¾—åˆ†è¦ç‚¹**ï¼š
   - åˆ—å‡ºå¿…é¡»ç­”åˆ°çš„å…³é”®è¯
   - è¯´æ˜åˆ†å€¼åˆ†å¸ƒ
4. **æ‹“å±•æç¤º**ï¼šè”ç³»æ—¶æ”¿çƒ­ç‚¹æˆ–å…¶ä»–ç›¸å…³åŸç†

ä½¿ç”¨**åŠ ç²—**çªå‡ºå…³é”®æœ¯è¯­å’Œå¾—åˆ†ç‚¹ã€‚`;
            }

            const parts = [{ text: userQuery }];
            
            let images = [];
            if (Array.isArray(imageData)) {
                images = imageData;
            } else if (imageData && typeof imageData === 'object' && imageData.base64) {
                images = [imageData];
            }

            images.forEach(img => {
                if (img.base64 && img.mimeType) {
                    parts.push({ inlineData: { mimeType: img.mimeType, data: img.base64 } });
                }
            });

            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "é¸­é¸­æ²¡å¬æ¸…ï¼Œå†è¯´ä¸€éï¼Ÿ";
            } catch (e) {
                throw e;
            }
        }

        // --- NAVIGATION & TABS ---
        function showView(viewId) {
            ['dashboard', 'schedule', 'grader', 'focus', 'notebook'].forEach(v => {
                document.getElementById('view-' + v).classList.add('hidden');
                const btn = document.getElementById('nav-' + v);
                if(btn) {
                    btn.classList.remove('active');
                    if(v === viewId) btn.classList.add('active');
                }
            });
            document.getElementById('view-' + viewId).classList.remove('hidden');
        }

        function switchAiTab(tab) {
            const contents = ['vision', 'quiz', 'eng-write-small', 'eng-write-big', 'sentence', 'code', 'memory', 'concept', 'interview', 'doc'];
            contents.forEach(t => {
                const content = document.getElementById(`content-${t}`);
                const btn = document.getElementById(`tab-${t}`);
                if(t === tab) {
                    content.classList.remove('hidden');
                    btn.classList.add('active');
                } else {
                    content.classList.add('hidden');
                    btn.classList.remove('active');
                }
            });
        }

        function switchGraderTab(tab) {
            ['cs', 'eng', 'trans', 'pol'].forEach(t => {
                const el = document.getElementById(`grader-${t}`);
                const btn = document.getElementById(`tab-grader-${t}`);
                if(t === tab) { el.classList.remove('hidden'); btn.classList.add('active'); }
                else { el.classList.add('hidden'); btn.classList.remove('active'); }
            });
        }

        // --- FEATURE LOGIC ---

        /**
         * Helper function to add a conversation entry (question + answer)
         */
        /**
         * Apply cycling colors to bold text based on lowest-level headings
         */
        function applyBoldColors(container) {
            const colors = [
                '#2563eb', // Blue
                '#0891b2', // Cyan
                '#059669', // Green
                '#7c3aed', // Purple
                '#db2777', // Pink
                '#ea580c', // Orange
                '#d97706', // Amber
                '#dc2626'  // Red
            ];
            
            const aiContentDivs = container.querySelectorAll('.ai-content');
            aiContentDivs.forEach(contentDiv => {
                const allElements = Array.from(contentDiv.children);
                let currentColorIndex = 0;
                let lastHeading = null;
                
                allElements.forEach(el => {
                    const tagName = el.tagName.toLowerCase();
                    
                    // Track lowest-level heading
                    if (tagName === 'h4' || tagName === 'h3' || tagName === 'h2') {
                        lastHeading = el;
                        // Assign next color when we encounter a new heading
                        currentColorIndex = (currentColorIndex + 1) % colors.length;
                    }
                    
                    // Apply color to bold elements in this section
                    if (lastHeading) {
                        const strongElements = el.querySelectorAll('strong');
                        strongElements.forEach(strong => {
                            strong.style.color = colors[currentColorIndex];
                        });
                    }
                });
            });
        }

        function addConversationEntry(outputId, question, answer, isLoading = false) {
            const output = document.getElementById(outputId);
            const entry = document.createElement('div');
            entry.className = 'conversation-entry space-y-2 pb-4 border-b border-slate-200 dark:border-slate-700 last:border-b-0 last:pb-0';
            
            if (isLoading) {
                entry.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-blue-100 dark:bg-blue-900/40 rounded-full flex items-center justify-center text-xs">ğŸ‘¤</div>
                        <div class="flex-1 bg-white dark:bg-slate-800 rounded-lg rounded-tl-none px-3 py-2 text-sm">
                            <strong class="text-indigo-600 dark:text-indigo-400">é—®é¢˜ï¼š</strong>
                            <div>${question.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-2 loading-response">
                        <div class="flex-shrink-0 w-6 h-6 bg-indigo-100 dark:bg-indigo-900/40 rounded-full flex items-center justify-center text-xs">ğŸ¤–</div>
                        <div class="flex-1 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm">
                            <span class="animate-pulse text-indigo-500">AI æ­£åœ¨æ€è€ƒ...</span>
                        </div>
                    </div>
                `;
            } else {
                entry.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-blue-100 dark:bg-blue-900/40 rounded-full flex items-center justify-center text-xs">ğŸ‘¤</div>
                        <div class="flex-1 bg-white dark:bg-slate-800 rounded-lg rounded-tl-none px-3 py-2 text-sm">
                            <strong class="text-indigo-600 dark:text-indigo-400">é—®é¢˜ï¼š</strong>
                            <div>${question.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-indigo-100 dark:bg-indigo-900/40 rounded-full flex items-center justify-center text-xs">ğŸ¤–</div>
                        <div class="flex-1 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm ai-content prose dark:prose-invert max-w-none">
                            ${answer}
                        </div>
                    </div>
                `;
                // Apply bold colors after adding content
                setTimeout(() => applyBoldColors(entry), 0);
            }
            
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
            return entry;
        }

        /**
         * Helper function to clear conversation history
         */
        function clearConversation(outputId) {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºå¯¹è¯å†å²å—ï¼Ÿ')) return;
            const output = document.getElementById(outputId);
            output.innerHTML = '';
            output.classList.add('hidden');
            
            // Hide associated buttons
            const clearBtn = document.getElementById(outputId.replace('-output', '-clear-btn'));
            const saveBtn = document.getElementById(outputId.replace('-output', '-save-btn'));
            const exportBtn = document.getElementById(outputId.replace('-output', '-export-btn'));
            if (clearBtn) clearBtn.classList.add('hidden');
            if (saveBtn) saveBtn.classList.add('hidden');
            if (exportBtn) exportBtn.classList.add('hidden');
        }

        // 1. Vision (Photo + Text) - Multi-turn conversation support
        async function analyzeImage() {
            const text = document.getElementById('vision-text').value.trim();
            const img = document.getElementById('vision-preview');
            const output = document.getElementById('vision-output');
            const btn = document.getElementById('vision-btn');
            const saveBtn = document.getElementById('vision-save-btn');
            const exportBtn = document.getElementById('vision-export-btn');
            const clearBtn = document.getElementById('vision-clear-btn');

            if (!text && !img.dataset.base64) return alert("è¯·è¾“å…¥é—®é¢˜æè¿°æˆ–ä¸Šä¼ å›¾ç‰‡ï¼");

            // Create question text
            let questionText = text || '(æŸ¥çœ‹ä¸Šä¼ çš„å›¾ç‰‡)';
            if (img.dataset.base64) {
                questionText += ' [å«å›¾ç‰‡]';
            }

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 inline"></i> AI æ€è€ƒä¸­...';
            output.classList.remove('hidden');
            
            // Add loading entry
            const entry = addConversationEntry('vision-output', questionText, '', true);
            
            // Show buttons
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (exportBtn) exportBtn.classList.remove('hidden');
            if (clearBtn) clearBtn.classList.remove('hidden');

            const prompt = `User Question: "${text}". 
            (There may be an image associated with this question).
            Please solve this problem step-by-step. 
            If it's Math/CS, use LaTeX for formulas.
            If it's English, translate and explain.
            If it's Politics, provide the standard answer.`;

            try {
                const res = await callGemini(prompt, "tutor", img.dataset.base64 ? { base64: img.dataset.base64, mimeType: img.dataset.mimeType } : null);
                
                // Remove loading entry and add complete entry
                entry.remove();
                addConversationEntry('vision-output', questionText, marked.parse(res), false);
                renderMath('vision-output');
                
                // Clear input
                document.getElementById('vision-text').value = '';
            } catch (e) {
                entry.querySelector('.loading-response').innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center text-xs">âŒ</div>
                        <div class="flex-1 bg-red-50 dark:bg-red-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm text-red-600">
                            è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Keyã€‚
                        </div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'å¼€å§‹è§£æ';
                lucide.createIcons();
            }
        }

        // 2. English Writing - Separate Small and Big Composition
        async function generateEngComposition(type) {
            const inputId = type === 'small' ? 'eng-write-small-input' : 'eng-write-big-input';
            const btnId = type === 'small' ? 'eng-write-small-btn' : 'eng-write-big-btn';
            const outputId = type === 'small' ? 'eng-write-small-output' : 'eng-write-big-output';
            const saveBtnId = type === 'small' ? 'eng-write-small-save-btn' : 'eng-write-big-save-btn';
            const exportBtnId = type === 'small' ? 'eng-write-small-export-btn' : 'eng-write-big-export-btn';
            const clearBtnId = type === 'small' ? 'eng-write-small-clear-btn' : 'eng-write-big-clear-btn';
            
            const inputEl = document.getElementById(inputId);
            const input = inputEl.value.trim();
            const btn = document.getElementById(btnId);
            const saveBtn = document.getElementById(saveBtnId);
            const exportBtn = document.getElementById(exportBtnId);
            const clearBtn = document.getElementById(clearBtnId);

            if(!input) return alert("è¯·è¾“å…¥å…³é”®è¯æˆ–ä¸»é¢˜");

            const buttonText = type === 'small' ? "ç”Ÿæˆå°ä½œæ–‡æ¨¡æ¿ & æŠ€å·§" : "ç”Ÿæˆå¤§ä½œæ–‡æ¨¡æ¿ & æŠ€å·§";
            btn.disabled = true; btn.innerText = "æ­£åœ¨ç”Ÿæˆæ¨¡ç‰ˆ...";
            const output = document.getElementById(outputId);
            output.classList.remove('hidden');
            
            // Add loading entry
            const entry = addConversationEntry(outputId, `ä¸»é¢˜ï¼š${input}`, '', true);
            
            // Show buttons
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (exportBtn) exportBtn.classList.remove('hidden');
            if (clearBtn) clearBtn.classList.remove('hidden');

            const typeStr = type === 'small' ? "Small Composition (Letter/Notice)" : "Big Composition (Chart/Graph)";
            const prompt = `Generate a template for English II (è€ƒç ”è‹±è¯­äºŒ) ${typeStr}.
            Topic/Keywords: "${input}".
            
            Output in Markdown:
            1. **Writing Strategy**: Brief tips.
            2. **Template**: A fill-in-the-blank template suitable for recitation.
            3. **High-Frequency Phrases**: 5+ useful phrases for this topic.
            4. **Sentence Structures**: 3+ advanced sentence patterns.`;

            try {
                const res = await callGemini(prompt, "eng-tutor");
                
                // Remove loading and add complete entry
                entry.remove();
                addConversationEntry(outputId, `ä¸»é¢˜ï¼š${input}`, marked.parse(res), false);
                
                // Clear input for next question
                inputEl.value = '';
            } catch(e) { 
                entry.querySelector('.loading-response').innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center text-xs">âŒ</div>
                        <div class="flex-1 bg-red-50 dark:bg-red-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm text-red-600">
                            ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Keyã€‚
                        </div>
                    </div>
                `;
            }
            finally { 
                btn.disabled = false; 
                btn.innerText = buttonText;
                lucide.createIcons();
            }
        }

        // 3. Code Templates - Multi-turn
        async function explainCode() {
            const inputEl = document.getElementById('code-input');
            const input = inputEl.value.trim();
            const btn = document.getElementById('code-btn');
            const output = document.getElementById('code-output');
            const saveBtn = document.getElementById('code-save-btn');
            const exportBtn = document.getElementById('code-export-btn');
            const clearBtn = document.getElementById('code-clear-btn');

            if(!input) return;

            btn.disabled = true; btn.innerText = "æ­£åœ¨ç”Ÿæˆ...";
            output.classList.remove('hidden');
            
            // Add loading entry
            const entry = addConversationEntry('code-output', `ç®—æ³•ï¼š${input}`, '', true);
            
            // Show buttons
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (exportBtn) exportBtn.classList.remove('hidden');
            if (clearBtn) clearBtn.classList.remove('hidden');

            const prompt = `Generate a standard C++ code template for the algorithm/data structure: "${input}".
            Target: 408 Computer Science Exam (Handwriting style).
            
            Output:
            1. **Code Template**: Clean C++ code, easy to memorize.
            2. **Complexity**: Time & Space (use LaTeX).
            3. **Key Points**: What to be careful about when writing this on paper.`;

            try {
                const res = await callGemini(prompt, "tutor");
                
                // Remove loading and add complete entry
                entry.remove();
                addConversationEntry('code-output', `ç®—æ³•ï¼š${input}`, marked.parse(res), false);
                renderMath('code-output');
                
                // Clear input
                inputEl.value = '';
            } catch(e) { 
                entry.querySelector('.loading-response').innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center text-xs">âŒ</div>
                        <div class="flex-1 bg-red-50 dark:bg-red-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm text-red-600">
                            ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Keyã€‚
                        </div>
                    </div>
                `;
            }
            finally { 
                btn.disabled = false; 
                btn.innerText = "ç”Ÿæˆä»£ç æ¨¡æ¿";
                lucide.createIcons();
            }
        }

        // 4. Sentence Breakdown - Multi-turn
        async function breakSentence() {
            const inputEl = document.getElementById('sentence-input');
            const text = inputEl.value.trim();
            const img = document.getElementById('sentence-preview');
            const btn = document.getElementById('sentence-btn');
            const output = document.getElementById('sentence-output');
            const saveBtn = document.getElementById('sentence-save-btn');
            const exportBtn = document.getElementById('sentence-export-btn');
            const clearBtn = document.getElementById('sentence-clear-btn');

            if(!text && !img.dataset.base64) return alert("è¯·è¾“å…¥å¥å­æˆ–ä¸Šä¼ å›¾ç‰‡");

            let questionText = text || '(æŸ¥çœ‹ä¸Šä¼ çš„å¥å­å›¾ç‰‡)';
            if (img.dataset.base64) questionText += ' [å«å›¾ç‰‡]';

            btn.disabled = true; btn.innerText = "è§£æä¸­...";
            output.classList.remove('hidden');
            
            // Add loading entry
            const entry = addConversationEntry('sentence-output', questionText, '', true);
            
            // Show buttons
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (exportBtn) exportBtn.classList.remove('hidden');
            if (clearBtn) clearBtn.classList.remove('hidden');

            const prompt = `Analyze this English sentence (for English II exam).
            Text: "${text}"
            (If image is provided, OCR it first).
            
            Output:
            1. **Translation**: Chinese translation.
            2. **Structure Analysis**: Subject, Predicate, Object, Clauses.
            3. **Key Vocabulary**.`;

            try {
                const res = await callGemini(prompt, "eng-tutor", img.dataset.base64 ? {base64: img.dataset.base64, mimeType: img.dataset.mimeType} : null);
                
                // Remove loading and add complete entry
                entry.remove();
                addConversationEntry('sentence-output', questionText, marked.parse(res), false);
                
                // Clear input
                inputEl.value = '';
            } catch(e) { 
                entry.querySelector('.loading-response').innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center text-xs">âŒ</div>
                        <div class="flex-1 bg-red-50 dark:bg-red-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm text-red-600">
                            è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Keyã€‚
                        </div>
                    </div>
                `;
            }
            finally { 
                btn.disabled = false; 
                btn.innerText = "ä¸€é”®æ‹†è§£";
                lucide.createIcons();
            }
        }

        // 5. Politics Standard Template (Modified)
        async function solvePolitics() {
            const inputEl = document.getElementById('pol-q-input');
            const text = inputEl.value.trim();
            const img = document.getElementById('pol-preview');
            const btn = document.getElementById('pol-grade-btn');
            const output = document.getElementById('pol-result');
            const saveBtn = document.getElementById('pol-save-btn');
            const exportBtn = document.getElementById('pol-export-btn');
            const clearBtn = document.getElementById('pol-clear-btn');

            if(!text && !img.dataset.base64) return alert("è¯·è¾“å…¥å…³é”®è¯æˆ–ä¸Šä¼ å›¾ç‰‡");

            let questionText = text || '(æŸ¥çœ‹ä¸Šä¼ çš„é¢˜ç›®å›¾ç‰‡)';
            if (img.dataset.base64) questionText += ' [å«å›¾ç‰‡]';

            btn.disabled = true; btn.innerText = "ç”Ÿæˆä¸­...";
            output.classList.remove('hidden');
            
            // Add loading entry
            const entry = addConversationEntry('pol-result', questionText, '', true);
            
            // Show buttons
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (exportBtn) exportBtn.classList.remove('hidden');
            if (clearBtn) clearBtn.classList.remove('hidden');

            const prompt = `Based on the input (Politics Question/Keywords), provide a STANDARD ANSWER TEMPLATE suitable for memorization.
            Input: "${text}".
            
            Output:
            1. **Core Principle (åŸç†)**: The Marxist/Maoist principle involved.
            2. **Standard Answer (èƒŒè¯µç‰ˆ)**: The template answer to write on the exam sheet.
            3. **Keywords to hit**: What gives you points?`;

            try {
                const res = await callGemini(prompt, "pol-tutor", img.dataset.base64 ? {base64: img.dataset.base64, mimeType: img.dataset.mimeType} : null);
                
                // Remove loading and add complete entry
                entry.remove();
                addConversationEntry('pol-result', questionText, marked.parse(res), false);
                
                // Clear input
                inputEl.value = '';
            } catch(e) { 
                entry.querySelector('.loading-response').innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center text-xs">âŒ</div>
                        <div class="flex-1 bg-red-50 dark:bg-red-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm text-red-600">
                            ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Keyã€‚
                        </div>
                    </div>
                `;
            }
            finally { 
                btn.disabled = false; 
                btn.innerText = "ç”Ÿæˆæ ‡å‡†ç­”é¢˜æ¨¡æ¿";
                lucide.createIcons();
            }
        }

        // 6. CS 408 Grader - Multi-turn
        async function gradeCS() {
            const img = document.getElementById('cs-grader-preview');
            const btn = document.getElementById('cs-grade-btn');
            const output = document.getElementById('cs-grade-result');
            const saveBtn = document.getElementById('cs-save-btn');
            const exportBtn = document.getElementById('cs-export-btn');
            const clearBtn = document.getElementById('cs-clear-btn');

            if(!img.dataset.base64) return alert("è¯·ä¸Šä¼ å›¾ç‰‡");

            const questionText = '(æŸ¥çœ‹ä¸Šä¼ çš„408é¢˜ç›®) [å«å›¾ç‰‡]';

            btn.disabled = true; btn.innerText = "é˜…å·ä¸­...";
            output.classList.remove('hidden');
            
            // Add loading entry
            const entry = addConversationEntry('cs-grade-result', questionText, '', true);
            
            // Show buttons
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (exportBtn) exportBtn.classList.remove('hidden');
            if (clearBtn) clearBtn.classList.remove('hidden');

            const prompt = `You are a grader for the 408 Computer Science exam. 
            Analyze the image (Question + Handwritten Answer).
            1. **Identify Question**: What is being asked?
            2. **Grade Answer**: Is the logic correct? Any errors?
            3. **Standard Solution**: Provide the correct steps using LaTeX.`;

            try {
                const res = await callGemini(prompt, "grader", {base64: img.dataset.base64, mimeType: img.dataset.mimeType});
                
                // Remove loading and add complete entry
                entry.remove();
                addConversationEntry('cs-grade-result', questionText, marked.parse(res), false);
                renderMath('cs-grade-result');
            } catch(e) { 
                entry.querySelector('.loading-response').innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center text-xs">âŒ</div>
                        <div class="flex-1 bg-red-50 dark:bg-red-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm text-red-600">
                            æ‰¹æ”¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Keyã€‚
                        </div>
                    </div>
                `;
            }
            finally { 
                btn.disabled = false; 
                btn.innerText = "å¼€å§‹ 408 æ‰¹æ”¹";
                lucide.createIcons();
            }
        }

        // --- OTHER EXISTING FEATURES ---
        async function generateQuiz() {
            const subject = document.getElementById('quiz-subject').value;
            const output = document.getElementById('quiz-output');
            const btn = document.getElementById('quiz-btn');
            const saveBtn = document.getElementById('quiz-save-btn');
            const exportBtn = document.getElementById('quiz-export-btn');
            const clearBtn = document.getElementById('quiz-clear-btn');

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 inline"></i> å‡ºé¢˜ä¸­...';
            output.classList.remove('hidden');

            // Add loading entry
            const entry = addConversationEntry('quiz-output', `ç§‘ç›®ï¼š${subject}`, '', true);
            
            // Show buttons
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (exportBtn) exportBtn.classList.remove('hidden');
            if (clearBtn) clearBtn.classList.remove('hidden');

            const prompt = `Generate a ${subject} multiple choice question for exam.
            Format:
            **Question**: ...
            A... B... C... D...
            |||
            **Answer**: ...
            **Analysis**: ...`;

            try {
                const res = await callGemini(prompt, "tutor");
                const parts = res.split('|||');
                
                // Remove loading and add complete entry with question and collapsible answer
                entry.remove();
                const questionHtml = marked.parse(parts[0]);
                const answerHtml = parts[1] ? marked.parse(parts[1]) : '';
                
                const completeEntry = document.createElement('div');
                completeEntry.className = 'conversation-entry space-y-2 pb-4 border-b border-slate-200 dark:border-slate-700 last:border-b-0 last:pb-0';
                completeEntry.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-blue-100 dark:bg-blue-900/40 rounded-full flex items-center justify-center text-xs">ğŸ“</div>
                        <div class="flex-1 bg-white dark:bg-slate-800 rounded-lg rounded-tl-none px-3 py-2 text-sm">
                            <strong class="text-indigo-600 dark:text-indigo-400">ç§‘ç›®ï¼š</strong>${subject}
                        </div>
                    </div>
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-indigo-100 dark:bg-indigo-900/40 rounded-full flex items-center justify-center text-xs">â“</div>
                        <div class="flex-1 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm">
                            <div class="font-bold text-indigo-600 dark:text-indigo-400 mb-2">é¢˜ç›®ï¼š</div>
                            <div class="ai-content prose dark:prose-invert max-w-none">${questionHtml}</div>
                        </div>
                    </div>
                    ${answerHtml ? `
                    <details class="ml-8">
                        <summary class="cursor-pointer text-xs text-indigo-500 hover:underline">ğŸ‘€ æŸ¥çœ‹ç­”æ¡ˆä¸è§£æ</summary>
                        <div class="mt-2 bg-green-50 dark:bg-green-900/20 rounded-lg px-3 py-2 text-sm ai-content prose dark:prose-invert max-w-none">
                            ${answerHtml}
                        </div>
                    </details>` : ''}
                `;
                output.appendChild(completeEntry);
                output.scrollTop = output.scrollHeight;
                renderMath('quiz-output');
            } catch(e) { 
                entry.querySelector('.loading-response').innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center text-xs">âŒ</div>
                        <div class="flex-1 bg-red-50 dark:bg-red-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm text-red-600">
                            ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Keyã€‚
                        </div>
                    </div>
                `;
            }
            finally { 
                btn.disabled = false; 
                btn.innerHTML = 'å‡ºé¢˜';
                lucide.createIcons();
            }
        }

        async function generateMnemonic() {
            const inputEl = document.getElementById('memory-input');
            const input = inputEl.value.trim();
            const output = document.getElementById('memory-output');
            const btn = document.getElementById('memory-btn');
            const saveBtn = document.getElementById('memory-save-btn');
            const exportBtn = document.getElementById('memory-export-btn');
            const clearBtn = document.getElementById('memory-clear-btn');
            
            if(!input) return;
            btn.disabled = true;
            output.classList.remove('hidden');
            
            // Add loading entry
            const entry = addConversationEntry('memory-output', `çŸ¥è¯†ç‚¹ï¼š${input}`, '', true);
            
            // Show buttons
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (exportBtn) exportBtn.classList.remove('hidden');
            if (clearBtn) clearBtn.classList.remove('hidden');

            try {
                const res = await callGemini(`Create a mnemonic for: ${input}`, "tutor");
                
                // Remove loading and add complete entry
                entry.remove();
                addConversationEntry('memory-output', `çŸ¥è¯†ç‚¹ï¼š${input}`, marked.parse(res), false);
                
                // Clear input
                inputEl.value = '';
            } catch(e) { 
                entry.querySelector('.loading-response').innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center text-xs">âŒ</div>
                        <div class="flex-1 bg-red-50 dark:bg-red-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm text-red-600">
                            ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Keyã€‚
                        </div>
                    </div>
                `;
            }
            finally { 
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        async function explainConcept() {
            const inputEl = document.getElementById('concept-input');
            const input = inputEl.value.trim();
            const output = document.getElementById('concept-output');
            const btn = document.getElementById('concept-btn');
            const saveBtn = document.getElementById('concept-save-btn');
            const exportBtn = document.getElementById('concept-export-btn');
            const clearBtn = document.getElementById('concept-clear-btn');
            
            if(!input) return;
            btn.disabled = true;
            output.classList.remove('hidden');
            
            // Add loading entry
            const entry = addConversationEntry('concept-output', `æ¦‚å¿µï¼š${input}`, '', true);
            
            // Show buttons
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (exportBtn) exportBtn.classList.remove('hidden');
            if (clearBtn) clearBtn.classList.remove('hidden');

            try {
                const res = await callGemini(`Explain concept: ${input} for exam.`, "tutor");
                
                // Remove loading and add complete entry
                entry.remove();
                addConversationEntry('concept-output', `æ¦‚å¿µï¼š${input}`, marked.parse(res), false);
                renderMath('concept-output');
                
                // Clear input
                inputEl.value = '';
            } catch(e) { 
                entry.querySelector('.loading-response').innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center text-xs">âŒ</div>
                        <div class="flex-1 bg-red-50 dark:bg-red-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm text-red-600">
                            ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Keyã€‚
                        </div>
                    </div>
                `;
            }
            finally { 
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        async function processDoc() {
            const img = document.getElementById('doc-preview');
            const output = document.getElementById('doc-summary');
            const text = document.getElementById('doc-text');
            const resultArea = document.getElementById('doc-result');
            const btn = document.getElementById('doc-btn');

            if(!img.dataset.base64) return;
            btn.disabled = true;
            resultArea.classList.remove('hidden');
            output.innerHTML = 'è¯†åˆ«ä¸­...';

            try {
                const res = await callGemini("OCR and Summarize this document.", "tutor", {base64: img.dataset.base64, mimeType: img.dataset.mimeType});
                output.innerHTML = marked.parse(res);
                text.innerText = res; // Simple fallback
            } catch(e) { output.innerHTML = "å¤±è´¥"; }
            finally { btn.disabled = false; }
        }

        function copyDocText() {
            navigator.clipboard.writeText(document.getElementById('doc-text').innerText);
            alert("å·²å¤åˆ¶");
        }

        async function startInterview() {
            const topic = document.getElementById('interview-topic').value;
            const qDiv = document.getElementById('interview-question');
            const area = document.getElementById('interview-area');
            const btn = document.getElementById('interview-start-btn');

            area.classList.remove('hidden');
            btn.disabled = true;
            qDiv.innerText = "é¢è¯•å®˜æ€è€ƒä¸­...";
            
            try {
                const res = await callGemini(`Ask a tough interview question about ${topic}`, "tutor");
                qDiv.innerText = res;
            } catch(e) { qDiv.innerText = "Error"; }
            finally { btn.disabled = false; }
        }

        async function submitInterviewAnswer() {
            const q = document.getElementById('interview-question').innerText;
            const a = document.getElementById('interview-answer').value;
            const fb = document.getElementById('interview-feedback');
            const btn = document.getElementById('interview-submit-btn');
            const saveBtn = document.getElementById('interview-save-btn');

            if(!a) return;
            btn.disabled = true;
            fb.classList.remove('hidden'); fb.innerHTML = 'ç‚¹è¯„ä¸­...';
            saveBtn.classList.add('hidden');
            const exportBtn = document.getElementById('interview-export-btn');
            if (exportBtn) exportBtn.classList.add('hidden');

            try {
                const res = await callGemini(`Question: ${q}\nAnswer: ${a}\nEvaluate this.`, "tutor");
                fb.innerHTML = marked.parse(res);
                saveBtn.classList.remove('hidden');
                if (exportBtn) exportBtn.classList.remove('hidden');
            } catch(e) { fb.innerHTML = "Error"; }
            finally { btn.disabled = false; }
        }
        
        async function gradeEssay(type) {
            const img = document.getElementById('eng-preview');
            const btn = document.getElementById('eng-grade-btn');
            const out = document.getElementById('eng-result');
            const saveBtn = document.getElementById('eng-save-btn');
            const exportBtn = document.getElementById('eng-grader-export-btn');
            const clearBtn = document.getElementById('eng-clear-btn');

            if(!img.dataset.base64) return alert("è¯·ä¸Šä¼ å›¾ç‰‡");
            
            const questionText = '(æŸ¥çœ‹ä¸Šä¼ çš„è‹±è¯­ä½œæ–‡) [å«å›¾ç‰‡]';

            btn.disabled = true;
            out.classList.remove('hidden');
            
            // Add loading entry
            const entry = addConversationEntry('eng-result', questionText, '', true);
            
            // Show buttons
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (exportBtn) exportBtn.classList.remove('hidden');
            if (clearBtn) clearBtn.classList.remove('hidden');

            try {
                const res = await callGemini("Grade this English Essay. Give score /25.", "grader", {base64: img.dataset.base64, mimeType: img.dataset.mimeType});
                
                // Remove loading and add complete entry
                entry.remove();
                addConversationEntry('eng-result', questionText, marked.parse(res), false);
            } catch(e) { 
                entry.querySelector('.loading-response').innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center text-xs">âŒ</div>
                        <div class="flex-1 bg-red-50 dark:bg-red-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm text-red-600">
                            æ‰¹æ”¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Keyã€‚
                        </div>
                    </div>
                `;
            }
            finally { 
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        async function gradeTranslation() {
            const src = document.getElementById('trans-source-preview');
            const tgt = document.getElementById('trans-target-preview');
            const btn = document.getElementById('trans-grade-btn');
            const out = document.getElementById('trans-result');
            const saveBtn = document.getElementById('trans-save-btn');
            const exportBtn = document.getElementById('trans-export-btn');
            const clearBtn = document.getElementById('trans-clear-btn');

            if(!src.dataset.base64 || !tgt.dataset.base64) return alert("è¯·ä¸Šä¼ ä¸¤å¼ å›¾");

            const questionText = '(æŸ¥çœ‹ä¸Šä¼ çš„ç¿»è¯‘åŒå›¾) [åŸæ–‡+è¯‘æ–‡]';

            btn.disabled = true;
            out.classList.remove('hidden');
            
            // Add loading entry
            const entry = addConversationEntry('trans-result', questionText, '', true);
            
            // Show buttons
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (exportBtn) exportBtn.classList.remove('hidden');
            if (clearBtn) clearBtn.classList.remove('hidden');

            const imgs = [
                {base64: src.dataset.base64, mimeType: src.dataset.mimeType},
                {base64: tgt.dataset.base64, mimeType: tgt.dataset.mimeType}
            ];

            try {
                const res = await callGemini("Compare Source and Translation. Grade it.", "grader", imgs);
                
                // Remove loading and add complete entry
                entry.remove();
                addConversationEntry('trans-result', questionText, marked.parse(res), false);
            } catch(e) { 
                entry.querySelector('.loading-response').innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="flex-shrink-0 w-6 h-6 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center text-xs">âŒ</div>
                        <div class="flex-1 bg-red-50 dark:bg-red-900/20 rounded-lg rounded-tl-none px-3 py-2 text-sm text-red-600">
                            æ‰¹æ”¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Keyã€‚
                        </div>
                    </div>
                `;
            }
            finally { 
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        // --- NOTEBOOK SAVE SYSTEM ---
        let mistakes = JSON.parse(localStorage.getItem('22408_mistakes') || '[]');

        function showAddMistakeModal() {
            document.getElementById('m-question').value = '';
            document.getElementById('m-note').value = '';
            document.getElementById('mistake-modal').classList.remove('hidden');
        }

        function saveResultToNotebook(sourceId, inputElId, outputElId) {
            let question = "";
            let answer = "";
            let subject = "math"; // default

            // Extract Question
            const inputEl = document.getElementById(inputElId);
            if(inputEl) {
                if(inputEl.tagName === 'IMG') {
                    question = `[å›¾ç‰‡é”™é¢˜] (æ¥è‡ª ${sourceId})`; 
                } else if (inputEl.tagName === 'TEXTAREA' || inputEl.tagName === 'INPUT') {
                    question = inputEl.value || inputEl.innerText;
                } else {
                    question = inputEl.innerText;
                }
            }
            if(!question) question = "AI ç”Ÿæˆé¢˜ç›®";

            // Extract Answer - Preserve markdown/HTML structure
            const outputEl = document.getElementById(outputElId);
            if(outputEl) {
                // Try to get the markdown-friendly text content
                const clonedEl = outputEl.cloneNode(true);
                
                // Convert HTML back to markdown-like format for better preservation
                answer = convertHtmlToMarkdown(clonedEl);
                
                // Fallback to innerHTML if conversion fails
                if (!answer || answer.trim() === '') {
                    answer = outputEl.innerText;
                }
            }

            // Determine Subject
            if(sourceId.includes('eng') || sourceId.includes('sentence') || sourceId.includes('trans')) subject = 'eng';
            else if(sourceId.includes('pol')) subject = 'pol';
            else if(sourceId.includes('cs') || sourceId.includes('code')) subject = 'cs';

            // Open Modal with Pre-filled data
            document.getElementById('m-subject').value = subject;
            document.getElementById('m-question').value = question;
            document.getElementById('m-note').value = answer;
            document.getElementById('mistake-modal').classList.remove('hidden');
        }

        /**
         * Convert HTML content back to markdown-like format for better preservation
         */
        function convertHtmlToMarkdown(element) {
            let markdown = '';
            
            const processNode = (node) => {
                if (node.nodeType === Node.TEXT_NODE) {
                    return node.textContent;
                }
                
                if (node.nodeType === Node.ELEMENT_NODE) {
                    const tagName = node.tagName.toLowerCase();
                    const children = Array.from(node.childNodes).map(processNode).join('');
                    
                    switch(tagName) {
                        case 'h1': return `# ${children}\n\n`;
                        case 'h2': return `## ${children}\n\n`;
                        case 'h3': return `### ${children}\n\n`;
                        case 'h4': return `#### ${children}\n\n`;
                        case 'p': return `${children}\n\n`;
                        case 'strong': case 'b': return `**${children}**`;
                        case 'em': case 'i': return `*${children}*`;
                        case 'code': return `\`${children}\``;
                        case 'pre': return `\`\`\`\n${children}\n\`\`\`\n\n`;
                        case 'ul': return `${children}\n`;
                        case 'ol': return `${children}\n`;
                        case 'li': return `- ${children}\n`;
                        case 'blockquote': return `> ${children}\n\n`;
                        case 'br': return '\n';
                        case 'hr': return '---\n\n';
                        case 'a': return `[${children}](${node.href || '#'})`;
                        case 'img': return `![${node.alt || 'å›¾ç‰‡'}](${node.src || ''})`;
                        default: return children;
                    }
                }
                
                return '';
            };
            
            markdown = processNode(element);
            return markdown.trim();
        }

        function saveMistake() {
            const subj = document.getElementById('m-subject').value;
            const q = document.getElementById('m-question').value.trim();
            const n = document.getElementById('m-note').value.trim();
            
            if(!q) return alert("è‡³å°‘å†™ç‚¹é¢˜ç›®æè¿°å§ï¼");

            const newMistake = {
                id: Date.now(),
                subject: subj,
                question: q,
                note: n,
                date: new Date().toLocaleDateString(),
                analysis: null
            };

            mistakes.unshift(newMistake);
            localStorage.setItem('22408_mistakes', JSON.stringify(mistakes));
            renderMistakes();
            document.getElementById('mistake-modal').classList.add('hidden');
            alert("å·²ä¿å­˜åˆ°é”™é¢˜æœ¬ï¼");
        }

        function deleteMistake(id) {
            if(!confirm("ç¡®å®šåˆ é™¤è¿™æ¡é”™é¢˜è®°å½•å—ï¼Ÿ")) return;
            mistakes = mistakes.filter(m => m.id !== id);
            localStorage.setItem('22408_mistakes', JSON.stringify(mistakes));
            renderMistakes();
        }

        /**
         * Render mistake list with proper ai-content styling for colors
         */
        function renderMistakes() {
            const list = document.getElementById('mistake-list');
            const empty = document.getElementById('notebook-empty');
            list.innerHTML = '';

            if(mistakes.length === 0) {
                empty.classList.replace('hidden', 'flex');
            } else {
                empty.classList.replace('flex', 'hidden');
                mistakes.forEach(m => {
                    let tagClass = '';
                    let subjName = '';
                    switch(m.subject) {
                        case 'math': tagClass = 'tag-math'; subjName = 'æ•°å­¦'; break;
                        case 'cs': tagClass = 'tag-cs'; subjName = '408'; break;
                        case 'eng': tagClass = 'tag-eng'; subjName = 'è‹±è¯­'; break;
                        case 'pol': tagClass = 'tag-pol'; subjName = 'æ”¿æ²»'; break;
                    }
                    
                    const qHtml = marked.parse(m.question);

                    const div = document.createElement('div');
                    div.className = 'bg-white dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 p-4 rounded-xl mistake-card cursor-pointer relative group';
                    div.onclick = (e) => { if(!e.target.closest('button')) openMistakeDetail(m.id); };
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold px-2 py-1 rounded ${tagClass}">${subjName}</span>
                            <span class="text-[10px] text-slate-400">${m.date}</span>
                        </div>
                        <div class="ai-content text-sm mb-2 mistake-preview-content">
                            ${qHtml}
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-slate-400 truncate max-w-[70%]">${m.note ? 'æœ‰ç¬”è®°/è§£æ' : 'æ— å¤‡æ³¨'}</span>
                            <button onclick="deleteMistake(${m.id})" class="p-1 text-slate-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    `;
                    list.appendChild(div);
                });
                lucide.createIcons();
                setTimeout(() => {
                    renderMath('mistake-list');
                    applyBoldColors(list); // Apply bold text colors
                }, 0);
            }
        }

        /**
         * Open mistake detail modal with proper ai-content styling
         */
        function openMistakeDetail(id) {
            const m = mistakes.find(x => x.id === id);
            if(!m) return;

            const modal = document.getElementById('mistake-detail-modal');
            const content = document.getElementById('md-content');
            const analysisDiv = document.getElementById('md-analysis');
            const analysisContent = document.getElementById('md-analysis-content');

            const qHtml = marked.parse(m.question || '');
            const noteHtml = marked.parse(m.note || 'æ— ');

            content.innerHTML = `
                <div class="mb-4">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Question</span>
                    <div class="ai-content text-base mt-1">
                        ${qHtml}
                    </div>
                </div>
                <div>
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Note / AI Answer</span>
                    <div class="ai-content text-sm mt-1">
                        ${noteHtml}
                    </div>
                </div>
                <button onclick="analyzeMistake(${m.id})" class="mt-4 w-full bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-300 py-2 rounded-lg text-sm font-bold hover:bg-indigo-100 transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="brain-circuit" class="w-4 h-4"></i> è®© AI æ·±åº¦åˆ†ææ­¤é¢˜
                </button>
            `;
            
            setTimeout(() => {
                renderMath('md-content');
                applyBoldColors(content); // Apply bold text colors to question and note
            }, 0);

            if(m.analysis) {
                analysisDiv.classList.remove('hidden');
                analysisContent.innerHTML = `<div class="ai-content">${marked.parse(m.analysis)}</div>`;
                setTimeout(() => {
                    renderMath('md-analysis-content');
                    applyBoldColors(analysisContent); // Apply bold text colors to analysis
                }, 0);
            } else {
                analysisDiv.classList.add('hidden');
                analysisContent.innerHTML = '';
            }

            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        async function analyzeMistake(id) {
            const m = mistakes.find(x => x.id === id);
            const btn = document.querySelector('#md-content button');
            const analysisDiv = document.getElementById('md-analysis');
            const analysisContent = document.getElementById('md-analysis-content');

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> åˆ†æä¸­...';
            
            analysisDiv.classList.remove('hidden');
            analysisContent.innerHTML = '<span class="animate-pulse">AI æ­£åœ¨è¯Šæ–­...</span>';

            const prompt = `Analyze this mistake for exam.
            Question: ${m.question}
            Student Note: ${m.note}
            
            Output:
            1. Knowledge Point.
            2. Common Pitfalls.
            3. A similar short example.`;

            try {
                const res = await callGemini(prompt, "tutor");
                m.analysis = res;
                localStorage.setItem('22408_mistakes', JSON.stringify(mistakes));
                
                analysisContent.innerHTML = `<div class="ai-content">${marked.parse(res)}</div>`;
                renderMath('md-analysis-content');
                btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> åˆ†æå®Œæˆ';
            } catch(e) {
                analysisContent.innerText = "åˆ†æå¤±è´¥";
                btn.disabled = false;
                btn.innerText = "é‡è¯•";
            }
        }

        // --- DATA BACKUP ---
        function exportData() {
            const data = {
                v: '40',
                date: new Date().toISOString(),
                mistakes: JSON.parse(localStorage.getItem('22408_mistakes') || '[]'),
                mainData: JSON.parse(localStorage.getItem('22408_v23_data') || '{}'),
                memo: localStorage.getItem('22408_v22_memo') || ''
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `22408_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(confirm(`ç¡®è®¤æ¢å¤ ${data.date.slice(0,10)} çš„å¤‡ä»½å—ï¼Ÿ`)) {
                        if(data.mistakes) localStorage.setItem('22408_mistakes', JSON.stringify(data.mistakes));
                        if(data.mainData) localStorage.setItem('22408_v23_data', JSON.stringify(data.mainData));
                        if(data.memo) localStorage.setItem('22408_v22_memo', data.memo);
                        alert("æ¢å¤æˆåŠŸï¼");
                        location.reload();
                    }
                } catch(err) { alert("æ–‡ä»¶æ ¼å¼é”™è¯¯"); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function handleGenericImageUpload(event, previewId, fileInputId) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(previewId);
                img.src = e.target.result;
                document.getElementById(previewId + '-container').classList.remove('hidden');
                img.dataset.base64 = e.target.result.split(',')[1];
                img.dataset.mimeType = file.type;
            };
            reader.readAsDataURL(file);
        }

        function clearGenericImage(previewId, fileInputId) {
            const img = document.getElementById(previewId);
            img.src = '';
            delete img.dataset.base64;
            delete img.dataset.mimeType;
            document.getElementById(previewId + '-container').classList.add('hidden');
            document.getElementById(fileInputId).value = '';
        }

        // --- DUCK CHAT (PRESERVED) ---
        let aiMode = false;
        function changeQuote() {
            if (aiMode) return;
            const r = Math.floor(Math.random() * duckQuotes.length);
            const quoteEl = document.getElementById('duck-quote');
            if(quoteEl) quoteEl.innerText = duckQuotes[r];
        }
        async function getAIMoodMessage(mood) {
            if (aiMode) return;
            const duckQuote = document.getElementById('duck-quote');
            duckQuote.innerText = "é¸­é¸­æ­£åœ¨æ€è€ƒ... ğŸ’­";
            const prompts = {
                tired: "æˆ‘ç´¯äº†ï¼Œæ±‚é¼“åŠ±ã€‚",
                anxious: "æˆ‘ç„¦è™‘ï¼Œæ±‚å®‰æ…°ã€‚",
                confident: "æˆ‘çŠ¶æ€å¥½ï¼Œæ±‚å¤¸å¥–ã€‚"
            };
            try {
                const response = await callGemini(prompts[mood], "duck");
                duckQuote.innerText = response;
                speakDuck(response);
            } catch (e) { duckQuote.innerText = "é¸­é¸­æ‰çº¿äº†"; }
        }
        let sidebarCollapsed = false;
        function toggleSidebar() {
            sidebarCollapsed = !sidebarCollapsed;
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const sidebarIcon = document.getElementById('sidebar-icon');
            const toggleBtn = document.getElementById('sidebar-toggle');
            
            if (sidebarCollapsed) {
                sidebar.style.width = '0';
                sidebar.style.padding = '0';
                sidebar.style.overflow = 'hidden';
                toggleBtn.style.left = '1rem';
                sidebarIcon.setAttribute('data-lucide', 'panel-left-open');
            } else {
                sidebar.style.width = '16rem';
                sidebar.style.padding = '1.5rem';
                sidebar.style.overflow = 'visible';
                toggleBtn.style.left = 'calc(16rem + 1rem)';
                sidebarIcon.setAttribute('data-lucide', 'panel-left-close');
            }
            lucide.createIcons();
        }

        function toggleAIMode() {
            aiMode = !aiMode;
            const quoteContainer = document.getElementById('duck-quote-container');
            const chatContainer = document.getElementById('ai-chat-container');
            const toggleBtn = document.getElementById('ai-toggle-btn');
            const moodBtns = document.getElementById('mood-buttons');

            if (aiMode) {
                quoteContainer.classList.add('hidden'); chatContainer.classList.remove('hidden'); moodBtns.classList.add('hidden');
                toggleBtn.innerHTML = '<i data-lucide="x" class="w-3 h-3"></i> é€€å‡ºèŠå¤©';
                toggleBtn.classList.replace('from-indigo-500', 'from-slate-500');
                toggleBtn.classList.replace('to-purple-500', 'to-slate-500');
                lucide.createIcons();
            } else {
                quoteContainer.classList.remove('hidden'); chatContainer.classList.add('hidden'); moodBtns.classList.remove('hidden');
                toggleBtn.innerHTML = '<i data-lucide="sparkles" class="w-3 h-3"></i> é—®é—®é¸­é¸­';
                toggleBtn.classList.replace('from-slate-500', 'from-indigo-500');
                toggleBtn.classList.replace('to-slate-500', 'to-purple-500');
                lucide.createIcons();
                // Clear conversation when exiting chat mode
                const responseArea = document.getElementById('ai-response-area');
                responseArea.innerHTML = `
                    <div class="flex gap-2 items-start">
                        <div class="flex-shrink-0 w-8 h-8 bg-yellow-100 dark:bg-yellow-900/40 rounded-full flex items-center justify-center text-xl">ğŸ¦†</div>
                        <div class="flex-1 bg-slate-100 dark:bg-slate-700/50 rounded-2xl rounded-tl-none px-4 py-2 text-sm ai-content">
                            <p>æˆ‘æ˜¯ä½ çš„é¸­é¸­åŠ©æ‰‹ï¼Œå¯ä»¥é™ªä½ èŠå¤©ã€å‡ºé¢˜ã€æˆ–è€…è§£é‡Šåè¯å“¦ï¼ğŸ¦†</p>
                        </div>
                    </div>
                `;
            }
        }
        function handleEnter(e) { if (e.key === 'Enter') askDuck(); }
        function triggerQuickAction(text) { document.getElementById('ai-input').value = text; document.getElementById('ai-input').focus(); }
        async function askDuck() {
            const input = document.getElementById('ai-input');
            const responseArea = document.getElementById('ai-response-area');
            const query = input.value.trim();
            if (!query) return;
            
            // Add user message to chat
            const userMsg = document.createElement('div');
            userMsg.className = 'flex gap-2 items-start justify-end';
            userMsg.innerHTML = `
                <div class="max-w-[80%] bg-indigo-500 text-white rounded-2xl rounded-tr-none px-4 py-2 text-sm">
                    ${query.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                </div>
                <div class="flex-shrink-0 w-8 h-8 bg-indigo-100 dark:bg-indigo-900/40 rounded-full flex items-center justify-center text-sm">ğŸ‘¤</div>
            `;
            responseArea.appendChild(userMsg);
            
            // Add loading message
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'flex gap-2 items-start';
            loadingMsg.id = 'loading-msg';
            loadingMsg.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 bg-yellow-100 dark:bg-yellow-900/40 rounded-full flex items-center justify-center text-xl">ğŸ¦†</div>
                <div class="flex-1 bg-slate-100 dark:bg-slate-700/50 rounded-2xl rounded-tl-none px-4 py-2 text-sm">
                    <span class="animate-pulse">é¸­é¸­æ€è€ƒä¸­...</span>
                </div>
            `;
            responseArea.appendChild(loadingMsg);
            
            // Scroll to bottom
            responseArea.scrollTop = responseArea.scrollHeight;
            
            input.value = ''; 
            input.disabled = true;
            
            try {
                const response = await callGemini(query, "duck");
                
                // Remove loading message
                const loading = document.getElementById('loading-msg');
                if (loading) loading.remove();
                
                // Add AI response
                const aiMsg = document.createElement('div');
                aiMsg.className = 'flex gap-2 items-start';
                aiMsg.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 bg-yellow-100 dark:bg-yellow-900/40 rounded-full flex items-center justify-center text-xl">ğŸ¦†</div>
                    <div class="flex-1 bg-slate-100 dark:bg-slate-700/50 rounded-2xl rounded-tl-none px-4 py-2 text-sm ai-content">
                        ${marked.parse(response)}
                    </div>
                `;
                responseArea.appendChild(aiMsg);
                responseArea.scrollTop = responseArea.scrollHeight;
                renderMath('ai-response-area');
                speakDuck(response);
            } catch (error) { 
                const loading = document.getElementById('loading-msg');
                if (loading) {
                    loading.querySelector('div:last-child').innerHTML = '<span class="text-red-500">é¸­é¸­æ‰çº¿äº†</span>';
                }
            } 
            finally { input.disabled = false; input.focus(); }
        }
        
        async function speakDuck(text) {
             // TTS Logic (Keep as placeholder or remove if not needed)
        }
        
        // --- TIMER & REPORT ---
        let tInt, tLeft = 45*60, isRunning = false;
        function setTimer(m) { resetTimer(); tLeft = m*60; updateT(); }
        function toggleTimer() {
            if(isRunning) { clearInterval(tInt); isRunning = false; document.getElementById('timer-status').innerText = "å·²æš‚åœ"; }
            else {
                isRunning = true; document.getElementById('timer-status').innerText = "ä¸“æ³¨ä¸­...";
                tInt = setInterval(() => { tLeft--; updateT(); if(tLeft<=0) { clearInterval(tInt); alert("å®Œæˆï¼"); resetTimer(); } }, 1000);
            }
        }
        function resetTimer() { clearInterval(tInt); isRunning = false; tLeft = 45*60; updateT(); document.getElementById('timer-status').innerText = "ç‚¹å‡»å¼€å§‹"; }
        function updateT() {
            const m = Math.floor(tLeft/60).toString().padStart(2,'0');
            const s = (tLeft%60).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
        }
        function startCountdown() {
            setInterval(() => {
                const now = new Date().getTime(); const dist = examDate - now; if (dist < 0) return;
                const d = Math.floor(dist / (1000 * 60 * 60 * 24));
                const h = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((dist % (1000 * 60)) / 1000);
                document.getElementById('main-countdown-days').innerHTML = `${d} <span class="text-sm text-slate-400 font-sans font-normal">Days</span>`;
                document.getElementById('main-countdown-time').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }, 1000);
        }
        // --- GREETING ---
        function setGreeting() {
            const h = new Date().getHours();
            let t = "æ™šä¸Šå¥½ ğŸŒ™";
            let s = "ä»Šå¤©ä¹Ÿæ˜¯å……å®çš„ä¸€å¤©ã€‚";
            if(h<12) { t="æ—©ä¸Šå¥½ â˜€ï¸"; s="æ–°çš„å¼€å§‹ï¼Œå…ƒæ°”æ»¡æ»¡ï¼"; }
            else if(h<18) { t="ä¸‹åˆå¥½ â˜•ï¸"; s="åšæŒå°±æ˜¯èƒœåˆ©ã€‚"; }
            
            const titleEl = document.getElementById('greeting-title');
            const subEl = document.getElementById('greeting-sub');
            if(titleEl) titleEl.innerText = t;
            if(subEl) subEl.innerText = s;
        }
        function calcTotal() {
            if (!document.getElementById('total-score')) return;
            let t = 0; ['pol','eng','math','cs'].forEach(k => { const el = document.getElementById(`s-${k}`); if (el) t += parseInt(el.value)||0; });
            document.getElementById('total-score').innerText = t; saveData();
        }
        function saveProgress() { saveData(); updateProgress(); }
        function updateProgress() {
            let checked = 0; ['t1','t2','t3','t4','t5','t6'].forEach(id => { if(document.getElementById(id).checked) checked++; });
            document.getElementById('done-count').innerText = checked;
            const pct = Math.round((checked / 6) * 100);
            const c = 2 * Math.PI * 28; const offset = c - (pct / 100) * c;
            document.getElementById('progress-ring').style.strokeDashoffset = offset;
            document.getElementById('progress-text').innerText = pct + '%';
        }
        function toggleWellness(id) { document.getElementById(id).classList.toggle('done'); saveData(); }
        function saveData() {
            const data = { scores: {}, tasks: {}, wellness: {} };
            ['pol','eng','math','cs'].forEach(k => { const el = document.getElementById(`s-${k}`); if (el) data.scores[k] = el.value; });
            ['t1','t2','t3','t4','t5','t6'].forEach(k => { const el = document.getElementById(k); if (el) data.tasks[k] = el.checked; });
            ['w-water','w-fruit','w-eye','w-sleep'].forEach(k => { const el = document.getElementById(k); if (el) data.wellness[k] = el.classList.contains('done'); });
            localStorage.setItem('22408_v23_data', JSON.stringify(data));
        }
        function loadData() {
            const d = JSON.parse(localStorage.getItem('22408_v23_data') || '{}');
            if(d.scores) ['pol','eng','math','cs'].forEach(k => { if(d.scores[k]) document.getElementById(`s-${k}`).value = d.scores[k]; });
            if(d.tasks) for(let k in d.tasks) { if(document.getElementById(k)) document.getElementById(k).checked = d.tasks[k]; }
            if(d.wellness) for(let k in d.wellness) { if(d.wellness[k] && document.getElementById(k)) document.getElementById(k).classList.add('done'); }
            calcTotal(); updateProgress();
        }
        function resetTasks() {
            if(confirm("å¼€å¯æ–°çš„ä¸€å¤©ï¼Ÿ")) {
                ['t1','t2','t3','t4','t5','t6'].forEach(k => { if(document.getElementById(k)) document.getElementById(k).checked = false; });
                ['w-water','w-fruit','w-eye','w-sleep'].forEach(k => { if(document.getElementById(k)) document.getElementById(k).classList.remove('done'); });
            }
        }
        function toggleDarkMode() {
            if(document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); document.getElementById('theme-text').innerText = 'åˆ‡æ¢å¤œé—´æ¨¡å¼';
            } else {
                document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); document.getElementById('theme-text').innerText = 'åˆ‡æ¢æ—¥é—´æ¨¡å¼';
            }
        }
        async function generateDailyReport() {
            const btn = document.getElementById('report-btn');
            const area = document.getElementById('report-area');
            const done = ['t1','t2','t3','t4','t5','t6'].filter(id => document.getElementById(id).checked).join(',');
            btn.innerHTML = 'ç”Ÿæˆä¸­...'; area.classList.remove('hidden');
            try {
                const res = await callGemini(`Daily Report. Tasks Done IDs: ${done}`, "coach");
                area.innerHTML = marked.parse(res); btn.innerText = 'åˆ·æ–°æˆ˜æŠ¥';
            } catch(e) { area.innerText = 'Error'; }
        }

        /**
         * Export Quiz content (question + answer) to PDF
         */
        /**
         * Export Quiz content to PDF (now uses multi-turn conversation structure)
         * Simply delegates to the generic exportToPDF function
         */
        async function exportQuizToPDF() {
            return exportToPDF('quiz-output', 'AIæ™ºå›Šå›¢', 'æ¯æ—¥ä¸€ç»ƒ');
        }

        /**
         * Export Interview content (question + answer + feedback) to PDF
         */
        async function exportInterviewToPDF() {
            const questionEl = document.getElementById('interview-question');
            const answerEl = document.getElementById('interview-answer');
            const feedbackEl = document.getElementById('interview-feedback');
            
            if (!feedbackEl || feedbackEl.classList.contains('hidden')) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹ï¼Œè¯·å…ˆå®Œæˆé¢è¯•å¹¶è·å¾—åé¦ˆã€‚');
                return;
            }

            const wrapper = document.createElement('div');
            wrapper.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h2 style="color: #10B981; font-size: 18px; margin-bottom: 10px;">â“ é¢è¯•é—®é¢˜</h2>
                    <p style="font-size: 14px; line-height: 1.6;">${questionEl.innerText}</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <h2 style="color: #6366F1; font-size: 18px; margin-bottom: 10px;">ğŸ’¬ æˆ‘çš„å›ç­”</h2>
                    <p style="font-size: 14px; line-height: 1.6;">${answerEl.value}</p>
                </div>
                <div>
                    <h2 style="color: #F59E0B; font-size: 18px; margin-bottom: 10px;">ğŸ“Š AI ç‚¹è¯„</h2>
                    ${feedbackEl.innerHTML}
                </div>
            `;
            
            const now = new Date();
            const timestamp = now.toISOString().replace(/:/g, '-').replace(/\..+/, '').replace('T', '_');
            const filename = `AIæ™ºå›Šå›¢_æ¨¡æ‹Ÿé¢è¯•_${timestamp}.pdf`;
            
            const opt = {
                margin: 10,
                filename: filename,
                image: { type: 'jpeg', quality: 0.95 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            try {
                const loadingToast = document.createElement('div');
                loadingToast.id = 'pdf-loading-toast';
                loadingToast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4F46E5; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                loadingToast.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 inline mr-2"></i> æ­£åœ¨ç”Ÿæˆ PDF...';
                document.body.appendChild(loadingToast);
                lucide.createIcons();

                await html2pdf().set(opt).from(wrapper).save();

                loadingToast.remove();
                const successToast = document.createElement('div');
                successToast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10B981; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                successToast.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 inline mr-2"></i> PDF å¯¼å‡ºæˆåŠŸï¼';
                document.body.appendChild(successToast);
                lucide.createIcons();
                setTimeout(() => successToast.remove(), 3000);
            } catch (error) {
                console.error('PDF generation failed:', error);
                const loadingToast = document.getElementById('pdf-loading-toast');
                if (loadingToast) loadingToast.remove();
                alert('PDF ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
            }
        }

        /**
         * Export Document AI content (summary + extracted text) to PDF
         */
        async function exportDocToPDF() {
            const summaryEl = document.getElementById('doc-summary');
            const textEl = document.getElementById('doc-text');
            const resultArea = document.getElementById('doc-result');
            
            if (!resultArea || resultArea.classList.contains('hidden')) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹ï¼Œè¯·å…ˆæå–æ–‡æ¡£ã€‚');
                return;
            }

            const wrapper = document.createElement('div');
            wrapper.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h2 style="color: #F97316; font-size: 18px; margin-bottom: 10px;">âœ¨ æ™ºèƒ½æ‘˜è¦</h2>
                    ${summaryEl.innerHTML}
                </div>
                <div>
                    <h2 style="color: #64748B; font-size: 18px; margin-bottom: 10px;">ğŸ“„ æå–åŸæ–‡</h2>
                    <pre style="font-size: 12px; line-height: 1.5; white-space: pre-wrap; font-family: monospace;">${textEl.innerText}</pre>
                </div>
            `;
            
            const now = new Date();
            const timestamp = now.toISOString().replace(/:/g, '-').replace(/\..+/, '').replace('T', '_');
            const filename = `AIæ™ºå›Šå›¢_æ–‡æ¡£æå–_${timestamp}.pdf`;
            
            const opt = {
                margin: 10,
                filename: filename,
                image: { type: 'jpeg', quality: 0.95 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            try {
                const loadingToast = document.createElement('div');
                loadingToast.id = 'pdf-loading-toast';
                loadingToast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4F46E5; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                loadingToast.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 inline mr-2"></i> æ­£åœ¨ç”Ÿæˆ PDF...';
                document.body.appendChild(loadingToast);
                lucide.createIcons();

                await html2pdf().set(opt).from(wrapper).save();

                loadingToast.remove();
                const successToast = document.createElement('div');
                successToast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10B981; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                successToast.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 inline mr-2"></i> PDF å¯¼å‡ºæˆåŠŸï¼';
                document.body.appendChild(successToast);
                lucide.createIcons();
                setTimeout(() => successToast.remove(), 3000);
            } catch (error) {
                console.error('PDF generation failed:', error);
                const loadingToast = document.getElementById('pdf-loading-toast');
                if (loadingToast) loadingToast.remove();
                alert('PDF ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
            }
        }

        /**
         * Export conversation content to PDF
         * @param {string} contentElementId - ID of the element containing the conversation content
         * @param {string} titlePrefix - Title prefix for the PDF (e.g., "AI Think Tank", "AI Grading")
         * @param {string} sectionName - Name of the section (e.g., "Vision", "Quiz", "CS Grader")
         * @returns {Promise<void>}
         */
        async function exportToPDF(contentElementId, titlePrefix, sectionName) {
            const contentElement = document.getElementById(contentElementId);
            
            if (!contentElement || contentElement.classList.contains('hidden')) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹ï¼Œè¯·å…ˆç”Ÿæˆå¯¹è¯å†…å®¹ã€‚');
                return;
            }

            // Generate filename with timestamp
            const now = new Date();
            const timestamp = now.toISOString()
                .replace(/:/g, '-')
                .replace(/\..+/, '')
                .replace('T', '_');
            const filename = `${titlePrefix}_${sectionName}_${timestamp}.pdf`;

            // Create a wrapper for the PDF content with better styling
            const pdfWrapper = document.createElement('div');
            pdfWrapper.style.padding = '20px';
            pdfWrapper.style.fontFamily = 'Arial, sans-serif';
            pdfWrapper.style.color = '#000';
            pdfWrapper.style.backgroundColor = '#fff';
            
            // Add header with title and timestamp
            const header = document.createElement('div');
            header.style.marginBottom = '20px';
            header.style.borderBottom = '2px solid #333';
            header.style.paddingBottom = '10px';
            header.innerHTML = `
                <h1 style="margin: 0; font-size: 24px; color: #333;">${titlePrefix} - ${sectionName}</h1>
                <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">å¯¼å‡ºæ—¶é—´: ${now.toLocaleString('zh-CN')}</p>
            `;
            pdfWrapper.appendChild(header);

            // Clone the content to avoid modifying the original
            const contentClone = contentElement.cloneNode(true);
            contentClone.style.fontSize = '14px';
            contentClone.style.lineHeight = '1.6';
            contentClone.style.color = '#000';
            
            // Ensure all content is visible in the clone - remove height restrictions
            contentClone.classList.remove('hidden');
            contentClone.style.maxHeight = 'none';
            contentClone.style.overflow = 'visible';
            contentClone.style.height = 'auto';
            
            // CRITICAL: Apply bold colors to the cloned content before PDF generation
            // This ensures the cloned content has the same color styling as the original
            applyBoldColors(contentClone);
            
            // Style all conversation entries for PDF
            const conversationEntries = contentClone.querySelectorAll('.conversation-entry');
            conversationEntries.forEach((entry, index) => {
                entry.style.pageBreakInside = 'avoid';
                entry.style.marginBottom = '20px';
                entry.style.padding = '15px';
                entry.style.backgroundColor = index % 2 === 0 ? '#f8fafc' : '#ffffff';
                entry.style.border = '1px solid #e2e8f0';
                entry.style.borderRadius = '8px';
                
                // Remove border-bottom class styling
                entry.style.borderBottom = 'none';
            });
            
            // Handle avatars and chat bubbles
            const userBubbles = contentClone.querySelectorAll('.flex-shrink-0');
            userBubbles.forEach(avatar => {
                avatar.style.display = 'inline-block';
                avatar.style.verticalAlign = 'top';
            });
            
            // Handle images in the content
            const images = contentClone.querySelectorAll('img');
            images.forEach(img => {
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.display = 'block';
                img.style.margin = '10px 0';
            });
            
            // Bold text colors are now set by applyBoldColors, just ensure they're locked in
            const strongElements = contentClone.querySelectorAll('strong');
            strongElements.forEach(strong => {
                // Colors are already applied by applyBoldColors above
                strong.style.fontWeight = 'bold';
            });
            
            // Style headings for PDF - lock in their specific colors
            const h1Elements = contentClone.querySelectorAll('h1');
            h1Elements.forEach(h1 => {
                h1.style.color = '#1e40af';
                h1.style.fontWeight = 'bold';
                h1.style.marginTop = '15px';
                h1.style.marginBottom = '10px';
            });
            
            const h2Elements = contentClone.querySelectorAll('h2');
            h2Elements.forEach(h2 => {
                h2.style.color = '#0891b2';
                h2.style.fontWeight = 'bold';
                h2.style.marginTop = '15px';
                h2.style.marginBottom = '10px';
            });
            
            const h3Elements = contentClone.querySelectorAll('h3');
            h3Elements.forEach(h3 => {
                h3.style.color = '#059669';
                h3.style.fontWeight = 'bold';
                h3.style.marginTop = '15px';
                h3.style.marginBottom = '10px';
            });
            
            const h4Elements = contentClone.querySelectorAll('h4');
            h4Elements.forEach(h4 => {
                h4.style.color = '#7c3aed';
                h4.style.fontWeight = 'bold';
                h4.style.marginTop = '15px';
                h4.style.marginBottom = '10px';
            });
            
            pdfWrapper.appendChild(contentClone);

            // Configure PDF options - Single page, wider format (1.8x A4 width)
            const a4Width = 210; // mm
            const customWidth = a4Width * 1.8; // 378mm
            const opt = {
                margin: 10,
                filename: filename,
                image: { type: 'jpeg', quality: 0.95 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: [customWidth, 2000], // Very tall page to fit all content without pagination
                    orientation: 'portrait',
                    compress: true
                },
                pagebreak: { mode: 'avoid-all' } // Avoid page breaks
            };

            try {
                // Show loading indicator
                const loadingToast = document.createElement('div');
                loadingToast.id = 'pdf-loading-toast';
                loadingToast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4F46E5; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                loadingToast.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 inline mr-2"></i> æ­£åœ¨ç”Ÿæˆ PDF...';
                document.body.appendChild(loadingToast);
                lucide.createIcons();

                // Generate PDF
                await html2pdf().set(opt).from(pdfWrapper).save();

                // Remove loading indicator and show success
                loadingToast.remove();
                const successToast = document.createElement('div');
                successToast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10B981; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                successToast.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 inline mr-2"></i> PDF å¯¼å‡ºæˆåŠŸï¼';
                document.body.appendChild(successToast);
                lucide.createIcons();
                setTimeout(() => successToast.remove(), 3000);
            } catch (error) {
                console.error('PDF generation failed:', error);
                const loadingToast = document.getElementById('pdf-loading-toast');
                if (loadingToast) loadingToast.remove();
                alert('PDF ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
            }
        }
    </script>
</body>
</html>

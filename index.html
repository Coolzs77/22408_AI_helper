<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â˜ï¸ 22408 å¤‡è€ƒå°çª v35 (å…¨èƒ½æ™ºå›Šç‰ˆ)</title>
    <!-- Fixed Links: Removed markdown formatting from src/href attributes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Marked for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- KaTeX for Math -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- Mermaid for Mindmaps -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        cream: '#fdfbf7',
                        sidebar: '#fffefc',
                        darkbg: '#0f172a',
                        darkcard: '#1e293b',
                        darksidebar: '#020617',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                        cute: ['"Comic Sans MS"', '"Chalkboard SE"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace']
                    },
                    animation: {
                        'float': 'float 4s ease-in-out infinite',
                        'breathe': 'breathe 4s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-6px)' },
                        },
                        breathe: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' },
                        }
                    },
                    typography: (theme) => ({
                        DEFAULT: {
                            css: {
                                color: theme('colors.slate.600'),
                                strong: { color: theme('colors.pink.500') },
                                'ul > li::marker': { color: theme('colors.slate.400') },
                            },
                        },
                        dark: {
                            css: {
                                color: theme('colors.slate.300'),
                                strong: { color: theme('colors.pink.400') },
                            }
                        }
                    }),
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&family=Fredoka:wght@400;600&family=JetBrains+Mono:wght@500&display=swap');
        
        body { font-family: 'Noto Sans SC', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .font-cute { font-family: 'Fredoka', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Sidebar Active State */
        .nav-item.active {
            background-color: #fce7f3; 
            color: #db2777; 
            font-weight: 700;
            box-shadow: 0 2px 10px rgba(244, 114, 182, 0.1);
        }
        .dark .nav-item.active {
            background-color: #831843; 
            color: #fbcfe8; 
            box-shadow: none;
        }
        
        /* Timeline & Checkbox */
        .timeline-line {
            position: absolute; left: 24px; top: 35px; bottom: -20px; width: 2px; background-color: #e2e8f0; z-index: 0;
        }
        .dark .timeline-line { background-color: #334155; }
        .timeline-item:last-child .timeline-line { display: none; }

        .checkbox-wrapper input { display: none; }
        .checkbox-wrapper label {
            cursor: pointer; width: 20px; height: 20px; border-radius: 50%;
            border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; background: white; position: relative; z-index: 10;
        }
        .dark .checkbox-wrapper label { background: #1e293b; border-color: #475569; }
        
        .checkbox-wrapper input:checked + label {
            background-color: #f472b6; border-color: #f472b6; color: white;
        }

        /* Glass Card */
        .glass-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(148, 163, 184, 0.05);
            border: 1px solid #f1f5f9;
            transition: transform 0.2s, background-color 0.3s, border-color 0.3s;
        }
        .dark .glass-card {
            background: #1e293b; 
            border-color: #334155;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .glass-card:hover { transform: translateY(-2px); }
        
        /* AI Response Typography - Clean & Readable */
        .ai-content { font-size: 0.95rem; line-height: 1.7; color: #334155; }
        .dark .ai-content { color: #e2e8f0; }
        
        .ai-content h1, .ai-content h2, .ai-content h3 { 
            margin-top: 1.2em; margin-bottom: 0.6em; font-weight: 800; color: #1e293b; letter-spacing: -0.02em;
        }
        .dark .ai-content h1, .dark .ai-content h2, .dark .ai-content h3 { color: #f1f5f9; }
        
        .ai-content p { margin-bottom: 1em; }
        
        .ai-content ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .ai-content ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .ai-content li { margin-bottom: 0.4em; }
        
        .ai-content strong { color: #db2777; font-weight: 700; }
        .dark .ai-content strong { color: #f472b6; }
        
        .ai-content blockquote { 
            border-left: 4px solid #cbd5e1; padding-left: 1em; 
            color: #64748b; font-style: italic; margin-bottom: 1em; background: #f8fafc; padding: 0.5em 1em; border-radius: 0 8px 8px 0;
        }
        .dark .ai-content blockquote { 
            border-color: #475569; color: #94a3b8; background: #1e293b; 
        }

        .ai-content code { 
            background-color: #f1f5f9; color: #ec4899; padding: 0.1em 0.3em; 
            border-radius: 0.2em; font-family: 'JetBrains Mono', monospace; font-size: 0.9em;
        }
        .dark .ai-content code { background-color: #334155; color: #fbcfe8; }
        
        .katex-display { overflow-x: auto; overflow-y: hidden; padding: 0.5em 0; }
        
        /* Tabs */
        .tab-btn.active {
            background-color: #eff6ff; color: #3b82f6; border-bottom: 2px solid #3b82f6;
        }
        .dark .tab-btn.active {
            background-color: #1e293b; color: #60a5fa; border-bottom: 2px solid #60a5fa;
        }

        /* Upload Box Style */
        .upload-box {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='10%2c 10' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s;
        }
        .dark .upload-box {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23475569FF' stroke-width='2' stroke-dasharray='10%2c 10' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .upload-box:hover {
            background-color: #f8fafc;
        }
        .dark .upload-box:hover {
            background-color: #1e293b;
        }
        
        /* Modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        /* Mistake Note Styles */
        .mistake-card {
            transition: all 0.2s;
        }
        .mistake-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .tag-math { @apply bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300; }
        .tag-cs { @apply bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-300; }
        .tag-eng { @apply bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-300; }
        .tag-pol { @apply bg-pink-100 text-pink-600 dark:bg-pink-900/30 dark:text-pink-300; }
        
        /* Mermaid Center - FIXED */
        .mermaid {
            display: flex;
            justify-content: center;
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 0.75rem;
            overflow-x: auto;
        }
        .dark .mermaid { background: #1e293b; }
        /* Ensure SVG text is visible in dark mode */
        .dark .mermaid text { fill: #e2e8f0 !important; }
        .dark .mermaid .node rect, .dark .mermaid .node circle, .dark .mermaid .node polygon { 
            fill: #334155 !important; stroke: #94a3b8 !important; 
        }
        .dark .mermaid .edgePath .path { stroke: #64748b !important; }
    </style>
</head>
<body class="flex h-screen overflow-hidden selection:bg-pink-100 bg-[#fdfbf7] dark:bg-darkbg text-slate-600 dark:text-slate-300">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-sidebar dark:bg-darksidebar border-r border-slate-100 dark:border-slate-800 hidden md:flex flex-col p-6 z-50 transition-colors duration-300">
        <div class="flex items-center gap-3 mb-10 px-2">
            <div class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900/50 rounded-full flex items-center justify-center text-xl shadow-sm">ğŸ¦†</div>
            <div>
                <h1 class="font-black text-slate-700 dark:text-slate-200 tracking-tight text-lg">22408 å°çª</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Target: 380+</p>
            </div>
        </div>
        
        <nav class="space-y-2 flex-1">
            <button onclick="showView('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i data-lucide="home" class="w-5 h-5"></i> å°çªé¦–é¡µ
            </button>
            <button onclick="showView('schedule')" id="nav-schedule" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i data-lucide="calendar-heart" class="w-5 h-5"></i> å…¨å¤©è®¡åˆ’
            </button>
            <button onclick="showView('grader')" id="nav-grader" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i data-lucide="file-check" class="w-5 h-5"></i> AI é˜…å·å®¤
            </button>
            <button onclick="showView('notebook')" id="nav-notebook" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i data-lucide="book-x" class="w-5 h-5"></i> æ™ºèƒ½é”™é¢˜æœ¬
            </button>
            <button onclick="showView('focus')" id="nav-focus" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i data-lucide="hourglass" class="w-5 h-5"></i> ä¸“æ³¨æ°”æ³¡
            </button>
        </nav>

        <div class="space-y-3 mt-auto">
             <!-- API Key Settings Button -->
             <button onclick="toggleKeyModal()" class="w-full flex items-center justify-center gap-2 py-2 rounded-2xl border border-indigo-100 dark:border-indigo-900 bg-indigo-50 dark:bg-indigo-900/20 text-xs font-bold text-indigo-500 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition-colors">
                <i data-lucide="key" class="w-4 h-4"></i>
                <span id="key-status-text">è®¾ç½® API Key</span>
            </button>

            <!-- Data Backup Button -->
            <div class="flex gap-2">
                <button onclick="exportData()" class="flex-1 flex items-center justify-center gap-1 py-2 rounded-2xl border border-slate-200 dark:border-slate-700 text-xs font-bold text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" title="å¯¼å‡ºæ•°æ®">
                    <i data-lucide="download" class="w-4 h-4"></i> å¤‡ä»½
                </button>
                <button onclick="document.getElementById('import-file').click()" class="flex-1 flex items-center justify-center gap-1 py-2 rounded-2xl border border-slate-200 dark:border-slate-700 text-xs font-bold text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" title="å¯¼å…¥æ•°æ®">
                    <i data-lucide="upload" class="w-4 h-4"></i> æ¢å¤
                </button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
            </div>

            <button onclick="toggleDarkMode()" class="w-full flex items-center justify-center gap-2 py-2 rounded-2xl border border-slate-200 dark:border-slate-700 text-xs font-bold text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <i data-lucide="moon" class="w-4 h-4 dark:hidden"></i>
                <i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i>
                <span id="theme-text">åˆ‡æ¢å¤œé—´æ¨¡å¼</span>
            </button>
        </div>
    </aside>

    <!-- MOBILE NAV -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-darksidebar/90 backdrop-blur-md border-t border-slate-100 dark:border-slate-800 z-50 flex justify-around p-3 pb-6">
        <button onclick="showView('dashboard')" class="text-pink-500"><i data-lucide="home"></i></button>
        <button onclick="showView('notebook')" class="text-slate-400"><i data-lucide="book-x"></i></button>
        <button onclick="showView('grader')" class="text-slate-400"><i data-lucide="file-check"></i></button>
        <button onclick="toggleKeyModal()" class="text-indigo-500"><i data-lucide="key"></i></button>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="flex-1 h-full overflow-y-auto p-4 md:p-10 relative scroll-smooth">
        <div class="absolute top-0 left-0 right-0 h-1.5 bg-gradient-to-r from-blue-200 via-pink-200 to-yellow-200 dark:opacity-50"></div>

        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
            <div>
                <h2 class="text-2xl md:text-3xl font-black text-slate-700 dark:text-slate-100 mb-1" id="greeting-title">æ—©ä¸Šå¥½ï¼â˜€ï¸</h2>
                <p class="text-sm text-slate-400 dark:text-slate-500 font-medium" id="greeting-sub">ç›®æ ‡ 380ï¼Œä»Šå¤©ä¹Ÿè¦å…¨åŠ›ä»¥èµ´ã€‚</p>
            </div>
            <div class="bg-white dark:bg-darkcard px-5 py-3 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex items-center gap-4 transition-colors">
                <div class="text-right">
                    <div class="text-[10px] text-pink-400 font-bold uppercase tracking-widest">Countdown</div>
                    <div class="font-cute text-2xl font-black text-slate-700 dark:text-slate-200 tabular-nums leading-none" id="main-countdown-days">
                        28 <span class="text-sm text-slate-400 font-sans font-normal">Days</span>
                    </div>
                </div>
                <div class="h-8 w-px bg-slate-100 dark:bg-slate-700"></div>
                <div class="font-mono text-lg text-slate-500 dark:text-slate-400 tabular-nums" id="main-countdown-time">00:00:00</div>
            </div>
        </header>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="space-y-6 animate-in fade-in zoom-in duration-300">
            
            <!-- ğŸ¦† AI Emotional Support Duck -->
            <div class="bg-white dark:bg-darkcard rounded-[30px] p-6 md:p-8 shadow-sm border border-slate-100 dark:border-slate-700 relative overflow-hidden group transition-colors">
                <div class="absolute top-0 right-0 w-64 h-64 bg-yellow-50 dark:bg-yellow-500/10 rounded-full blur-3xl -mr-20 -mt-20 opacity-60"></div>
                <div class="relative z-10 flex flex-col md:flex-row gap-6 items-start">
                    
                    <div class="flex-shrink-0 flex flex-col items-center gap-2">
                        <div class="w-24 h-24 bg-yellow-100 dark:bg-yellow-900/40 rounded-full flex items-center justify-center text-5xl shadow-sm animate-float cursor-pointer select-none border-4 border-white dark:border-darkcard" onclick="changeQuote()">ğŸ¦†</div>
                        <button onclick="speakDuck()" class="p-2 rounded-full bg-white dark:bg-slate-800 shadow-sm hover:text-pink-500 transition-colors text-slate-400" title="å¬é¸­é¸­è¯´è¯">
                            <i data-lucide="volume-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="flex-1 w-full">
                        <div class="bg-slate-50 dark:bg-slate-800/50 px-5 py-4 rounded-2xl rounded-bl-none mb-4 border border-slate-100 dark:border-slate-700 relative min-h-[80px]">
                            <div class="absolute -left-2 bottom-0 w-4 h-4 bg-slate-50 dark:bg-slate-800/50 transform skew-x-12 z-0"></div>
                            <div id="duck-quote-container" class="relative z-10">
                                <p class="text-slate-600 dark:text-slate-300 text-sm md:text-base leading-relaxed font-medium ai-content" id="duck-quote">
                                    â€œå˜¿ï¼åˆ«æ‹…å¿ƒä½ çš„408å¤§é¢˜ï¼Œåªè¦å†™æ»¡é€»è¾‘å°±æœ‰åˆ†ï¼å–å£æ°´ï¼Œæˆ‘ä»¬ç»§ç»­ï¼Ÿâ€
                                </p>
                            </div>
                            <div id="ai-chat-container" class="hidden relative z-10 flex flex-col gap-3">
                                <div id="ai-response-area" class="text-slate-700 dark:text-slate-200 text-sm md:text-base leading-relaxed ai-content max-w-none">
                                    <p>æˆ‘æ˜¯ä½ çš„é¸­é¸­åŠ©æ‰‹ï¼Œå¯ä»¥é™ªä½ èŠå¤©ã€å‡ºé¢˜ã€æˆ–è€…è§£é‡Šåè¯å“¦ï¼ğŸ¦†</p>
                                </div>
                                <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar" id="quick-actions">
                                    <button onclick="triggerQuickAction('è§£é‡Šåè¯ï¼š')" class="whitespace-nowrap px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs text-slate-500 hover:text-indigo-500 hover:border-indigo-200 transition-colors">
                                        ğŸ“– è§£é‡Šåè¯
                                    </button>
                                    <button onclick="triggerQuickAction('å‡ºä¸€é“22408ç›¸å…³çš„é€‰æ‹©é¢˜ï¼Œå¹¶ç»™å‡ºè§£æ')" class="whitespace-nowrap px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs text-slate-500 hover:text-indigo-500 hover:border-indigo-200 transition-colors">
                                        â“ å‡ºä¸€é“é¢˜
                                    </button>
                                    <button onclick="triggerQuickAction('æˆ‘å¾ˆç„¦è™‘ï¼Œå¤‡è€ƒå‹åŠ›å¾ˆå¤§ï¼Œè¯·é¼“åŠ±æˆ‘')" class="whitespace-nowrap px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs text-slate-500 hover:text-pink-500 hover:border-pink-200 transition-colors">
                                        ğŸ†˜ å“„æˆ‘ç¡è§‰
                                    </button>
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="ai-input" class="flex-1 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-pink-400 transition-colors" placeholder="æƒ³é—®ä»€ä¹ˆï¼Ÿ..." onkeypress="handleEnter(event)">
                                    <button onclick="askDuck()" id="ai-send-btn" class="bg-pink-400 hover:bg-pink-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">å‘é€</button>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap justify-between items-center gap-2">
                            <div class="flex flex-wrap gap-2" id="mood-buttons">
                                <button onclick="getAIMoodMessage('tired')" class="px-3 py-1 rounded-full bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 hover:text-blue-500 transition">ğŸ˜« ç´¯äº†</button>
                                <button onclick="getAIMoodMessage('anxious')" class="px-3 py-1 rounded-full bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400 hover:bg-pink-50 dark:hover:bg-pink-900/30 hover:text-pink-500 transition">ğŸ˜° ç„¦è™‘</button>
                                <button onclick="getAIMoodMessage('confident')" class="px-3 py-1 rounded-full bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400 hover:bg-green-50 dark:hover:bg-green-900/30 hover:text-green-500 transition">ğŸ”¥ èƒ½ä¸Šå²¸</button>
                            </div>
                            <button onclick="toggleAIMode()" id="ai-toggle-btn" class="px-4 py-1.5 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-xs font-bold shadow-md hover:shadow-lg hover:scale-105 transition-all flex items-center gap-1">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> é—®é—®é¸­é¸­
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Knowledge Center -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 glass-card p-6 relative group min-h-[350px]">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-3 text-sm flex items-center gap-2">
                        <i data-lucide="book-open-check" class="w-4 h-4 text-indigo-500"></i> AI æ™ºå›Šå›¢
                    </h3>
                    <div class="flex items-center gap-4 border-b border-slate-100 dark:border-slate-700 mb-4 pb-2 overflow-x-auto no-scrollbar">
                        <button onclick="switchAiTab('vision')" id="tab-vision" class="tab-btn active whitespace-nowrap text-xs font-bold text-slate-500 pb-2 flex items-center gap-1">
                            <i data-lucide="camera" class="w-3 h-3"></i> æ‹ç…§æœé¢˜
                        </button>
                        <button onclick="switchAiTab('quiz')" id="tab-quiz" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 flex items-center gap-1">
                            <i data-lucide="graduation-cap" class="w-3 h-3"></i> æ¯æ—¥ä¸€ç»ƒ
                        </button>
                        <button onclick="switchAiTab('sentence')" id="tab-sentence" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 hover:text-slate-800 dark:hover:text-slate-200 transition-colors flex items-center gap-1">
                            <i data-lucide="languages" class="w-3 h-3"></i> é•¿éš¾å¥æ‹†è§£
                        </button>
                         <button onclick="switchAiTab('code')" id="tab-code" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 hover:text-slate-800 dark:hover:text-slate-200 transition-colors flex items-center gap-1">
                            <i data-lucide="code-2" class="w-3 h-3"></i> ä»£ç éšèº«è¯‘
                        </button>
                        <button onclick="switchAiTab('memory')" id="tab-memory" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 hover:text-slate-800 dark:hover:text-slate-200 transition-colors flex items-center gap-1">
                            <i data-lucide="brain" class="w-3 h-3"></i> è®°å¿†å®«æ®¿
                        </button>
                        <button onclick="switchAiTab('concept')" id="tab-concept" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 flex items-center gap-1">
                            <i data-lucide="puzzle" class="w-3 h-3"></i> æ¦‚å¿µå¡ç‰‡
                        </button>
                        <button onclick="switchAiTab('bigessay')" id="tab-bigessay" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 flex items-center gap-1 hover:text-slate-800 dark:hover:text-slate-200 transition-colors">
                            <i data-lucide="file-pen" class="w-3 h-3"></i> è‹±è¯­å¤§ä½œæ–‡
                        </button>
                        <button onclick="switchAiTab('smallessay')" id="tab-smallessay" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 flex items-center gap-1 hover:text-slate-800 dark:hover:text-slate-200 transition-colors">
                            <i data-lucide="file-edit" class="w-3 h-3"></i> è‹±è¯­å°ä½œæ–‡
                        </button>
                         <button onclick="switchAiTab('interview')" id="tab-interview" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 flex items-center gap-1 hover:text-slate-800 dark:hover:text-slate-200 transition-colors">
                            <i data-lucide="mic" class="w-3 h-3"></i> æ¨¡æ‹Ÿé¢è¯•
                        </button>
                        <button onclick="switchAiTab('doc')" id="tab-doc" class="tab-btn whitespace-nowrap text-xs font-bold text-slate-500 pb-2 flex items-center gap-1 hover:text-slate-800 dark:hover:text-slate-200 transition-colors">
                            <i data-lucide="file-text" class="w-3 h-3"></i> æ–‡æ¡£æå–
                        </button>
                    </div>
                    
                    <!-- Content: Vision -->
                    <div id="content-vision" class="space-y-4">
                        <p class="text-xs text-slate-400">ä¸Šä¼ é¢˜ç›®å›¾ç‰‡æˆ–è¾“å…¥æ–‡å­—é—®é¢˜ï¼ŒAI å¸®ä½ è§£ç­”ã€‚æ”¯æŒå›¾ç‰‡å’Œæ–‡å­—åŒæ¨¡å¼ã€‚</p>
                        <div class="flex flex-col gap-3">
                            <label class="upload-box flex flex-col items-center justify-center w-full h-32 rounded-xl cursor-pointer group">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <i data-lucide="image-plus" class="w-8 h-8 text-slate-400 mb-2 group-hover:text-indigo-500 transition-colors"></i>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½å›¾ç‰‡</p>
                                </div>
                                <input type="file" class="hidden" id="vision-file" accept="image/*" onchange="handleGenericImageUpload(event, 'vision-preview', 'vision-file')">
                            </label>
                            
                            <div id="vision-preview-container" class="hidden relative rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700">
                                <img id="vision-preview" class="w-full h-48 object-contain bg-black/5 dark:bg-black/20">
                                <button onclick="clearGenericImage('vision-preview', 'vision-file')" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full hover:bg-red-600"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>

                            <div class="flex items-center gap-2 text-xs text-slate-400">
                                <div class="flex-1 h-px bg-slate-200 dark:bg-slate-700"></div>
                                <span>æˆ–è¾“å…¥æ–‡å­—é—®é¢˜</span>
                                <div class="flex-1 h-px bg-slate-200 dark:bg-slate-700"></div>
                            </div>

                            <textarea id="vision-text-input" class="w-full h-20 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm focus:outline-none focus:border-indigo-400 resize-none" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼ˆå¯ä¸å›¾ç‰‡é…åˆä½¿ç”¨ï¼Œæˆ–å•ç‹¬æé—®ï¼‰..."></textarea>
                            
                            <button onclick="analyzeImage()" id="vision-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">å¼€å§‹è§£æ</button>
                        </div>
                        <div id="vision-output" class="hidden ai-content bg-indigo-50/50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl p-5 text-sm text-slate-700 dark:text-slate-300 shadow-sm prose dark:prose-invert max-w-none"></div>
                        <button id="vision-save-btn" onclick="saveToNotebook('cs', 'vision-output')" class="hidden w-full mt-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 py-2 rounded-xl text-sm font-bold hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="bookmark-plus" class="w-4 h-4"></i> ä¿å­˜åˆ°é”™é¢˜æœ¬
                        </button>
                    </div>

                    <!-- Content: Quiz -->
                    <div id="content-quiz" class="hidden space-y-4">
                        <div class="flex gap-2 mb-4">
                            <select id="quiz-subject" class="bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-400 flex-1">
                                <option value="408 (Computer Science)">408 (CS)</option>
                                <option value="æ•°å­¦ (Math)">æ•°å­¦ (Math)</option>
                                <option value="æ”¿æ²» (Politics)">æ”¿æ²» (Pol)</option>
                                <option value="è‹±è¯­ (English)">è‹±è¯­ (English)</option>
                            </select>
                            <button onclick="generateQuiz()" id="quiz-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold">å‡ºé¢˜</button>
                        </div>
                        <div id="quiz-output-area" class="hidden space-y-4">
                            <div id="quiz-question" class="ai-content bg-indigo-50/50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl p-5 text-sm text-slate-700 dark:text-slate-300"></div>
                            <button onclick="document.getElementById('quiz-answer').classList.remove('hidden')" class="text-xs text-indigo-500 hover:underline">å·çœ‹ç­”æ¡ˆä¸è§£æ</button>
                            <div id="quiz-answer" class="hidden ai-content bg-green-50/50 dark:bg-green-900/20 border border-green-100 dark:border-green-800 rounded-xl p-5 text-sm"></div>
                        </div>
                    </div>

                    <!-- Content: Sentence -->
                    <div id="content-sentence" class="hidden space-y-4">
                        <p class="text-xs text-slate-400">ç²˜è´´æˆ–ä¸Šä¼ å›¾ç‰‡ä¸­çš„è‹±è¯­é•¿éš¾å¥ï¼ŒAI å¸®ä½ åˆ’åˆ†æˆåˆ†å¹¶ç¿»è¯‘ã€‚æ”¯æŒæ–‡å­—å’Œå›¾ç‰‡è¾“å…¥ã€‚</p>
                        
                        <label class="upload-box flex flex-col items-center justify-center w-full h-24 rounded-xl cursor-pointer group">
                            <div class="flex flex-col items-center justify-center">
                                <i data-lucide="image-plus" class="w-6 h-6 text-slate-400 mb-1 group-hover:text-indigo-500 transition-colors"></i>
                                <p class="text-xs text-slate-500 dark:text-slate-400">ä¸Šä¼ é•¿éš¾å¥å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</p>
                            </div>
                            <input type="file" class="hidden" id="sentence-file" accept="image/*" onchange="handleGenericImageUpload(event, 'sentence-preview', 'sentence-file')">
                        </label>
                        
                        <div id="sentence-preview-container" class="hidden relative rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700">
                            <img id="sentence-preview" class="w-full h-32 object-contain bg-black/5 dark:bg-black/20">
                            <button onclick="clearGenericImage('sentence-preview', 'sentence-file')" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full hover:bg-red-600"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>

                        <div class="flex items-center gap-2 text-xs text-slate-400">
                            <div class="flex-1 h-px bg-slate-200 dark:bg-slate-700"></div>
                            <span>æˆ–è¾“å…¥æ–‡å­—</span>
                            <div class="flex-1 h-px bg-slate-200 dark:bg-slate-700"></div>
                        </div>

                        <textarea id="sentence-input" class="w-full h-24 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm focus:outline-none focus:border-indigo-400 resize-none" placeholder="Paste English sentence here..."></textarea>
                        <button onclick="breakSentence()" id="sentence-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">ä¸€é”®æ‹†è§£</button>
                        <div id="sentence-output" class="hidden ai-content bg-indigo-50/50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl p-5 text-sm text-slate-700 dark:text-slate-300 shadow-sm prose dark:prose-invert max-w-none"></div>
                        <button id="sentence-save-btn" onclick="saveToNotebook('eng', 'sentence-output')" class="hidden w-full mt-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 py-2 rounded-xl text-sm font-bold hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="bookmark-plus" class="w-4 h-4"></i> ä¿å­˜åˆ°é”™é¢˜æœ¬
                        </button>
                    </div>

                    <!-- Content: Memory -->
                    <div id="content-memory" class="hidden space-y-4">
                        <p class="text-xs text-slate-400">è¾“å…¥éš¾èƒŒçš„çŸ¥è¯†ç‚¹åˆ—è¡¨ï¼ŒAI ç”Ÿæˆè®°å¿†å£è¯€ã€‚</p>
                        <textarea id="memory-input" class="w-full h-24 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm focus:outline-none focus:border-indigo-400 resize-none" placeholder="ä¾‹å¦‚ï¼šäº’æ–¥ã€è¯·æ±‚ä¸ä¿æŒã€ä¸å‰¥å¤ºã€å¾ªç¯ç­‰å¾…"></textarea>
                        <button onclick="generateMnemonic()" id="memory-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">ç”Ÿæˆè®°å¿†å®«æ®¿</button>
                        <div id="memory-output" class="hidden ai-content bg-indigo-50/50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl p-5 text-sm text-slate-700 dark:text-slate-300 shadow-sm prose dark:prose-invert max-w-none"></div>
                        <button id="memory-save-btn" onclick="saveToNotebook('cs', 'memory-output')" class="hidden w-full mt-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 py-2 rounded-xl text-sm font-bold hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="bookmark-plus" class="w-4 h-4"></i> ä¿å­˜åˆ°é”™é¢˜æœ¬
                        </button>
                    </div>

                    <!-- Content: Concept -->
                    <div id="content-concept" class="hidden space-y-4">
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="concept-input" class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-purple-400" placeholder="ä¾‹å¦‚: KMP, è™šæ‹Ÿå†…å­˜...">
                            <button onclick="explainConcept()" id="concept-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold">ç”Ÿæˆ</button>
                        </div>
                        <div id="concept-output" class="hidden ai-content bg-purple-50/50 dark:bg-purple-900/20 border border-purple-100 dark:border-purple-800 rounded-xl p-5 text-sm"></div>
                        <button id="concept-save-btn" onclick="saveToNotebook('cs', 'concept-output')" class="hidden w-full mt-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 py-2 rounded-xl text-sm font-bold hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="bookmark-plus" class="w-4 h-4"></i> ä¿å­˜åˆ°é”™é¢˜æœ¬
                        </button>
                    </div>

                    <!-- Content: Big Essay (English) - NEW -->
                    <div id="content-bigessay" class="hidden space-y-4">
                        <p class="text-xs text-slate-400">è¾“å…¥ä½œæ–‡ä¸»é¢˜å…³é”®è¯ï¼ŒAI ç”Ÿæˆè‹±è¯­äºŒå¤§ä½œæ–‡æ¨¡æ¿ã€é«˜é¢‘å¥å‹å’Œå†™ä½œæŠ€å·§ã€‚</p>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="bigessay-input" class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-green-400" placeholder="ä¾‹å¦‚: ç¯å¢ƒä¿æŠ¤, ç§‘æŠ€å‘å±•, ä¼ ç»Ÿæ–‡åŒ–...">
                            <button onclick="generateBigEssay()" id="bigessay-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">ç”Ÿæˆæ¨¡æ¿</button>
                        </div>
                        <div id="bigessay-output" class="hidden ai-content bg-green-50/50 dark:bg-green-900/20 border border-green-100 dark:border-green-800 rounded-xl p-5 text-sm text-slate-700 dark:text-slate-300 shadow-sm prose dark:prose-invert max-w-none"></div>
                        <button id="bigessay-save-btn" onclick="saveToNotebook('eng', 'bigessay-output')" class="hidden w-full mt-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 py-2 rounded-xl text-sm font-bold hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="bookmark-plus" class="w-4 h-4"></i> ä¿å­˜åˆ°é”™é¢˜æœ¬
                        </button>
                    </div>

                    <!-- Content: Small Essay (English) - NEW -->
                    <div id="content-smallessay" class="hidden space-y-4">
                        <p class="text-xs text-slate-400">è¾“å…¥å°ä½œæ–‡ç±»å‹å…³é”®è¯ï¼ŒAI ç”Ÿæˆè‹±è¯­äºŒåº”ç”¨æ–‡æ¨¡æ¿ã€æ ¼å¼è¦æ±‚å’Œå¸¸ç”¨è¡¨è¾¾ã€‚</p>
                        <select id="smallessay-type" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-teal-400 mb-2">
                            <option value="letter">ä¹¦ä¿¡ (Letter)</option>
                            <option value="notice">é€šçŸ¥ (Notice)</option>
                            <option value="email">é‚®ä»¶ (Email)</option>
                            <option value="memo">å¤‡å¿˜å½• (Memo)</option>
                            <option value="report">æŠ¥å‘Š (Report)</option>
                        </select>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="smallessay-input" class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-teal-400" placeholder="ä¾‹å¦‚: é‚€è¯·å‡½, æŠ•è¯‰ä¿¡, å»ºè®®ä¿¡...">
                            <button onclick="generateSmallEssay()" id="smallessay-btn" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">ç”Ÿæˆæ¨¡æ¿</button>
                        </div>
                        <div id="smallessay-output" class="hidden ai-content bg-teal-50/50 dark:bg-teal-900/20 border border-teal-100 dark:border-teal-800 rounded-xl p-5 text-sm text-slate-700 dark:text-slate-300 shadow-sm prose dark:prose-invert max-w-none"></div>
                        <button id="smallessay-save-btn" onclick="saveToNotebook('eng', 'smallessay-output')" class="hidden w-full mt-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 py-2 rounded-xl text-sm font-bold hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="bookmark-plus" class="w-4 h-4"></i> ä¿å­˜åˆ°é”™é¢˜æœ¬
                        </button>
                    </div>

                    <!-- Content: Document AI -->
                    <div id="content-doc" class="hidden space-y-4">
                        <p class="text-xs text-slate-400">ä¸Šä¼ æ‰«æè®²ä¹‰/ç¬”è®°å›¾ç‰‡ï¼ŒAI ä¸€é”®æå–æ–‡å­—å¹¶ç”Ÿæˆæ‘˜è¦ã€‚</p>
                        <div class="flex flex-col gap-3">
                            <label class="upload-box flex flex-col items-center justify-center w-full h-32 rounded-xl cursor-pointer group">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <i data-lucide="scan-text" class="w-8 h-8 text-slate-400 mb-2 group-hover:text-orange-500 transition-colors"></i>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</p>
                                </div>
                                <input type="file" class="hidden" id="doc-file" accept="image/*" onchange="handleGenericImageUpload(event, 'doc-preview', 'doc-file')">
                            </label>
                            
                            <div id="doc-preview-container" class="hidden relative rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700">
                                <img id="doc-preview" class="w-full h-48 object-contain bg-black/5 dark:bg-black/20">
                                <button onclick="clearGenericImage('doc-preview', 'doc-file')" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full hover:bg-red-600"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                            
                            <button onclick="processDoc()" id="doc-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">æå–æ–‡å­— & æ‘˜è¦</button>
                        </div>
                        <div id="doc-result" class="hidden space-y-4">
                            <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-100 dark:border-orange-800 rounded-xl p-4">
                                <h4 class="font-bold text-orange-600 dark:text-orange-300 mb-2 text-xs uppercase tracking-wider flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> æ™ºèƒ½æ‘˜è¦</h4>
                                <div id="doc-summary" class="ai-content text-sm text-slate-700 dark:text-slate-300"></div>
                            </div>
                            <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-4 relative">
                                <button onclick="copyDocText()" class="absolute top-2 right-2 text-slate-400 hover:text-indigo-500" title="å¤åˆ¶å…¨æ–‡"><i data-lucide="copy" class="w-4 h-4"></i></button>
                                <h4 class="font-bold text-slate-500 dark:text-slate-400 mb-2 text-xs uppercase tracking-wider">æå–åŸæ–‡</h4>
                                <div id="doc-text" class="text-xs font-mono text-slate-600 dark:text-slate-400 whitespace-pre-wrap max-h-60 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Content: Code Translator (Updated) -->
                    <div id="content-code" class="hidden space-y-4">
                        <p class="text-xs text-slate-400">è¾“å…¥ç®—æ³•æè¿°æˆ–éœ€æ±‚ï¼ŒAI ç”Ÿæˆä»£ç æ¨¡æ¿ï¼›æˆ–ç²˜è´´ä»£ç è®© AI é€è¡Œè§£é‡Šå¹¶åˆ†æå¤æ‚åº¦ã€‚</p>
                        <select id="code-mode" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-400 mb-2">
                            <option value="explain">è§£é‡Šä»£ç </option>
                            <option value="generate">ç”Ÿæˆä»£ç æ¨¡æ¿</option>
                        </select>
                        <textarea id="code-input" class="w-full h-32 bg-slate-900 text-slate-300 border border-slate-700 rounded-lg p-3 text-xs font-mono focus:outline-none focus:border-blue-500 resize-none" placeholder="// ç²˜è´´ä»£ç ç‰‡æ®µæˆ–è¾“å…¥ç®—æ³•æè¿°ï¼ˆå¦‚ï¼šå¿«é€Ÿæ’åºã€äºŒå‰æ ‘éå†ã€LRUç¼“å­˜ï¼‰..."></textarea>
                        <button onclick="explainCode()" id="code-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">æ‰§è¡Œ</button>
                        <div id="code-output" class="hidden ai-content bg-slate-900 border border-slate-700 rounded-xl p-5 text-sm text-slate-300 shadow-sm prose prose-invert max-w-none"></div>
                        <button id="code-save-btn" onclick="saveToNotebook('cs', 'code-output')" class="hidden w-full mt-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 py-2 rounded-xl text-sm font-bold hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="bookmark-plus" class="w-4 h-4"></i> ä¿å­˜åˆ°é”™é¢˜æœ¬
                        </button>
                    </div>

                    <!-- Content: Mock Interview (NEW) -->
                    <div id="content-interview" class="hidden space-y-4">
                        <div class="flex gap-2 mb-4">
                            <select id="interview-topic" class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm">
                                <option value="è®¡ç®—æœºç½‘ç»œ">è®¡ç®—æœºç½‘ç»œ</option>
                                <option value="æ“ä½œç³»ç»Ÿ">æ“ä½œç³»ç»Ÿ</option>
                                <option value="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</option>
                                <option value="è®¡ç®—æœºç»„æˆåŸç†">è®¡ç®—æœºç»„æˆåŸç†</option>
                            </select>
                            <button onclick="startInterview()" id="interview-start-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold">å¼€å§‹é¢è¯•</button>
                        </div>
                        <div id="interview-area" class="hidden space-y-4">
                            <div class="bg-slate-100 dark:bg-slate-800/50 p-4 rounded-xl border-l-4 border-green-500">
                                <p class="text-xs font-bold text-slate-500 mb-1">é¢è¯•å®˜ (AI)</p>
                                <div id="interview-question" class="text-sm font-medium text-slate-800 dark:text-slate-200"></div>
                            </div>
                            <textarea id="interview-answer" class="w-full h-24 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm resize-none focus:border-green-500 outline-none" placeholder="è¾“å…¥ä½ çš„å›ç­”..."></textarea>
                            <button onclick="submitInterviewAnswer()" id="interview-submit-btn" class="w-full bg-slate-800 hover:bg-slate-900 dark:bg-slate-700 dark:hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-bold">æäº¤å›ç­”</button>
                            <div id="interview-feedback" class="hidden ai-content bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-800 rounded-xl p-4 text-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- Progress Ring -->
                <div class="glass-card p-6 flex flex-col items-center justify-center">
                    <h4 class="font-bold text-slate-700 dark:text-slate-200 text-xs uppercase mb-4 tracking-widest">Daily Energy</h4>
                    <div class="relative w-24 h-24">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="48" cy="48" r="42" stroke="#f1f5f9" class="dark:stroke-slate-700" stroke-width="8" fill="transparent" />
                            <circle id="progress-ring" cx="48" cy="48" r="42" stroke="#f472b6" stroke-width="8" fill="transparent" stroke-dasharray="263" stroke-dashoffset="263" class="transition-all duration-1000 rounded-full" stroke-linecap="round"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center text-lg font-black text-slate-600 dark:text-slate-300" id="progress-text">0%</div>
                    </div>
                    <p class="text-xs text-slate-400 mt-3">å·²å®Œæˆ <span class="text-pink-500 font-bold" id="done-count">0</span>/6 é¡¹</p>
                </div>
            </div>
            
            <!-- Phase Cards (Visual Only) -->
            <div class="glass-card p-6">
                <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4 text-sm"><i data-lucide="map" class="w-4 h-4 text-blue-400 inline mr-1"></i> å†²åˆºé˜¶æ®µ</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="bg-blue-50/30 dark:bg-blue-900/10 p-3 rounded-xl border border-blue-100 dark:border-slate-700">
                        <div class="text-[10px] font-bold text-blue-500 mb-1">å€’è®¡æ—¶ 30 å¤©</div>
                        <p class="text-xs text-slate-500">å›å½’çœŸé¢˜ï¼Œå…¨çœŸæ¨¡æ‹Ÿã€‚</p>
                    </div>
                    <div class="bg-yellow-50/30 dark:bg-yellow-900/10 p-3 rounded-xl border border-yellow-100 dark:border-slate-700">
                        <div class="text-[10px] font-bold text-yellow-600 mb-1">Day 11-20: ä»¿çœŸ</div>
                        <p class="text-xs text-slate-500 dark:text-slate-400">8:30åšæ•°å­¦ï¼Œ14:00åš408ã€‚ä¸¥æ ¼é™æ—¶ï¼Œå¿…é¡»æ‰‹å†™ã€‚</p>
                    </div>
                    <div class="bg-pink-50/30 dark:bg-pink-900/10 p-3 rounded-xl border border-pink-100 dark:border-slate-700">
                        <div class="text-[10px] font-bold text-pink-500 mb-1">Day 21-28: æŠ¼é¢˜</div>
                        <p class="text-xs text-slate-500 dark:text-slate-400">ç‹‚èƒŒè‚–å››åˆ†æé¢˜ã€‚è¿‡ä¸€éOS/ç½‘ç»œåè®®ç»†èŠ‚ã€‚</p>
                    </div>
                </div>
            </div>

             <!-- 4. Scores & Memo & Wellness -->
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Score Goals -->
                <div class="glass-card p-6 h-full flex flex-col justify-center">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold text-slate-700 dark:text-slate-200 text-sm flex items-center gap-2">
                            <i data-lucide="target" class="w-4 h-4 text-blue-400"></i> ç›®æ ‡ 380+
                        </h4>
                        <span class="text-lg font-black text-slate-700 dark:text-white" id="total-score">380</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center"><input type="number" id="s-pol" value="65" class="w-full text-center bg-pink-50 dark:bg-pink-900/20 rounded py-2 text-sm font-bold text-pink-500" oninput="calcTotal()"><label class="text-[10px] text-slate-400 mt-1 block">æ”¿æ²» Politics</label></div>
                        <div class="text-center"><input type="number" id="s-eng" value="75" class="w-full text-center bg-green-50 dark:bg-green-900/20 rounded py-2 text-sm font-bold text-green-500" oninput="calcTotal()"><label class="text-[10px] text-slate-400 mt-1 block">è‹±è¯­ English</label></div>
                        <div class="text-center"><input type="number" id="s-math" value="120" class="w-full text-center bg-blue-50 dark:bg-blue-900/20 rounded py-2 text-sm font-bold text-blue-500" oninput="calcTotal()"><label class="text-[10px] text-slate-400 mt-1 block">æ•°å­¦ Math</label></div>
                        <div class="text-center"><input type="number" id="s-cs" value="120" class="w-full text-center bg-purple-50 dark:bg-purple-900/20 rounded py-2 text-sm font-bold text-purple-500" oninput="calcTotal()"><label class="text-[10px] text-slate-400 mt-1 block">408 CS</label></div>
                    </div>
                </div>

                <!-- Quick Memo -->
                <div class="glass-card p-6 h-full relative group">
                    <h4 class="font-bold text-slate-700 dark:text-slate-200 text-sm mb-3 flex items-center gap-2"><i data-lucide="sticky-note" class="w-4 h-4 text-yellow-400"></i> éšå¿ƒä¾¿åˆ©è´´</h4>
                    <textarea id="quick-memo" class="w-full h-32 bg-yellow-50 dark:bg-slate-800/50 border-0 rounded-xl p-3 text-xs text-slate-600 dark:text-slate-300 resize-none focus:ring-2 focus:ring-yellow-100 dark:focus:ring-slate-600 lined-paper" placeholder="è®°ä¸‹çªç„¶æƒ³åˆ°çš„å…¬å¼ã€å¾…åŠ..."></textarea>
                    <div class="absolute bottom-6 right-6 text-[10px] text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity">Auto-saved</div>
                </div>

                <!-- Wellness Bar -->
                <div class="glass-card p-6 h-full flex flex-col justify-center">
                    <h4 class="font-bold text-slate-700 dark:text-slate-200 text-sm mb-4 flex items-center gap-2"><i data-lucide="heart" class="w-4 h-4 text-red-400"></i> æ¯æ—¥å…ƒæ°”</h4>
                    <div class="flex justify-between px-2">
                        <button onclick="toggleWellness('w-water')" id="w-water" class="wellness-btn flex flex-col items-center gap-2"><div class="w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-400"><i data-lucide="glass-water" class="w-5 h-5"></i></div><span class="text-[10px] text-slate-400">å–æ°´</span></button>
                        <button onclick="toggleWellness('w-fruit')" id="w-fruit" class="wellness-btn flex flex-col items-center gap-2"><div class="w-10 h-10 rounded-full bg-green-50 dark:bg-green-900/30 flex items-center justify-center text-green-400"><i data-lucide="apple" class="w-5 h-5"></i></div><span class="text-[10px] text-slate-400">æ°´æœ</span></button>
                        <button onclick="toggleWellness('w-eye')" id="w-eye" class="wellness-btn flex flex-col items-center gap-2"><div class="w-10 h-10 rounded-full bg-orange-50 dark:bg-orange-900/30 flex items-center justify-center text-orange-400"><i data-lucide="eye" class="w-5 h-5"></i></div><span class="text-[10px] text-slate-400">æŠ¤çœ¼</span></button>
                        <button onclick="toggleWellness('w-sleep')" id="w-sleep" class="wellness-btn flex flex-col items-center gap-2"><div class="w-10 h-10 rounded-full bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-400"><i data-lucide="moon" class="w-5 h-5"></i></div><span class="text-[10px] text-slate-400">æ—©ç¡</span></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: SCHEDULE -->
        <div id="view-schedule" class="hidden space-y-6 animate-in fade-in slide-in-from-right-4 duration-300 pb-10">
            <div class="flex justify-between items-end mb-4">
                <h2 class="text-xl font-bold text-slate-700 dark:text-slate-200">å…¨å¤©å€™æ—¶åˆ»è¡¨</h2>
                <button onclick="resetTasks()" class="text-xs px-3 py-1 bg-white dark:bg-darkcard rounded-full border border-slate-200 dark:border-slate-700 text-slate-400 hover:text-pink-500 transition">å¼€å¯æ–°çš„ä¸€å¤©</button>
            </div>
            <div class="relative pl-2 pb-6">
                <div class="timeline-item relative pl-10 pb-8"><div class="timeline-line"></div><div class="absolute left-0 top-1 checkbox-wrapper"><input type="checkbox" id="t1" onchange="saveProgress()"><label for="t1"><i data-lucide="sun" class="w-3 h-3"></i></label></div><div class="glass-card p-4 shadow-sm"><span class="text-xs font-bold text-orange-500 bg-orange-50 dark:bg-orange-900/20 px-2 py-0.5 rounded">07:00</span><h4 class="font-bold text-slate-700 dark:text-slate-200 text-sm mt-1">èµ·åºŠ & è‚–å››è¯µè¯»</h4></div></div>
                <div class="timeline-item relative pl-10 pb-8"><div class="timeline-line"></div><div class="absolute left-0 top-1 checkbox-wrapper"><input type="checkbox" id="t2" onchange="saveProgress()"><label for="t2"><i data-lucide="pen-tool" class="w-3 h-3"></i></label></div><div class="bg-blue-50 dark:bg-blue-900/20 p-5 rounded-2xl border border-blue-100 dark:border-blue-900/50"><span class="text-xs font-bold text-blue-600 dark:text-blue-300 mb-1 block">08:30 - 11:30</span><h4 class="font-bold text-slate-700 dark:text-white text-base">æ•°å­¦ / æ”¿æ²» æ¨¡è€ƒ</h4></div></div>
                <div class="timeline-item relative pl-10 pb-8"><div class="timeline-line"></div><div class="absolute left-0 top-1 checkbox-wrapper"><input type="checkbox" id="t3" onchange="saveProgress()"><label for="t3"><i data-lucide="coffee" class="w-3 h-3"></i></label></div><div class="glass-card bg-white/60 p-3"><h4 class="font-bold text-slate-600 dark:text-slate-300 text-sm mt-1">åˆé¤ & ä¼‘æ¯</h4></div></div>
                <div class="timeline-item relative pl-10 pb-8"><div class="timeline-line"></div><div class="absolute left-0 top-1 checkbox-wrapper"><input type="checkbox" id="t4" onchange="saveProgress()"><label for="t4"><i data-lucide="cpu" class="w-3 h-3"></i></label></div><div class="bg-purple-50 dark:bg-purple-900/20 p-5 rounded-2xl border border-purple-100 dark:border-purple-900/50"><span class="text-xs font-bold text-purple-600 dark:text-purple-300 mb-1 block">14:00 - 17:00</span><h4 class="font-bold text-slate-700 dark:text-white text-base">408 / è‹±è¯­ æ¨¡è€ƒ</h4></div></div>
                <div class="timeline-item relative pl-10 pb-8"><div class="timeline-line"></div><div class="absolute left-0 top-1 checkbox-wrapper"><input type="checkbox" id="t5" onchange="saveProgress()"><label for="t5"><i data-lucide="moon" class="w-3 h-3"></i></label></div><div class="glass-card p-4 shadow-sm"><span class="text-xs font-bold text-indigo-400 bg-indigo-50 dark:bg-indigo-900/20 px-2 py-0.5 rounded">19:00</span><h4 class="font-bold text-slate-700 dark:text-slate-200 text-sm mt-1">å¤ç›˜ & é”™é¢˜æ•´ç†</h4></div></div>
                <div class="timeline-item relative pl-10"><div class="absolute left-0 top-1 checkbox-wrapper"><input type="checkbox" id="t6" onchange="saveProgress()"><label for="t6"><i data-lucide="bed" class="w-3 h-3"></i></label></div><div class="bg-slate-800 p-4 rounded-2xl shadow-sm text-white"><h4 class="font-bold text-white text-sm mt-1">å…³æœºç¡è§‰ (23:00)</h4></div></div>
            </div>
            <button onclick="generateDailyReport()" id="report-btn" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-xl font-bold shadow-lg">âœ¨ ç”Ÿæˆä»Šæ—¥å¤ç›˜æˆ˜æŠ¥</button>
            <div id="report-area" class="mt-4 hidden bg-white dark:bg-darkcard p-4 rounded-xl ai-content"></div>
        </div>

        <!-- VIEW: GRADER (UPDATED TO V2.0: IMAGES & TABS) -->
        <div id="view-grader" class="hidden space-y-6 animate-in fade-in zoom-in duration-300">
            <div class="glass-card p-6 min-h-screen md:min-h-0">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center text-pink-500"><i data-lucide="pen-tool" class="w-4 h-4"></i></div>
                    <h2 class="text-xl font-bold text-slate-700 dark:text-slate-200">å…¨çœŸæ‰‹å†™é˜…å·å®¤ 2.0</h2>
                </div>
                
                <!-- New 4-Tab Structure -->
                <div class="flex gap-2 border-b border-slate-200 dark:border-slate-700 mb-6 overflow-x-auto no-scrollbar">
                    <button onclick="switchGraderTab('eng')" id="tab-grader-eng" class="tab-btn active pb-3 px-3 text-sm font-bold text-slate-500 whitespace-nowrap transition-colors flex items-center gap-1">ğŸ“ è‹±è¯­ä½œæ–‡</button>
                    <button onclick="switchGraderTab('trans')" id="tab-grader-trans" class="tab-btn pb-3 px-3 text-sm font-bold text-slate-500 whitespace-nowrap transition-colors flex items-center gap-1">ğŸ”¤ è‹±äºŒç¿»è¯‘Â·åŒå›¾</button>
                    <button onclick="switchGraderTab('pol')" id="tab-grader-pol" class="tab-btn pb-3 px-3 text-sm font-bold text-slate-500 whitespace-nowrap transition-colors flex items-center gap-1">âš–ï¸ æ”¿æ²»å¤§é¢˜</button>
                    <button onclick="switchGraderTab('cs408')" id="tab-grader-cs408" class="tab-btn pb-3 px-3 text-sm font-bold text-slate-500 whitespace-nowrap transition-colors flex items-center gap-1">ğŸ’» 408å¤§é¢˜</button>
                </div>

                <!-- 1. English Essay Grader -->
                <div id="grader-eng" class="space-y-4">
                    <div class="bg-blue-50 dark:bg-blue-900/10 p-3 rounded-lg border border-blue-100 dark:border-blue-900/50 flex items-start gap-2">
                        <i data-lucide="info" class="w-4 h-4 text-blue-500 mt-0.5"></i>
                        <p class="text-xs text-blue-600 dark:text-blue-300">AI å°†æ¨¡ä»¿é˜…å·è€å¸ˆï¼Œå…ˆçœ‹å­—è¿¹å·¥æ•´åº¦ï¼ˆå·é¢åˆ†ï¼‰ï¼Œå†çœ‹è¯­æ³•é€»è¾‘ï¼Œæœ€åç»™å‡ºâ€œç‹ å¿ƒâ€æ‰“åˆ†ã€‚</p>
                    </div>

                    <!-- Upload Area -->
                    <label class="upload-box flex flex-col items-center justify-center w-full h-40 rounded-xl cursor-pointer group">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i data-lucide="camera" class="w-8 h-8 text-slate-400 mb-2 group-hover:text-pink-500 transition-colors"></i>
                            <p class="text-xs text-slate-500 font-medium">æ‹ç…§ä¸Šä¼ æ‰‹å†™ä½œæ–‡</p>
                        </div>
                        <input type="file" class="hidden" id="eng-essay-file" accept="image/*" onchange="handleGenericImageUpload(event, 'eng-preview', 'eng-essay-file')">
                    </label>

                    <!-- Preview -->
                    <div id="eng-preview-container" class="hidden relative rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 shadow-sm">
                        <img id="eng-preview" class="w-full h-auto max-h-64 object-contain bg-black/5">
                        <button onclick="clearGenericImage('eng-preview', 'eng-essay-file')" class="absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600 shadow-md"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>

                    <button onclick="gradeEssay('english')" id="eng-grade-btn" class="w-full bg-pink-500 hover:bg-pink-600 text-white py-3 rounded-xl font-bold transition-all shadow-md active:scale-95">å¼€å§‹æ®‹é…·é˜…å·</button>
                    
                    <div id="eng-result" class="hidden bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl p-5 text-sm ai-content prose dark:prose-invert max-w-none"></div>
                    <button id="eng-save-btn" onclick="saveToNotebook('eng', 'eng-result')" class="hidden w-full mt-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 py-2 rounded-xl text-sm font-bold hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="bookmark-plus" class="w-4 h-4"></i> ä¿å­˜åˆ°é”™é¢˜æœ¬
                    </button>
                </div>

                <!-- 2. Translation Dual-Image Grader (NEW) -->
                <div id="grader-trans" class="hidden space-y-6">
                    <div class="bg-indigo-50 dark:bg-indigo-900/10 p-3 rounded-lg border border-indigo-100 dark:border-indigo-900/50 flex items-start gap-2">
                        <i data-lucide="sparkles" class="w-4 h-4 text-indigo-500 mt-0.5"></i>
                        <p class="text-xs text-indigo-600 dark:text-indigo-300">ç‹¬å®¶åŒæµåˆ†æï¼šåŒæ—¶ä¸Šä¼ ã€è¯•å·åŸæ–‡ã€‘å’Œã€ä½ çš„æ‰‹å†™è¯‘æ–‡ã€‘ï¼ŒAI å·¦å³å¯¹ç…§æ‰¾æ¼è¯‘ã€‚</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Left: Source -->
                        <div class="space-y-2">
                            <p class="text-xs font-bold text-slate-500 ml-1">å›¾1ï¼šè¯•å·åŸæ–‡</p>
                            <label class="upload-box flex flex-col items-center justify-center w-full h-32 rounded-xl cursor-pointer group bg-slate-50 dark:bg-slate-800/50">
                                <div class="flex flex-col items-center justify-center">
                                    <i data-lucide="file-text" class="w-6 h-6 text-slate-400 mb-2 group-hover:text-indigo-500"></i>
                                    <p class="text-[10px] text-slate-400">ä¸Šä¼ è‹±è¯­åŸæ–‡</p>
                                </div>
                                <input type="file" class="hidden" id="trans-source-file" accept="image/*" onchange="handleGenericImageUpload(event, 'trans-source-preview', 'trans-source-file')">
                            </label>
                            <div id="trans-source-preview-container" class="hidden relative rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700">
                                <img id="trans-source-preview" class="w-full h-24 object-cover">
                                <button onclick="clearGenericImage('trans-source-preview', 'trans-source-file')" class="absolute top-1 right-1 bg-black/50 text-white p-1 rounded-full"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                        </div>

                        <!-- Right: Target -->
                        <div class="space-y-2">
                            <p class="text-xs font-bold text-slate-500 ml-1">å›¾2ï¼šä½ çš„è¯‘æ–‡</p>
                            <label class="upload-box flex flex-col items-center justify-center w-full h-32 rounded-xl cursor-pointer group bg-slate-50 dark:bg-slate-800/50">
                                <div class="flex flex-col items-center justify-center">
                                    <i data-lucide="pen-line" class="w-6 h-6 text-slate-400 mb-2 group-hover:text-pink-500"></i>
                                    <p class="text-[10px] text-slate-400">ä¸Šä¼ æ‰‹å†™è¯‘æ–‡</p>
                                </div>
                                <input type="file" class="hidden" id="trans-target-file" accept="image/*" onchange="handleGenericImageUpload(event, 'trans-target-preview', 'trans-target-file')">
                            </label>
                            <div id="trans-target-preview-container" class="hidden relative rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700">
                                <img id="trans-target-preview" class="w-full h-24 object-cover">
                                <button onclick="clearGenericImage('trans-target-preview', 'trans-target-file')" class="absolute top-1 right-1 bg-black/50 text-white p-1 rounded-full"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                    </div>

                    <button onclick="gradeTranslation()" id="trans-grade-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white py-3 rounded-xl font-bold transition-all shadow-md active:scale-95">å¼€å§‹åŒå›¾å¯¹ç…§æ‰¹æ”¹</button>
                    <div id="trans-result" class="hidden bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl p-5 text-sm ai-content prose dark:prose-invert max-w-none"></div>
                    <button id="trans-save-btn" onclick="saveToNotebook('eng', 'trans-result')" class="hidden w-full mt-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 py-2 rounded-xl text-sm font-bold hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="bookmark-plus" class="w-4 h-4"></i> ä¿å­˜åˆ°é”™é¢˜æœ¬
                    </button>
                </div>

                <!-- 3. Politics Grader -->
                <div id="grader-pol" class="hidden space-y-4">
                     <div class="bg-orange-50 dark:bg-orange-900/10 p-3 rounded-lg border border-orange-100 dark:border-orange-900/50 flex items-start gap-2">
                        <i data-lucide="alert-circle" class="w-4 h-4 text-orange-500 mt-0.5"></i>
                        <p class="text-xs text-orange-600 dark:text-orange-300">AI å°†åˆ†æä½ çš„å·é¢æ•´æ´åº¦ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦è¸©ä¸­äº†â€œè‚–å››â€çš„é‡‡åˆ†ç‚¹ã€‚</p>
                    </div>

                    <textarea id="pol-q-input" class="w-full h-12 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm focus:outline-none focus:border-orange-400 mb-2" placeholder="è¾“å…¥é¢˜ç›®å…³é”®è¯ï¼ˆä¾‹å¦‚ï¼šé©¬åŸ è®¤è¯†è®º ç»“åˆææ–™...ï¼‰"></textarea>

                    <label class="upload-box flex flex-col items-center justify-center w-full h-32 rounded-xl cursor-pointer group">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i data-lucide="scroll-text" class="w-8 h-8 text-slate-400 mb-2 group-hover:text-orange-500 transition-colors"></i>
                            <p class="text-xs text-slate-500">ä¸Šä¼ æ‰‹å†™å¤§é¢˜ç­”æ¡ˆæˆ–é¢˜ç›®å›¾ç‰‡</p>
                        </div>
                        <input type="file" class="hidden" id="pol-answer-file" accept="image/*" onchange="handleGenericImageUpload(event, 'pol-preview', 'pol-answer-file')">
                    </label>

                    <div id="pol-preview-container" class="hidden relative rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 shadow-sm">
                        <img id="pol-preview" class="w-full h-auto max-h-48 object-contain bg-black/5">
                        <button onclick="clearGenericImage('pol-preview', 'pol-answer-file')" class="absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600 shadow-md"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>

                    <button onclick="gradeEssay('politics')" id="pol-grade-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-xl font-bold transition-all shadow-md active:scale-95">åˆ†æé‡‡åˆ†ç‚¹ & ç”Ÿæˆç­”æ¡ˆæ¨¡æ¿</button>
                    <div id="pol-result" class="hidden bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl p-5 text-sm ai-content prose dark:prose-invert max-w-none"></div>
                    <button id="pol-save-btn" onclick="saveToNotebook('pol', 'pol-result')" class="hidden w-full mt-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 py-2 rounded-xl text-sm font-bold hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="bookmark-plus" class="w-4 h-4"></i> ä¿å­˜åˆ°é”™é¢˜æœ¬
                    </button>
                </div>

                <!-- 4. 408 CS Large Question Grader (NEW) -->
                <div id="grader-cs408" class="hidden space-y-4">
                    <div class="bg-purple-50 dark:bg-purple-900/10 p-3 rounded-lg border border-purple-100 dark:border-purple-900/50 flex items-start gap-2">
                        <i data-lucide="cpu" class="w-4 h-4 text-purple-500 mt-0.5"></i>
                        <p class="text-xs text-purple-600 dark:text-purple-300">AI å°†åˆ†æä½ çš„408å¤§é¢˜ç­”æ¡ˆï¼Œæ£€æŸ¥é€»è¾‘å®Œæ•´æ€§ã€æ­¥éª¤åˆ†æå’Œå…³é”®å¾—åˆ†ç‚¹ï¼Œå¹¶æä¾›æ ‡å‡†ç­”æ¡ˆæ¨¡æ¿ã€‚æ”¯æŒæ•°æ®ç»“æ„ã€æ“ä½œç³»ç»Ÿã€è®¡ç®—æœºç½‘ç»œã€è®¡ç®—æœºç»„æˆåŸç†ã€‚</p>
                    </div>

                    <select id="cs408-type" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-purple-400 mb-2">
                        <option value="ds">æ•°æ®ç»“æ„</option>
                        <option value="os">æ“ä½œç³»ç»Ÿ</option>
                        <option value="cn">è®¡ç®—æœºç½‘ç»œ</option>
                        <option value="co">è®¡ç®—æœºç»„æˆåŸç†</option>
                    </select>

                    <textarea id="cs408-q-input" class="w-full h-16 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm focus:outline-none focus:border-purple-400 mb-2" placeholder="è¾“å…¥é¢˜ç›®æè¿°æˆ–å…³é”®è¯ï¼ˆä¾‹å¦‚ï¼šå¿«é€Ÿæ’åºç®—æ³•æè¿°ã€é¡µé¢ç½®æ¢ç®—æ³•è®¡ç®—...ï¼‰"></textarea>

                    <label class="upload-box flex flex-col items-center justify-center w-full h-32 rounded-xl cursor-pointer group">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i data-lucide="file-code" class="w-8 h-8 text-slate-400 mb-2 group-hover:text-purple-500 transition-colors"></i>
                            <p class="text-xs text-slate-500">ä¸Šä¼ æ‰‹å†™408å¤§é¢˜ç­”æ¡ˆ</p>
                        </div>
                        <input type="file" class="hidden" id="cs408-answer-file" accept="image/*" onchange="handleGenericImageUpload(event, 'cs408-preview', 'cs408-answer-file')">
                    </label>

                    <div id="cs408-preview-container" class="hidden relative rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 shadow-sm">
                        <img id="cs408-preview" class="w-full h-auto max-h-48 object-contain bg-black/5">
                        <button onclick="clearGenericImage('cs408-preview', 'cs408-answer-file')" class="absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600 shadow-md"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>

                    <button onclick="gradeCS408()" id="cs408-grade-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-xl font-bold transition-all shadow-md active:scale-95">åˆ†æ408å¤§é¢˜ & ç”Ÿæˆæ ‡å‡†ç­”æ¡ˆ</button>
                    <div id="cs408-result" class="hidden bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl p-5 text-sm ai-content prose dark:prose-invert max-w-none"></div>
                    <button id="cs408-save-btn" onclick="saveToNotebook('cs', 'cs408-result')" class="hidden w-full mt-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 py-2 rounded-xl text-sm font-bold hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="bookmark-plus" class="w-4 h-4"></i> ä¿å­˜åˆ°é”™é¢˜æœ¬
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW: NOTEBOOK (NEW!) -->
        <div id="view-notebook" class="hidden space-y-6 animate-in fade-in zoom-in duration-300">
            <div class="glass-card p-6 min-h-[80vh]">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center"><i data-lucide="book-x" class="w-4 h-4"></i></div>
                        <h2 class="text-xl font-bold text-slate-700 dark:text-slate-200">æ™ºèƒ½é”™é¢˜æœ¬</h2>
                    </div>
                    <button onclick="showAddMistakeModal()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-1 shadow-sm transition-all active:scale-95">
                        <i data-lucide="plus" class="w-3 h-3"></i> è®°ä¸€é¢˜
                    </button>
                </div>

                <!-- Empty State -->
                <div id="notebook-empty" class="hidden flex-col items-center justify-center py-20 text-slate-400">
                    <i data-lucide="clipboard-list" class="w-12 h-12 mb-4 opacity-20"></i>
                    <p class="text-sm">æš‚æ— é”™é¢˜è®°å½•ï¼Œå¤ªæ£’äº†ï¼(æˆ–è€…è¿˜æ²¡å¼€å§‹è®°ï¼Ÿ)</p>
                </div>

                <!-- Mistake List -->
                <div id="mistake-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>

        <!-- VIEW: FOCUS -->
        <div id="view-focus" class="hidden h-full flex flex-col items-center justify-center animate-in fade-in zoom-in duration-500">
            <div class="relative w-full max-w-md text-center p-8">
                <div class="w-64 h-64 mx-auto bg-gradient-to-b from-blue-100 to-pink-100 dark:from-blue-900 dark:to-pink-900 rounded-full flex flex-col items-center justify-center shadow-[0_0_60px_rgba(236,72,153,0.1)] animate-breathe relative group cursor-pointer border-4 border-white dark:border-slate-700" onclick="toggleTimer()">
                    <div class="text-5xl font-cute font-black text-slate-700 dark:text-white tabular-nums z-10" id="timer-display">45:00</div>
                    <div class="text-xs text-slate-400 mt-2 z-10 font-bold tracking-widest uppercase" id="timer-status">Tap to Start</div>
                    <div class="absolute top-8 left-12 w-16 h-8 bg-white opacity-40 rounded-full transform -rotate-45 blur-sm dark:opacity-10"></div>
                </div>
                <div class="mt-12 flex flex-col items-center gap-4">
                    <div class="flex gap-3">
                        <button onclick="setTimer(45)" class="px-4 py-2 rounded-full bg-white dark:bg-darkcard shadow-sm border border-slate-100 dark:border-slate-700 text-xs font-bold text-slate-500 dark:text-slate-400 hover:text-pink-500 hover:border-pink-200 transition">45m æ·±åº¦</button>
                        <button onclick="setTimer(180)" class="px-4 py-2 rounded-full bg-white dark:bg-darkcard shadow-sm border border-slate-100 dark:border-slate-700 text-xs font-bold text-slate-500 dark:text-slate-400 hover:text-purple-500 hover:border-purple-200 transition">3h æ¨¡è€ƒ</button>
                        <button onclick="resetTimer()" class="w-10 h-10 rounded-full bg-white dark:bg-darkcard shadow-sm border border-slate-100 dark:border-slate-700 flex items-center justify-center text-slate-400 hover:text-slate-600 dark:hover:text-white"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                    </div>
                    <div class="flex items-center gap-2 bg-white dark:bg-darkcard px-3 py-1.5 rounded-full border border-slate-100 dark:border-slate-700 shadow-sm">
                        <input type="number" id="custom-min" class="w-12 text-center text-xs font-bold text-slate-700 dark:text-slate-200 bg-transparent focus:outline-none border-b border-slate-200 dark:border-slate-600" placeholder="min" min="1" max="180">
                        <button onclick="setCustomTimer()" class="text-xs font-bold text-slate-400 hover:text-blue-500">Set</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- API KEY MODAL -->
    <div id="key-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4 animate-in fade-in duration-200">
        <div class="bg-white dark:bg-darkcard w-full max-w-md rounded-2xl p-6 shadow-2xl transform scale-100 border border-slate-200 dark:border-slate-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <i data-lucide="key" class="w-5 h-5 text-indigo-500"></i> é…ç½® API Key
                </h3>
                <button onclick="toggleKeyModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-4 leading-relaxed">
                ä¸ºäº†ä½¿ç”¨ AI åŠŸèƒ½ï¼ˆé˜…å·ã€å¯¹è¯ã€æœé¢˜ï¼‰ï¼Œä½ éœ€è¦å¡«å…¥è‡ªå·±çš„ Google Gemini API Keyã€‚<br>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-500 underline font-bold hover:text-indigo-600">ç‚¹å‡»è¿™é‡Œè·å–å…è´¹ Key</a>
            </p>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wide">API Key</label>
                    <input type="password" id="user-api-key-input" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 transition-colors" placeholder="AIzaSy...">
                </div>
                <button onclick="saveUserApiKey()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2.5 rounded-lg transition-all active:scale-95">ä¿å­˜é…ç½®</button>
                <p class="text-[10px] text-center text-slate-400">Key ä»…ä¿å­˜åœ¨ä½ çš„æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•ä¸­é—´æœåŠ¡å™¨ã€‚</p>
            </div>
        </div>
    </div>

    <!-- ADD MISTAKE MODAL (NEW) -->
    <div id="mistake-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4 animate-in fade-in duration-200">
        <div class="bg-white dark:bg-darkcard w-full max-w-lg rounded-2xl p-6 shadow-2xl border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">è®°å½•é”™é¢˜</h3>
            <div class="space-y-3">
                <select id="m-subject" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm">
                    <option value="math">æ•°å­¦</option>
                    <option value="cs">408</option>
                    <option value="eng">è‹±è¯­</option>
                    <option value="pol">æ”¿æ²»</option>
                </select>
                <textarea id="m-question" class="w-full h-24 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 text-sm resize-none" placeholder="é¢˜ç›®æè¿° / çŸ¥è¯†ç‚¹..."></textarea>
                <textarea id="m-note" class="w-full h-20 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 text-sm resize-none" placeholder="æˆ‘çš„é”™è¯¯åŸå› ..."></textarea>
                <div class="flex gap-2 justify-end mt-4">
                    <button onclick="document.getElementById('mistake-modal').classList.add('hidden')" class="px-4 py-2 rounded-lg text-sm text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800">å–æ¶ˆ</button>
                    <button onclick="saveMistake()" class="px-4 py-2 rounded-lg text-sm bg-indigo-500 text-white hover:bg-indigo-600 font-bold">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MISTAKE DETAIL MODAL (NEW) -->
    <div id="mistake-detail-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4 animate-in fade-in duration-200">
        <div class="bg-white dark:bg-darkcard w-full max-w-2xl max-h-[80vh] overflow-y-auto rounded-2xl p-6 shadow-2xl border border-slate-200 dark:border-slate-700 relative">
            <button onclick="document.getElementById('mistake-detail-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div id="md-content" class="space-y-4"></div>
            <div id="md-analysis" class="mt-6 pt-6 border-t border-slate-100 dark:border-slate-700 hidden">
                <h4 class="font-bold text-indigo-500 mb-2 flex items-center gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i> AI è¯Šæ–­åˆ†æ</h4>
                <div id="md-analysis-content" class="ai-content text-sm bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl"></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // DEPRECATED: const apiKey = ""; 
        const examDate = new Date();
            examDate.setMonth(11);  // æœˆä»½ä» 0 å¼€å§‹ï¼Œ11 ä»£è¡¨ 12 æœˆ
            examDate.setDate(20);   // 20 å·
            examDate.setHours(0, 0, 0, 0); // 0ç‚¹0åˆ†0ç§’
        
        const duckQuotes = [
            "â€œå˜¿ï¼åˆ«æ‹…å¿ƒä½ çš„408å¤§é¢˜ï¼Œåªè¦å†™æ»¡é€»è¾‘å°±æœ‰åˆ†ï¼â€",
            "â€œæ•°å­¦åšä¸å‡ºæ¥ï¼Ÿæ²¡å…³ç³»ï¼ŒçœŸé¢˜é‡Œé‚£é“æ¶å¿ƒçš„ç§¯åˆ†é¢˜å¤§å®¶éƒ½ä¸ä¼šåšï¼â€",
            "â€œå“‡ï¼Œä½ å·²ç»åšæŒåˆ°ç°åœ¨äº†ï¼Œè¿™æœ¬èº«å°±å¾ˆäº†ä¸èµ·ï¼æ‘¸æ‘¸å¤´ ğŸ¦†â€",
            "â€œè‹±è¯­ä½œæ–‡æ¨¡æ¿èƒŒç†Ÿäº†å—ï¼Ÿè®°å¾—å­—å†™å¤§ä¸€ç‚¹å“¦ã€‚â€",
            "â€œæ”¿æ²»ä¸éœ€è¦æ™ºå•†ï¼Œåªéœ€è¦ä½ å“ªæ€•å¤šçœ‹ä¸€çœ¼è‚–å››ã€‚â€",
            "â€œæ·±å‘¼å¸â€”â€”å¸æ°”â€”â€”å‘¼æ°”â€”â€”å¤§è„‘é‡å¯æˆåŠŸï¼â€"
        ];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            lucide.createIcons();
            startCountdown();
            setGreeting();
            loadData();
            changeQuote();
            updateProgress();
            checkApiKeyStatus(); 
            renderMistakes(); // Initial render
            
            if(localStorage.getItem('theme') === 'dark') {
                document.documentElement.classList.add('dark');
            }
            
            // Memo Auto-save
            const memo = document.getElementById('quick-memo');
            if(memo) {
                memo.addEventListener('input', () => {
                    localStorage.setItem('22408_v22_memo', memo.value);
                });
                memo.value = localStorage.getItem('22408_v22_memo') || '';
            }
        }

        // --- API KEY MANAGEMENT ---
        function toggleKeyModal() {
            const modal = document.getElementById('key-modal');
            modal.classList.toggle('hidden');
            if(!modal.classList.contains('hidden')) {
                document.getElementById('user-api-key-input').value = localStorage.getItem('gemini_user_key') || '';
            }
        }

        function saveUserApiKey() {
            const val = document.getElementById('user-api-key-input').value.trim();
            if(val) {
                localStorage.setItem('gemini_user_key', val);
                alert("API Key å·²ä¿å­˜ï¼ç°åœ¨å¯ä»¥ä½¿ç”¨ AI åŠŸèƒ½äº†ã€‚");
                toggleKeyModal();
                checkApiKeyStatus();
            } else {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ Key");
            }
        }

        function checkApiKeyStatus() {
            const hasKey = !!localStorage.getItem('gemini_user_key');
            const txt = document.getElementById('key-status-text');
            if(txt) txt.innerText = hasKey ? "API Key å·²é…ç½®" : "è®¾ç½® API Key (æœªé…ç½®)";
        }

        function getUserKey() {
            return localStorage.getItem('gemini_user_key');
        }

        // --- NAVIGATION ---
        function showView(viewId) {
            ['dashboard', 'schedule', 'grader', 'focus', 'notebook'].forEach(v => {
                document.getElementById('view-' + v).classList.add('hidden');
                const btn = document.getElementById('nav-' + v);
                if(btn) {
                    btn.classList.remove('active');
                    if(v === viewId) btn.classList.add('active');
                }
            });
            document.getElementById('view-' + viewId).classList.remove('hidden');
        }

        function switchAiTab(tab) {
            const contents = ['vision', 'quiz', 'sentence', 'memory', 'concept', 'doc', 'code', 'interview', 'bigessay', 'smallessay'];
            contents.forEach(t => {
                const content = document.getElementById(`content-${t}`);
                const btn = document.getElementById(`tab-${t}`);
                if(t === tab) {
                    content.classList.remove('hidden');
                    btn.classList.add('active');
                } else {
                    content.classList.add('hidden');
                    btn.classList.remove('active');
                }
            });
        }

        function switchGraderTab(tab) {
            ['eng', 'trans', 'pol', 'cs408'].forEach(t => {
                const el = document.getElementById(`grader-${t}`);
                const btn = document.getElementById(`tab-grader-${t}`);
                if(t === tab) { el.classList.remove('hidden'); btn.classList.add('active'); }
                else { el.classList.add('hidden'); btn.classList.remove('active'); }
            });
        }

        // --- MISTAKE NOTEBOOK LOGIC (NEW) ---
        let mistakes = JSON.parse(localStorage.getItem('22408_mistakes') || '[]');

        function showAddMistakeModal() {
            document.getElementById('m-question').value = '';
            document.getElementById('m-note').value = '';
            document.getElementById('mistake-modal').classList.remove('hidden');
        }

        function saveMistake() {
            const subj = document.getElementById('m-subject').value;
            const q = document.getElementById('m-question').value.trim();
            const n = document.getElementById('m-note').value.trim();
            
            if(!q) return alert("è‡³å°‘å†™ç‚¹é¢˜ç›®æè¿°å§ï¼");

            const newMistake = {
                id: Date.now(),
                subject: subj,
                question: q,
                note: n,
                date: new Date().toLocaleDateString(),
                analysis: null
            };

            mistakes.unshift(newMistake);
            localStorage.setItem('22408_mistakes', JSON.stringify(mistakes));
            renderMistakes();
            document.getElementById('mistake-modal').classList.add('hidden');
        }

        function deleteMistake(id) {
            if(!confirm("ç¡®å®šåˆ é™¤è¿™æ¡é”™é¢˜è®°å½•å—ï¼Ÿ")) return;
            mistakes = mistakes.filter(m => m.id !== id);
            localStorage.setItem('22408_mistakes', JSON.stringify(mistakes));
            renderMistakes();
        }

        function renderMistakes() {
            const list = document.getElementById('mistake-list');
            const empty = document.getElementById('notebook-empty');
            list.innerHTML = '';

            if(mistakes.length === 0) {
                empty.classList.replace('hidden', 'flex');
            } else {
                empty.classList.replace('flex', 'hidden');
                mistakes.forEach(m => {
                    let tagClass = '';
                    let subjName = '';
                    switch(m.subject) {
                        case 'math': tagClass = 'tag-math'; subjName = 'æ•°å­¦'; break;
                        case 'cs': tagClass = 'tag-cs'; subjName = '408'; break;
                        case 'eng': tagClass = 'tag-eng'; subjName = 'è‹±è¯­'; break;
                        case 'pol': tagClass = 'tag-pol'; subjName = 'æ”¿æ²»'; break;
                    }

                    const div = document.createElement('div');
                    div.className = 'bg-white dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 p-4 rounded-xl mistake-card cursor-pointer relative group';
                    div.onclick = (e) => { if(!e.target.closest('button')) openMistakeDetail(m.id); };
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold px-2 py-1 rounded ${tagClass}">${subjName}</span>
                            <span class="text-[10px] text-slate-400">${m.date}</span>
                        </div>
                        <p class="text-sm font-medium text-slate-700 dark:text-slate-200 line-clamp-2 mb-2">${m.question}</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-slate-400 truncate max-w-[70%]">${m.note || 'æ— å¤‡æ³¨'}</span>
                            <button onclick="deleteMistake(${m.id})" class="p-1 text-slate-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    `;
                    list.appendChild(div);
                });
                lucide.createIcons();
            }
        }

        function openMistakeDetail(id) {
            const m = mistakes.find(x => x.id === id);
            if(!m) return;

            const modal = document.getElementById('mistake-detail-modal');
            const content = document.getElementById('md-content');
            const analysisDiv = document.getElementById('md-analysis');
            const analysisContent = document.getElementById('md-analysis-content');

            content.innerHTML = `
                <div class="mb-4">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Question</span>
                    <p class="text-base font-medium text-slate-800 dark:text-white mt-1 whitespace-pre-wrap">${m.question}</p>
                </div>
                <div>
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">My Notes</span>
                    <p class="text-sm text-slate-600 dark:text-slate-300 mt-1 whitespace-pre-wrap">${m.note || 'æ— '}</p>
                </div>
                <button onclick="analyzeMistake(${m.id})" class="mt-4 w-full bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-300 py-2 rounded-lg text-sm font-bold hover:bg-indigo-100 transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="brain-circuit" class="w-4 h-4"></i> è®© AI æ·±åº¦åˆ†ææ­¤é¢˜
                </button>
            `;

            if(m.analysis) {
                analysisDiv.classList.remove('hidden');
                analysisContent.innerHTML = marked.parse(m.analysis);
                renderMath('md-analysis-content');
            } else {
                analysisDiv.classList.add('hidden');
                analysisContent.innerHTML = '';
            }

            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        async function analyzeMistake(id) {
            const m = mistakes.find(x => x.id === id);
            const btn = document.querySelector('#md-content button');
            const analysisDiv = document.getElementById('md-analysis');
            const analysisContent = document.getElementById('md-analysis-content');

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> åˆ†æä¸­...';
            
            analysisDiv.classList.remove('hidden');
            analysisContent.innerHTML = '<span class="animate-pulse">AI æ­£åœ¨è¯Šæ–­ä½ çš„é”™è¯¯ç‚¹...</span>';

            const prompt = `æˆ‘åšé”™äº†ä¸€é“è€ƒç ”${m.subject}é¢˜ã€‚
            é¢˜ç›®/æè¿°ï¼š${m.question}
            æˆ‘çš„å¤‡æ³¨/æƒ³æ³•ï¼š${m.note}
            è¯·å¸®æˆ‘åˆ†æï¼š
            1. **è€ƒå¯ŸçŸ¥è¯†ç‚¹**ï¼šè¿™é“é¢˜è€ƒä»€ä¹ˆï¼Ÿ
            2. **å¯èƒ½çš„æ€ç»´è¯¯åŒº**ï¼šä¸ºä»€ä¹ˆä¼šé”™ï¼Ÿ
            3. **ä¸¾ä¸€åä¸‰**ï¼šç»™å‡ºä¸€ä¸ªç±»ä¼¼çš„ç®€çŸ­ä¾‹å­æˆ–è®°å¿†å£è¯€ã€‚
            è¯·ç”¨ Markdown æ ¼å¼è¾“å‡ºï¼Œå…¬å¼ä½¿ç”¨ LaTeXæ ¼å¼ï¼ˆ$...$ï¼‰ã€‚`;

            try {
                const res = await callGemini(prompt, "tutor");
                m.analysis = res; // Save analysis
                localStorage.setItem('22408_mistakes', JSON.stringify(mistakes));
                
                analysisContent.innerHTML = marked.parse(res);
                renderMath('md-analysis-content');
                btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> åˆ†æå®Œæˆ';
            } catch(e) {
                analysisContent.innerText = "åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Keyã€‚";
                btn.disabled = false;
                btn.innerText = "é‡è¯•";
            }
        }

        // --- DOC AI LOGIC (NEW) ---
        async function processDoc() {
            const img = document.getElementById('doc-preview');
            const btn = document.getElementById('doc-btn');
            const resultArea = document.getElementById('doc-result');
            const summaryArea = document.getElementById('doc-summary');
            const textArea = document.getElementById('doc-text');

            if(!img.dataset.base64) return alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡");

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 inline"></i> æ­£åœ¨è¯†åˆ«ä¸åˆ†æ...';
            resultArea.classList.remove('hidden');
            summaryArea.innerHTML = '<span class="animate-pulse">AI æ­£åœ¨é˜…è¯»æ–‡æ¡£...</span>';
            textArea.innerHTML = '...';

            const prompt = `This is an image of a study document (notes, textbook, or exam paper).
            1. **OCR**: Transcribe the text content accurately.
            2. **Summary**: Provide a concise summary of the key points in Chinese Markdown.
            
            Output format:
            [SUMMARY_START]
            (Your summary here)
            [SUMMARY_END]
            [TEXT_START]
            (The transcribed text here)
            [TEXT_END]`;

            try {
                const res = await callGemini(prompt, "vision", [{ base64: img.dataset.base64, mimeType: img.dataset.mimeType }]);
                
                // Simple parsing
                const summaryMatch = res.match(/\[SUMMARY_START\]([\s\S]*?)\[SUMMARY_END\]/);
                const textMatch = res.match(/\[TEXT_START\]([\s\S]*?)\[TEXT_END\]/);

                const summary = summaryMatch ? summaryMatch[1].trim() : "æ— æ³•ç”Ÿæˆæ‘˜è¦";
                const fullText = textMatch ? textMatch[1].trim() : res; // Fallback to full response if format fails

                summaryArea.innerHTML = marked.parse(summary);
                textArea.innerText = fullText;
                renderMath('doc-summary');

            } catch(e) {
                summaryArea.innerText = "è¯†åˆ«å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–Keyã€‚";
            } finally {
                btn.disabled = false;
                btn.innerText = "æå–æ–‡å­— & æ‘˜è¦";
            }
        }

        function copyDocText() {
            const text = document.getElementById('doc-text').innerText;
            navigator.clipboard.writeText(text).then(() => alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼"));
        }

        // --- CODE TRANSLATOR (Updated) ---
        async function explainCode() {
            const code = document.getElementById('code-input').value.trim();
            const mode = document.getElementById('code-mode').value;
            const btn = document.getElementById('code-btn');
            const output = document.getElementById('code-output');
            const saveBtn = document.getElementById('code-save-btn');

            if(!code) return;

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> å¤„ç†ä¸­...';
            output.classList.remove('hidden');
            output.innerHTML = '<span class="animate-pulse text-blue-400">AI æ­£åœ¨å¤„ç†...</span>';

            let prompt = "";
            if (mode === 'generate') {
                prompt = `ä½ æ˜¯ä¸€ä½408è€ƒç ”ç®—æ³•ä¸“å®¶ã€‚æ ¹æ®ä»¥ä¸‹ç®—æ³•æè¿°æˆ–éœ€æ±‚ï¼Œç”Ÿæˆå®Œæ•´çš„ä»£ç æ¨¡æ¿ã€‚
                
                éœ€æ±‚æè¿°: ${code}
                
                è¯·è¾“å‡ºï¼š
                1. **ç®—æ³•æ€è·¯**: ç®€è¦è¯´æ˜ç®—æ³•æ ¸å¿ƒæ€æƒ³
                2. **C/C++ ä»£ç æ¨¡æ¿**: å®Œæ•´å¯è¿è¡Œçš„ä»£ç ï¼Œå¸¦æœ‰è¯¦ç»†æ³¨é‡Š
                3. **ä¼ªä»£ç **: è€ƒè¯•æ—¶å¯ç›´æ¥ä½¿ç”¨çš„ä¼ªä»£ç ç‰ˆæœ¬
                4. **å¤æ‚åº¦åˆ†æ**: æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦ï¼ˆä½¿ç”¨LaTeXï¼Œå¦‚ $O(n \\log n)$ï¼‰
                5. **å¸¸è§å˜å½¢**: è¯¥ç®—æ³•çš„å¸¸è§å˜ä½“æˆ–è€ƒç‚¹
                
                ä½¿ç”¨Markdownæ ¼å¼è¾“å‡ºï¼Œä»£ç ä½¿ç”¨ä»£ç å—ã€‚`;
            } else {
                prompt = `Explain this code snippet (C++/Pseudo-code/Python) for a Computer Science student.
                Code:
                ${code}
                
                Output in Chinese Markdown:
                1. **Logic**: Step-by-step explanation.
                2. **Complexity**: Time and Space complexity analysis (use LaTeX for Big O, e.g. $O(n)$).
                3. **Optimization**: Any suggestions to improve it?`;
            }

            try {
                const res = await callGemini(prompt, "tutor");
                output.innerHTML = marked.parse(res);
                renderMath('code-output');
                if(saveBtn) saveBtn.classList.remove('hidden');
                lucide.createIcons();
            } catch(e) {
                output.innerText = "å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚";
            } finally {
                btn.disabled = false;
                btn.innerText = "æ‰§è¡Œ";
            }
        }

        // --- MOCK INTERVIEW (NEW) ---
        let interviewHistory = [];

        async function startInterview() {
            const topic = document.getElementById('interview-topic').value;
            const area = document.getElementById('interview-area');
            const qDiv = document.getElementById('interview-question');
            const btn = document.getElementById('interview-start-btn');

            btn.disabled = true;
            area.classList.remove('hidden');
            qDiv.innerHTML = '<span class="animate-pulse">é¢è¯•å®˜æ­£åœ¨ç¿»é˜…ç®€å†...</span>';
            document.getElementById('interview-feedback').classList.add('hidden');
            document.getElementById('interview-answer').value = '';

            const prompt = `You are a strict interviewer for a Computer Science Master's degree admission.
            Topic: ${topic}.
            Ask me ONE challenging question about this topic. Only output the question.`;

            try {
                const res = await callGemini(prompt, "tutor");
                qDiv.innerText = res;
                interviewHistory = [{role: 'user', parts: [{text: prompt}]}, {role: 'model', parts: [{text: res}]}];
            } catch(e) {
                qDiv.innerText = "é¢è¯•å®˜æ‰çº¿äº†...";
                btn.disabled = false;
            }
        }

        async function submitInterviewAnswer() {
            const answer = document.getElementById('interview-answer').value.trim();
            const feedbackDiv = document.getElementById('interview-feedback');
            const btn = document.getElementById('interview-submit-btn');

            if(!answer) return;

            btn.disabled = true;
            btn.innerText = "é¢è¯•å®˜ç‚¹è¯„ä¸­...";
            feedbackDiv.classList.remove('hidden');
            feedbackDiv.innerHTML = '<span class="animate-pulse">æ­£åœ¨è¯„åˆ†...</span>';

            const prompt = `My answer: "${answer}".
            Please evaluate my answer in Chinese.
            1. **Score**: 1-10.
            2. **Feedback**: What was good/bad?
            3. **Better Answer**: How to answer perfectly?`;

            try {
                const res = await callGemini(prompt, "tutor"); // Context is lost in single turn, but enough for feedback
                feedbackDiv.innerHTML = marked.parse(res);
            } catch(e) {
                feedbackDiv.innerText = "ç‚¹è¯„å¤±è´¥ã€‚";
            } finally {
                btn.disabled = false;
                btn.innerText = "æäº¤å›ç­”";
                document.getElementById('interview-start-btn').disabled = false; // Allow next question
                document.getElementById('interview-start-btn').innerText = "ä¸‹ä¸€é¢˜";
            }
        }


        // --- DATA BACKUP (NEW) ---
        function exportData() {
            const data = {
                v: '30',
                date: new Date().toISOString(),
                mistakes: JSON.parse(localStorage.getItem('22408_mistakes') || '[]'),
                mainData: JSON.parse(localStorage.getItem('22408_v23_data') || '{}'),
                memo: localStorage.getItem('22408_v22_memo') || ''
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `22408_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(confirm(`ç¡®è®¤æ¢å¤ ${data.date.slice(0,10)} çš„å¤‡ä»½å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«è¦†ç›–ã€‚`)) {
                        if(data.mistakes) localStorage.setItem('22408_mistakes', JSON.stringify(data.mistakes));
                        if(data.mainData) localStorage.setItem('22408_v23_data', JSON.stringify(data.mainData));
                        if(data.memo) localStorage.setItem('22408_v22_memo', data.memo);
                        alert("æ¢å¤æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚");
                        location.reload();
                    }
                } catch(err) {
                    alert("æ–‡ä»¶æ ¼å¼é”™è¯¯");
                }
            };
            reader.readAsText(file);
            input.value = ''; // reset
        }

        // --- IMAGE HANDLING ---
        function handleGenericImageUpload(event, previewId, fileInputId) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(previewId);
                img.src = e.target.result;
                document.getElementById(previewId + '-container').classList.remove('hidden');
                
                // Store metadata
                img.dataset.base64 = e.target.result.split(',')[1];
                img.dataset.mimeType = file.type;
            };
            reader.readAsDataURL(file);
        }

        function clearGenericImage(previewId, fileInputId) {
            const img = document.getElementById(previewId);
            img.src = '';
            delete img.dataset.base64;
            delete img.dataset.mimeType;
            document.getElementById(previewId + '-container').classList.add('hidden');
            document.getElementById(fileInputId).value = '';
        }

        // --- DUCK & AI ---
        let aiMode = false;

        function changeQuote() {
            if (aiMode) return;
            const r = Math.floor(Math.random() * duckQuotes.length);
            const quoteEl = document.getElementById('duck-quote');
            if(quoteEl) quoteEl.innerText = duckQuotes[r];
        }

        async function getAIMoodMessage(mood) {
            if (aiMode) return;
            const duckQuote = document.getElementById('duck-quote');
            duckQuote.innerText = "é¸­é¸­æ­£åœ¨æ€è€ƒ... ğŸ’­";
            
            const prompts = {
                tired: "æˆ‘æ˜¯ä¸€ä¸ªå¤‡è€ƒ22408çš„è€ƒç”Ÿï¼Œç°åœ¨æ„Ÿè§‰å¾ˆç´¯ï¼Œåªå‰©28å¤©äº†ã€‚è¯·ç»™æˆ‘ä¸€å¥æ¸©æš–çš„ã€å…·ä½“çš„ä¼‘æ¯å»ºè®®å’Œé¼“åŠ±ï¼Œåƒæœ‹å‹ä¸€æ ·ã€‚ç®€çŸ­ä¸€ç‚¹ã€‚",
                anxious: "æˆ‘æ˜¯ä¸€ä¸ªå¤‡è€ƒ22408çš„è€ƒç”Ÿï¼Œç°åœ¨éå¸¸ç„¦è™‘ï¼Œè§‰å¾—å¤ä¹ ä¸å®Œäº†ã€‚è¯·æ¸©æŸ”åœ°å®‰æŠšæˆ‘ï¼Œå‘Šè¯‰æˆ‘å¤§å®¶éƒ½æ˜¯è¿™æ ·çš„ï¼Œåªè¦ç¨³ä½å°±è¡Œã€‚ç®€çŸ­ä¸€ç‚¹ã€‚",
                confident: "æˆ‘æ˜¯ä¸€ä¸ªå¤‡è€ƒ22408çš„è€ƒç”Ÿï¼Œç°åœ¨æ„Ÿè§‰çŠ¶æ€å¾ˆå¥½ï¼è¯·ç‹ ç‹ åœ°å¤¸å¥–æˆ‘ï¼Œå¹¶æé†’æˆ‘ä¿æŒè¿™ç§åŠ¿å¤´ã€‚ç®€çŸ­ä¸€ç‚¹ã€‚"
            };

            try {
                const response = await callGemini(prompts[mood], "duck");
                duckQuote.innerText = response;
                speakDuck(response);
            } catch (e) {
                duckQuote.innerText = "é¸­é¸­æ‰çº¿äº†ï¼Œä¸è¿‡æŠ±æŠ±ä½ ï¼(è¯·æ£€æŸ¥ Key è®¾ç½®)";
            }
        }

        function toggleAIMode() {
            aiMode = !aiMode;
            const quoteContainer = document.getElementById('duck-quote-container');
            const chatContainer = document.getElementById('ai-chat-container');
            const toggleBtn = document.getElementById('ai-toggle-btn');
            const moodBtns = document.getElementById('mood-buttons');

            if (aiMode) {
                quoteContainer.classList.add('hidden');
                chatContainer.classList.remove('hidden');
                moodBtns.classList.add('hidden');
                toggleBtn.innerHTML = '<i data-lucide="x" class="w-3 h-3"></i> é€€å‡ºèŠå¤©';
                toggleBtn.classList.replace('from-indigo-500', 'from-slate-500');
                toggleBtn.classList.replace('to-purple-500', 'to-slate-500');
                document.getElementById('ai-response-area').innerText = "é¸­é¸­æ­£åœ¨å¬... (è¯·é—®æˆ‘å…³äº22408çš„é—®é¢˜)";
                lucide.createIcons();
            } else {
                quoteContainer.classList.remove('hidden');
                chatContainer.classList.add('hidden');
                moodBtns.classList.remove('hidden');
                toggleBtn.innerHTML = '<i data-lucide="sparkles" class="w-3 h-3"></i> é—®é—®é¸­é¸­';
                toggleBtn.classList.replace('from-slate-500', 'from-indigo-500');
                toggleBtn.classList.replace('to-slate-500', 'to-purple-500');
                changeQuote();
                lucide.createIcons();
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') askDuck();
        }

        function triggerQuickAction(text) {
            const input = document.getElementById('ai-input');
            input.value = text;
            input.focus();
        }

        async function askDuck() {
            const input = document.getElementById('ai-input');
            const responseArea = document.getElementById('ai-response-area');
            const query = input.value.trim();
            
            if (!query) return;

            input.value = '';
            input.disabled = true;
            responseArea.innerHTML = '<span class="animate-pulse">é¸­é¸­æ€è€ƒä¸­... <i data-lucide="loader-2" class="inline w-4 h-4 animate-spin"></i></span>';
            lucide.createIcons();

            try {
                const response = await callGemini(query, "duck");
                responseArea.innerHTML = marked.parse(response);
                renderMath('ai-response-area');
                speakDuck(response);
            } catch (error) {
                responseArea.innerHTML = '<span class="text-pink-500">é¸­é¸­æ‰çº¿äº†... (è¯·åœ¨å·¦ä¸‹è§’è®¾ç½® API Key)</span>';
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        // --- TTS ---
        async function speakDuck(text) {
            const key = getUserKey();
            if (!key) return; // No TTS without key

            const txt = text || document.getElementById('duck-quote').innerText;
            if(!txt) return;
            
            const duckIconDiv = document.querySelector('div[onclick="changeQuote()"]');
            if(duckIconDiv) duckIconDiv.classList.add('animate-pulse');

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`;
            const payload = {
                contents: [{ parts: [{ text: txt }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                }
            };
            
            try {
                const response = await fetch(url, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                
                if (!response.ok) { return; }

                const data = await response.json();
                const audioData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                
                if(audioData) {
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavData = pcmToWav(pcmData, 24000);
                    const blob = new Blob([wavData], { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(blob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                }
            } catch(e) { 
                console.error(e);
            } finally {
                if(duckIconDiv) duckIconDiv.classList.remove('animate-pulse');
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes.buffer;
        }
        function pcmToWav(pcmData, sampleRate = 24000) {
            const numChannels = 1; const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * bitsPerSample / 8;
            const blockAlign = numChannels * bitsPerSample / 8;
            const wavData = new ArrayBuffer(44 + pcmData.byteLength);
            const view = new DataView(wavData);
            const writeString = (view, offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + pcmData.byteLength, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true); view.setUint16(32, blockAlign, true); view.setUint16(34, bitsPerSample, true); writeString(view, 36, 'data');
            view.setUint32(40, pcmData.byteLength, true);
            new Uint8Array(wavData, 44).set(new Uint8Array(pcmData));
            return wavData;
        }

        // --- AI VISION ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('vision-preview');
                img.src = e.target.result;
                document.getElementById('vision-preview-container').classList.remove('hidden');
                
                img.dataset.base64 = e.target.result.split(',')[1];
                img.dataset.mimeType = file.type;
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            const img = document.getElementById('vision-preview');
            img.src = '';
            delete img.dataset.base64;
            delete img.dataset.mimeType;
            document.getElementById('vision-preview-container').classList.add('hidden');
            document.getElementById('vision-file').value = '';
            document.getElementById('vision-output').classList.add('hidden');
        }

        async function analyzeImage() {
            const img = document.getElementById('vision-preview');
            const base64 = img.dataset.base64;
            const mimeType = img.dataset.mimeType;
            const textInput = document.getElementById('vision-text-input').value.trim();
            const output = document.getElementById('vision-output');
            const btn = document.getElementById('vision-btn');
            const saveBtn = document.getElementById('vision-save-btn');

            if (!base64 && !textInput) {
                alert("è¯·ä¸Šä¼ å›¾ç‰‡æˆ–è¾“å…¥é—®é¢˜ï¼");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 inline"></i> AI æ­£åœ¨åˆ†æ...';
            output.classList.remove('hidden');
            output.innerHTML = '<span class="animate-pulse text-indigo-500">æ­£åœ¨åˆ†æå†…å®¹...</span>';
            
            let prompt = "";
            if (base64 && textInput) {
                // Both image and text
                prompt = `You are a tutor for the Chinese Postgraduate Entrance Exam (22408).
                User's question: "${textInput}"
                
                Please analyze the image in context of the user's question.
                1. Identify the subject (Math, English, Politics, or CS 408).
                2. Provide a detailed solution or explanation in Chinese.
                3. Use LaTeX for math formulas (e.g., $x^2$, $$\\sum_{i=1}^n$$).
                4. Use Markdown formatting.`;
            } else if (base64) {
                // Image only
                prompt = `You are a tutor for the Chinese Postgraduate Entrance Exam (22408). 
                1. Identify the subject of this image (Math, English, Politics, or CS 408).
                2. If it's text, transcribe it.
                3. Provide a detailed solution or explanation in Chinese.
                4. Use LaTeX for math formulas (e.g., $x^2$, $$\\sum_{i=1}^n$$).`;
            } else {
                // Text only
                prompt = `You are a tutor for the Chinese Postgraduate Entrance Exam (22408).
                User's question: "${textInput}"
                
                Please provide a detailed answer in Chinese.
                1. Identify the subject area.
                2. Give a comprehensive explanation.
                3. Use LaTeX for math formulas (e.g., $x^2$, $$\\sum_{i=1}^n$$).
                4. Use Markdown formatting.`;
            }

            try {
                const images = base64 ? [{ base64: base64, mimeType: mimeType }] : null;
                const response = await callGemini(prompt, "vision", images);
                output.innerHTML = marked.parse(response);
                renderMath('vision-output');
                if(saveBtn) saveBtn.classList.remove('hidden');
                lucide.createIcons();
            } catch (e) {
                output.innerHTML = "è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key è®¾ç½®ã€‚";
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.innerText = "å¼€å§‹è§£æ";
            }
        }

        // --- AI QUIZ & CONCEPT & SENTENCE & MEMORY ---
        function renderMath(elementId) {
            const element = document.getElementById(elementId);
            if(element) {
                renderMathInElement(element, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }
        }

        async function explainConcept() {
            const input = document.getElementById('concept-input');
            const btn = document.getElementById('concept-btn');
            const output = document.getElementById('concept-output');
            const saveBtn = document.getElementById('concept-save-btn');
            const topic = input.value.trim();

            if (!topic) return;

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>';
            output.classList.remove('hidden');
            output.innerHTML = '<span class="animate-pulse text-purple-500">ç”Ÿæˆæ¦‚å¿µå¡ç‰‡ä¸­...</span>';
            lucide.createIcons();

            const prompt = `You are a tutor for the 22408 Computer Science Master's exam. Explain the concept "${topic}". 
            Generate a structured summary in Markdown with these exact sections:
            **æ ¸å¿ƒå®šä¹‰**: 1 sentence.
            **å…³é”®å£è¯€/å…¬å¼**: Short and memorable. Use standard LaTeX for math (e.g., $O(n)$, $$E=mc^2$$).
            **é¿å‘æŒ‡å—**: What to watch out for in exams.
            **å¸¸è€ƒé¢˜å‹**: Common exam question types related to this concept.
            Keep it concise and use Chinese.`;

            try {
                const response = await callGemini(prompt, "tutor");
                output.innerHTML = marked.parse(response);
                renderMath('concept-output');
                if(saveBtn) saveBtn.classList.remove('hidden');
                lucide.createIcons();
            } catch (e) {
                output.innerHTML = "ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key è®¾ç½®ã€‚";
            } finally {
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆå¡ç‰‡";
            }
        }

        async function breakSentence() {
            const input = document.getElementById('sentence-input');
            const img = document.getElementById('sentence-preview');
            const btn = document.getElementById('sentence-btn');
            const output = document.getElementById('sentence-output');
            const saveBtn = document.getElementById('sentence-save-btn');
            const text = input.value.trim();
            const hasImage = img && img.dataset.base64;

            if (!text && !hasImage) {
                alert("è¯·è¾“å…¥å¥å­æˆ–ä¸Šä¼ å›¾ç‰‡ï¼");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> æ‹†è§£ä¸­...';
            output.classList.remove('hidden');
            output.innerHTML = '<span class="animate-pulse text-indigo-500">AI æ­£åœ¨åˆ†æå¥å­ç»“æ„...</span>';
            
            let prompt = "";
            if (hasImage && text) {
                prompt = `Analyze the English sentence in the image, with additional context: "${text}".
                This is for a Chinese student preparing for the Postgraduate Entrance Exam (English II).
                
                Output in Markdown:
                1. **Transcription**: First transcribe the sentence from the image.
                2. **Translation**: Natural Chinese translation.
                3. **Structure**: Break down the grammar (Subject, Verb, Object, Clauses). Use brackets to show structure.
                4. **Keywords**: 3-5 key words with meanings.
                5. **Difficulty Points**: What makes this sentence hard to understand?`;
            } else if (hasImage) {
                prompt = `Analyze the English sentence in this image for a Chinese student preparing for the Postgraduate Entrance Exam (English II).
                
                Output in Markdown:
                1. **Transcription**: First transcribe the sentence from the image.
                2. **Translation**: Natural Chinese translation.
                3. **Structure**: Break down the grammar (Subject, Verb, Object, Clauses). Use brackets to show structure.
                4. **Keywords**: 3-5 key words with meanings.
                5. **Difficulty Points**: What makes this sentence hard to understand?`;
            } else {
                prompt = `Analyze this English sentence for a Chinese student preparing for the Postgraduate Entrance Exam (English II).
                Sentence: "${text}"
                
                Output in Markdown:
                1. **Translation**: Natural Chinese translation.
                2. **Structure**: Break down the grammar (Subject, Verb, Object, Clauses). Use brackets to show structure.
                3. **Keywords**: 3-5 key words with meanings.
                4. **Difficulty Points**: What makes this sentence hard to understand?`;
            }

            try {
                const images = hasImage ? [{ base64: img.dataset.base64, mimeType: img.dataset.mimeType }] : null;
                const response = await callGemini(prompt, "tutor", images);
                output.innerHTML = marked.parse(response);
                renderMath('sentence-output');
                if(saveBtn) saveBtn.classList.remove('hidden');
                lucide.createIcons();
            } catch (e) {
                output.innerHTML = "åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key è®¾ç½®ã€‚";
            } finally {
                btn.disabled = false;
                btn.innerText = "ä¸€é”®æ‹†è§£";
            }
        }

        async function generateMnemonic() {
            const input = document.getElementById('memory-input');
            const btn = document.getElementById('memory-btn');
            const output = document.getElementById('memory-output');
            const saveBtn = document.getElementById('memory-save-btn');
            const text = input.value.trim();

            if (!text) return;

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> å»ºé€ ä¸­...';
            output.classList.remove('hidden');
            output.innerHTML = '<span class="animate-pulse text-indigo-500">AI æ­£åœ¨æ„å»ºè®°å¿†å®«æ®¿...</span>';
            
            const prompt = `Create a vivid, memorable mnemonic or 'Memory Palace' story to help remember the following concept or list for the Chinese Postgraduate Entrance Exam (Politics/408).
            Input: "${text}"
            
            Output in Markdown (Chinese):
            1. **The Mnemonic**: A catchy phrase or funny story.
            2. **Explanation**: How it maps to the original points.
            3. **Visual Association**: Create a mental image to remember.`;

            try {
                const response = await callGemini(prompt, "tutor");
                output.innerHTML = marked.parse(response);
                renderMath('memory-output');
                if(saveBtn) saveBtn.classList.remove('hidden');
                lucide.createIcons();
            } catch (e) {
                output.innerHTML = "ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key è®¾ç½®ã€‚";
            } finally {
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆè®°å¿†å®«æ®¿";
            }
        }

        async function generateQuiz() {
            const subject = document.getElementById('quiz-subject').value;
            const container = document.getElementById('quiz-output-area');
            const questionEl = document.getElementById('quiz-question');
            const answerEl = document.getElementById('quiz-answer');
            const btn = document.getElementById('quiz-btn');

            btn.disabled = true;
            btn.innerText = "ç”Ÿæˆä¸­...";
            container.classList.remove('hidden');
            questionEl.innerHTML = '<span class="animate-pulse">æ­£åœ¨ä»é¢˜åº“æå–...</span>';
            answerEl.classList.add('hidden');
            answerEl.innerHTML = '';

            const prompt = `Generate a specific practice question for the Chinese Graduate Entrance Exam subject: ${subject}. 
            Format exactly as follows with newlines:
            
            **Question**: 
            [The Question content]
            
            **Options** (if applicable):
            A. ...
            B. ...
            C. ...
            D. ...
            
            |||
            
            **Answer**: [The correct answer]
            
            **Analysis**: 
            [Short explanation in Chinese. Use LaTeX for math formulas like $x^2$ or $$O(n \log n)$$]
            
            Use the separator "|||" strictly to separate question and answer. Add plenty of newlines for readability.`;

            try {
                const response = await callGemini(prompt, "tutor");
                const parts = response.split('|||');
                questionEl.innerHTML = marked.parse(parts[0]);
                renderMath('quiz-question');
                
                if (parts[1]) {
                    answerEl.innerHTML = marked.parse(parts[1]);
                    renderMath('quiz-answer'); 
                } else {
                    answerEl.innerText = "è§£æç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚";
                }
            } catch (e) {
                questionEl.innerText = "ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– API Keyã€‚";
            } finally {
                btn.disabled = false;
                btn.innerText = "å‡ºé¢˜";
            }
        }

        // --- AI GRADER (V2.0: Updated Logic) ---
        async function gradeEssay(type) {
            // type: 'english' or 'politics'
            const isEng = type === 'english';
            const imgId = isEng ? 'eng-preview' : 'pol-preview';
            const btnId = isEng ? 'eng-grade-btn' : 'pol-grade-btn';
            const resId = isEng ? 'eng-result' : 'pol-result';
            const saveId = isEng ? 'eng-save-btn' : 'pol-save-btn';
            const qInput = !isEng ? document.getElementById('pol-q-input').value : "";

            const img = document.getElementById(imgId);
            const btn = document.getElementById(btnId);
            const out = document.getElementById(resId);
            const saveBtn = document.getElementById(saveId);

            if(!img.dataset.base64 && !qInput) return alert("è¯·ä¸Šä¼ å›¾ç‰‡æˆ–è¾“å…¥é¢˜ç›®å…³é”®è¯ï¼");

            btn.disabled = true; btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 inline"></i> AI é˜…å·ä¸­...';
            out.classList.remove('hidden'); out.innerHTML = '<span class="animate-pulse">AI æ­£åœ¨è¾¨è®¤å­—è¿¹ã€æ¯”å¯¹é‡‡åˆ†ç‚¹...</span>';

            let prompt = "";
            if (isEng) {
                prompt = `Analyze this handwritten English essay image.
                1. **Handwriting Analysis**: Give a neatness score (0-5) and comment on legibility.
                2. **Content Grading**: Check grammar, vocabulary, and logic.
                3. **Strict Score**: Give a score out of 25 based on Exam standards.
                4. **Advice**: How to improve.
                Output in Chinese Markdown. Use LaTeX for any formulas.`;
            } else {
                prompt = `ä½ æ˜¯ä¸€ä½è€ƒç ”æ”¿æ²»é˜…å·ä¸“å®¶ã€‚
                é¢˜ç›®/å…³é”®è¯: "${qInput}"
                ${img.dataset.base64 ? 'è¯·åˆ†æå›¾ç‰‡ä¸­çš„æ‰‹å†™ç­”æ¡ˆã€‚' : ''}
                
                è¯·å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š
                1. **å·é¢åˆ†æ**: å¦‚æœæœ‰å›¾ç‰‡ï¼Œè¯„ä¼°å­—è¿¹å·¥æ•´åº¦(0-5åˆ†)ã€‚
                2. **é‡‡åˆ†ç‚¹æ£€æŸ¥**: åˆ—å‡ºè¯¥é¢˜ç›®åº”è¯¥åŒ…å«çš„å…³é”®é‡‡åˆ†ç‚¹ï¼ˆå‚è€ƒè‚–å››æ ‡å‡†ç­”æ¡ˆï¼‰ã€‚
                3. **ç­”æ¡ˆè¯„ä¼°**: å¦‚æœæœ‰ç­”æ¡ˆå›¾ç‰‡ï¼Œé€ç‚¹åˆ†ææ˜¯å¦è¸©ä¸­é‡‡åˆ†ç‚¹ã€‚
                4. **æ ‡å‡†ç­”æ¡ˆæ¨¡æ¿**: æ ¹æ®é¢˜ç›®å…³é”®è¯ï¼Œç”Ÿæˆä¸€ä»½æ ‡å‡†ç­”æ¡ˆæ¨¡æ¿ï¼ŒåŒ…å«ï¼š
                   - åŸç†é˜è¿°ï¼ˆé©¬åŸ/æ¯›ä¸­ç‰¹/å²çº²/æ€ä¿®ç›¸å…³åŸç†ï¼‰
                   - ç»“åˆææ–™åˆ†æ
                   - æ€»ç»“å‡å
                5. **å¾—åˆ†é¢„ä¼°**: é¢„ä¼°å¾—åˆ† /10 åˆ†ã€‚
                
                è¯·ä½¿ç”¨Markdownæ ¼å¼è¾“å‡ºï¼Œå…¬å¼ä½¿ç”¨LaTeXï¼ˆ$...$ï¼‰ã€‚`;
            }

            try {
                const images = img.dataset.base64 ? [{ base64: img.dataset.base64, mimeType: img.dataset.mimeType }] : null;
                const res = await callGemini(prompt, "grader", images);
                out.innerHTML = marked.parse(res);
                renderMath(resId);
                if(saveBtn) saveBtn.classList.remove('hidden');
                lucide.createIcons();
            } catch(e) { out.innerText = "é˜…å·å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key è®¾ç½®ã€‚"; }
            finally { btn.disabled = false; btn.innerText = isEng ? "å¼€å§‹æ®‹é…·é˜…å·" : "åˆ†æé‡‡åˆ†ç‚¹ & ç”Ÿæˆç­”æ¡ˆæ¨¡æ¿"; }
        }

        // --- DUAL IMAGE TRANSLATION (NEW) ---
        async function gradeTranslation() {
            const srcImg = document.getElementById('trans-source-preview');
            const tgtImg = document.getElementById('trans-target-preview');
            const btn = document.getElementById('trans-grade-btn');
            const out = document.getElementById('trans-result');

            if(!srcImg.dataset.base64 || !tgtImg.dataset.base64) return alert("è¯·ä¸Šä¼ å…¨éƒ¨ä¸¤å¼ å›¾ç‰‡ï¼ˆåŸæ–‡+è¯‘æ–‡ï¼‰");

            btn.disabled = true; btn.innerText = "åŒæµæ¯”å¯¹ä¸­...";
            out.classList.remove('hidden'); out.innerHTML = '<span class="animate-pulse">AI æ­£åœ¨å·¦å³å¯¹ç…§åŸæ–‡ä¸ä½ çš„æ‰‹å†™è¯‘æ–‡...</span>';

            const prompt = `Perform a dual-image analysis for English II Translation.
            Image 1 is the [Source English Text].
            Image 2 is the [Student's Handwritten Chinese Translation].
            
            Task:
            1. Transcribe the student's handwriting.
            2. Compare with the source text.
            3. Identify **Missing Info** (æ¼è¯‘), **Mistranslations** (è¯¯è¯‘), and **Chinglish** (ç¿»è¯‘è…”).
            4. Provide the standard translation.
            5. Score out of 15.`;

            const images = [
                { base64: srcImg.dataset.base64, mimeType: srcImg.dataset.mimeType },
                { base64: tgtImg.dataset.base64, mimeType: tgtImg.dataset.mimeType }
            ];

            try {
                const res = await callGemini(prompt, "grader", images);
                out.innerHTML = marked.parse(res);
                renderMath('trans-result');
                document.getElementById('trans-save-btn').classList.remove('hidden');
                lucide.createIcons();
            } catch(e) { out.innerText = "æ¯”å¯¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key è®¾ç½®ã€‚"; }
            finally { btn.disabled = false; btn.innerText = "å¼€å§‹åŒå›¾å¯¹ç…§æ‰¹æ”¹"; }
        }

        // --- 408 CS LARGE QUESTION GRADER (NEW) ---
        async function gradeCS408() {
            const type = document.getElementById('cs408-type').value;
            const qInput = document.getElementById('cs408-q-input').value.trim();
            const img = document.getElementById('cs408-preview');
            const btn = document.getElementById('cs408-grade-btn');
            const out = document.getElementById('cs408-result');
            const saveBtn = document.getElementById('cs408-save-btn');

            const typeNames = { ds: 'æ•°æ®ç»“æ„', os: 'æ“ä½œç³»ç»Ÿ', cn: 'è®¡ç®—æœºç½‘ç»œ', co: 'è®¡ç®—æœºç»„æˆåŸç†' };

            if(!img.dataset.base64 && !qInput) return alert("è¯·ä¸Šä¼ ç­”æ¡ˆå›¾ç‰‡æˆ–è¾“å…¥é¢˜ç›®æè¿°ï¼");

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 inline"></i> AI é˜…å·ä¸­...';
            out.classList.remove('hidden');
            out.innerHTML = '<span class="animate-pulse">AI æ­£åœ¨åˆ†æ408å¤§é¢˜ç­”æ¡ˆ...</span>';

            const prompt = `ä½ æ˜¯ä¸€ä½408è€ƒç ”é˜…å·ä¸“å®¶ï¼Œä¸“æ”»${typeNames[type]}ã€‚
            
            é¢˜ç›®æè¿°/å…³é”®è¯: "${qInput}"
            ${img.dataset.base64 ? 'è¯·åˆ†æå›¾ç‰‡ä¸­çš„æ‰‹å†™ç­”æ¡ˆã€‚' : ''}
            
            è¯·å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š
            1. **é¢˜ç›®åˆ†æ**: è¯†åˆ«è¿™æ˜¯ä»€ä¹ˆç±»å‹çš„é¢˜ç›®ï¼ˆç®—æ³•è®¾è®¡/è®¡ç®—é¢˜/æ¦‚å¿µåˆ†æ/ç»¼åˆåº”ç”¨ï¼‰
            2. **é‡‡åˆ†ç‚¹åˆ—è¡¨**: åˆ—å‡ºè¯¥é¢˜ç›®çš„å…³é”®é‡‡åˆ†ç‚¹ï¼ˆæ¯ä¸ªé‡‡åˆ†ç‚¹æ ‡æ³¨åˆ†å€¼ï¼‰
            3. **ç­”æ¡ˆè¯„ä¼°**: ${img.dataset.base64 ? 'é€ç‚¹åˆ†æç­”æ¡ˆæ˜¯å¦æ­£ç¡®ï¼Œæ ‡æ³¨å¾—åˆ†æƒ…å†µ' : 'è·³è¿‡æ­¤æ­¥éª¤'}
            4. **æ ‡å‡†ç­”æ¡ˆæ¨¡æ¿**: ç”Ÿæˆå®Œæ•´çš„æ ‡å‡†ç­”æ¡ˆï¼ŒåŒ…å«ï¼š
               - è§£é¢˜æ€è·¯
               - è¯¦ç»†æ­¥éª¤ï¼ˆå¦‚éœ€ä»£ç ï¼Œæä¾›ä¼ªä»£ç ï¼‰
               - å…³é”®å…¬å¼ï¼ˆä½¿ç”¨LaTeXï¼Œå¦‚ $O(n \\log n)$ï¼‰
               - ç­”æ¡ˆè¦ç‚¹
            5. **å¸¸è§é”™è¯¯**: åˆ—å‡ºè¯¥ç±»é¢˜ç›®çš„å¸¸è§é”™è¯¯å’Œæ³¨æ„äº‹é¡¹
            6. **å¾—åˆ†é¢„ä¼°**: ${img.dataset.base64 ? 'é¢„ä¼°å¾—åˆ†' : 'æ»¡åˆ†å‚è€ƒ'}
            
            ä½¿ç”¨Markdownæ ¼å¼è¾“å‡ºï¼Œä»£ç ä½¿ç”¨ä»£ç å—ï¼Œå…¬å¼ä½¿ç”¨LaTeXã€‚`;

            try {
                const images = img.dataset.base64 ? [{ base64: img.dataset.base64, mimeType: img.dataset.mimeType }] : null;
                const res = await callGemini(prompt, "grader", images);
                out.innerHTML = marked.parse(res);
                renderMath('cs408-result');
                if(saveBtn) saveBtn.classList.remove('hidden');
                lucide.createIcons();
            } catch(e) {
                out.innerText = "åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key è®¾ç½®ã€‚";
            } finally {
                btn.disabled = false;
                btn.innerText = "åˆ†æ408å¤§é¢˜ & ç”Ÿæˆæ ‡å‡†ç­”æ¡ˆ";
            }
        }

        // --- ENGLISH BIG ESSAY (NEW) ---
        async function generateBigEssay() {
            const topic = document.getElementById('bigessay-input').value.trim();
            const btn = document.getElementById('bigessay-btn');
            const output = document.getElementById('bigessay-output');
            const saveBtn = document.getElementById('bigessay-save-btn');

            if(!topic) return alert("è¯·è¾“å…¥ä½œæ–‡ä¸»é¢˜å…³é”®è¯ï¼");

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> ç”Ÿæˆä¸­...';
            output.classList.remove('hidden');
            output.innerHTML = '<span class="animate-pulse">AI æ­£åœ¨ç”Ÿæˆå¤§ä½œæ–‡æ¨¡æ¿...</span>';

            const prompt = `ä½ æ˜¯ä¸€ä½è‹±è¯­äºŒè€ƒç ”ä½œæ–‡ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¸»é¢˜ç”Ÿæˆä¸€ä»½å®Œæ•´çš„å¤§ä½œæ–‡ï¼ˆå›¾è¡¨ä½œæ–‡ï¼‰å†™ä½œæ¨¡æ¿ã€‚
            
            ä¸»é¢˜å…³é”®è¯: "${topic}"
            
            è¯·ç”Ÿæˆï¼š
            
            ## ä¸€ã€ä½œæ–‡æ¨¡æ¿
            
            ### ç¬¬ä¸€æ®µï¼šæè¿°å›¾è¡¨ï¼ˆçº¦50è¯ï¼‰
            - å¼€å¤´å¥æ¨¡æ¿
            - æ•°æ®æè¿°å¥å‹
            - è¶‹åŠ¿æ€»ç»“å¥
            
            ### ç¬¬äºŒæ®µï¼šåŸå› åˆ†æï¼ˆçº¦80è¯ï¼‰
            - è¿‡æ¸¡å¥
            - åŸå› ä¸€ï¼ˆé™„ä¾‹å¥ï¼‰
            - åŸå› äºŒï¼ˆé™„ä¾‹å¥ï¼‰
            - åŸå› ä¸‰ï¼ˆé™„ä¾‹å¥ï¼‰
            
            ### ç¬¬ä¸‰æ®µï¼šæ€»ç»“å»ºè®®ï¼ˆçº¦50è¯ï¼‰
            - æ€»ç»“å¥å‹
            - å»ºè®®/å±•æœ›å¥å‹
            - ç»“å°¾å‡åå¥
            
            ## äºŒã€é«˜é¢‘è¯æ±‡ä¸çŸ­è¯­
            åˆ—å‡º10ä¸ªä¸"${topic}"ç›¸å…³çš„é«˜é¢‘è¯æ±‡å’ŒçŸ­è¯­ï¼Œé™„ä¸­æ–‡é‡Šä¹‰
            
            ## ä¸‰ã€é«˜åˆ†å¥å‹
            æä¾›5ä¸ªå¯ç›´æ¥å¥—ç”¨çš„é«˜åˆ†å¥å‹ï¼Œæ ‡æ³¨é€‚ç”¨åœºæ™¯
            
            ## å››ã€å†™ä½œæŠ€å·§
            - æ³¨æ„äº‹é¡¹
            - å¸¸è§é”™è¯¯
            - å¾—åˆ†è¦ç‚¹
            
            ä½¿ç”¨Markdownæ ¼å¼ï¼Œè‹±æ–‡éƒ¨åˆ†ä¿æŒåŸæ–‡ã€‚`;

            try {
                const res = await callGemini(prompt, "tutor");
                output.innerHTML = marked.parse(res);
                renderMath('bigessay-output');
                if(saveBtn) saveBtn.classList.remove('hidden');
                lucide.createIcons();
            } catch(e) {
                output.innerText = "ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚";
            } finally {
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆæ¨¡æ¿";
            }
        }

        // --- ENGLISH SMALL ESSAY (NEW) ---
        async function generateSmallEssay() {
            const type = document.getElementById('smallessay-type').value;
            const topic = document.getElementById('smallessay-input').value.trim();
            const btn = document.getElementById('smallessay-btn');
            const output = document.getElementById('smallessay-output');
            const saveBtn = document.getElementById('smallessay-save-btn');

            const typeNames = { letter: 'ä¹¦ä¿¡', notice: 'é€šçŸ¥', email: 'é‚®ä»¶', memo: 'å¤‡å¿˜å½•', report: 'æŠ¥å‘Š' };

            if(!topic) return alert("è¯·è¾“å…¥å°ä½œæ–‡ä¸»é¢˜ï¼");

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> ç”Ÿæˆä¸­...';
            output.classList.remove('hidden');
            output.innerHTML = '<span class="animate-pulse">AI æ­£åœ¨ç”Ÿæˆå°ä½œæ–‡æ¨¡æ¿...</span>';

            const prompt = `ä½ æ˜¯ä¸€ä½è‹±è¯­äºŒè€ƒç ”åº”ç”¨æ–‡ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹ç±»å‹å’Œä¸»é¢˜ç”Ÿæˆä¸€ä»½å®Œæ•´çš„å°ä½œæ–‡æ¨¡æ¿ã€‚
            
            åº”ç”¨æ–‡ç±»å‹: ${typeNames[type]}
            ä¸»é¢˜: "${topic}"
            
            è¯·ç”Ÿæˆï¼š
            
            ## ä¸€ã€æ ¼å¼è¦æ±‚
            - ${typeNames[type]}çš„æ ‡å‡†æ ¼å¼è¯´æ˜
            - ç§°å‘¼ã€æ­£æ–‡ã€è½æ¬¾çš„å†™æ³•
            
            ## äºŒã€å®Œæ•´èŒƒæ–‡æ¨¡æ¿
            æä¾›ä¸€ç¯‡100è¯å·¦å³çš„å®Œæ•´èŒƒæ–‡ï¼Œå¸¦æœ‰å¯æ›¿æ¢çš„ã€ã€‘æ ‡è®°
            
            ## ä¸‰ã€å¼€å¤´å¥å‹ï¼ˆ3-5ä¸ªï¼‰
            é’ˆå¯¹${typeNames[type]}çš„ä¸‡èƒ½å¼€å¤´å¥
            
            ## å››ã€æ­£æ–‡å¸¸ç”¨è¡¨è¾¾
            - è¡¨ç¤ºç›®çš„çš„å¥å‹
            - è¡¨ç¤ºå»ºè®®çš„å¥å‹
            - è¡¨ç¤ºæ„Ÿè°¢/é“æ­‰çš„å¥å‹
            - è¡¨ç¤ºæœŸå¾…å›å¤çš„å¥å‹
            
            ## äº”ã€ç»“å°¾å¥å‹ï¼ˆ3-5ä¸ªï¼‰
            é’ˆå¯¹${typeNames[type]}çš„ä¸‡èƒ½ç»“å°¾å¥
            
            ## å…­ã€æ³¨æ„äº‹é¡¹
            - æ ¼å¼æ‰£åˆ†ç‚¹
            - å¸¸è§é”™è¯¯
            - å­—æ•°æ§åˆ¶æŠ€å·§
            
            ä½¿ç”¨Markdownæ ¼å¼ï¼Œè‹±æ–‡éƒ¨åˆ†ä¿æŒåŸæ–‡ã€‚`;

            try {
                const res = await callGemini(prompt, "tutor");
                output.innerHTML = marked.parse(res);
                renderMath('smallessay-output');
                if(saveBtn) saveBtn.classList.remove('hidden');
                lucide.createIcons();
            } catch(e) {
                output.innerText = "ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚";
            } finally {
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆæ¨¡æ¿";
            }
        }

        // --- SAVE TO NOTEBOOK FUNCTION (NEW) ---
        function saveToNotebook(subject, outputId) {
            const output = document.getElementById(outputId);
            if(!output || !output.innerHTML) return alert("æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹ï¼");

            const content = output.innerText || output.textContent;
            const truncatedContent = content.substring(0, 500) + (content.length > 500 ? '...' : '');

            const newMistake = {
                id: Date.now(),
                subject: subject,
                question: `[AIç”Ÿæˆå†…å®¹] ${truncatedContent.substring(0, 100)}...`,
                note: truncatedContent,
                date: new Date().toLocaleDateString(),
                analysis: output.innerHTML
            };

            mistakes.unshift(newMistake);
            localStorage.setItem('22408_mistakes', JSON.stringify(mistakes));
            
            alert("å·²ä¿å­˜åˆ°é”™é¢˜æœ¬ï¼å¯åœ¨"æ™ºèƒ½é”™é¢˜æœ¬"ä¸­æŸ¥çœ‹ã€‚");
            lucide.createIcons();
        }

        async function generateDailyReport() {
            const reportBtn = document.getElementById('report-btn');
            const reportArea = document.getElementById('report-area');
            
            const tasks = [
                { id: 't1', name: 'æ—©èµ·èƒŒè¯µ', done: document.getElementById('t1').checked },
                { id: 't2', name: 'æ•°å­¦æ¨¡è€ƒ', done: document.getElementById('t2').checked },
                { id: 't3', name: 'åˆä¼‘', done: document.getElementById('t3').checked },
                { id: 't4', name: '408/è‹±è¯­', done: document.getElementById('t4').checked },
                { id: 't5', name: 'æ™šé—´å¤ç›˜', done: document.getElementById('t5').checked },
                { id: 't6', name: 'æ—©ç¡', done: document.getElementById('t6').checked }
            ];
            
            const doneTasks = tasks.filter(t => t.done).map(t => t.name).join('ã€');
            const pendingTasks = tasks.filter(t => !t.done).map(t => t.name).join('ã€');
            
            const prompt = `æˆ‘ä»Šå¤©å®Œæˆäº†ä»¥ä¸‹ä»»åŠ¡ï¼š${doneTasks || 'æ— '}ã€‚è¿˜æœ‰è¿™äº›æ²¡åšï¼š${pendingTasks || 'æ— '}ã€‚è¯·æ ¹æ®æˆ‘çš„å®Œæˆæƒ…å†µï¼Œä»¥â€œå¤‡è€ƒæ•™ç»ƒâ€çš„èº«ä»½ï¼Œç»™æˆ‘å†™ä¸€æ®µ150å­—ä»¥å†…çš„â€œä»Šæ—¥æˆ˜æŠ¥â€ã€‚
            è¦æ±‚ï¼š
            1. å¦‚æœå®Œæˆåº¦é«˜ï¼Œç‹ ç‹ å¤¸æˆ‘ã€‚
            2. å¦‚æœå®Œæˆåº¦ä½ï¼Œæ¸©æŸ”åœ°é¼“åŠ±æˆ‘ï¼Œå‘Šè¯‰æˆ‘ä¸æ€•æ…¢åªæ€•ç«™ã€‚
            3. ç»™å‡ºä¸€æ¡å…·ä½“çš„æ˜å¤©å¤ä¹ å»ºè®®ï¼ˆé’ˆå¯¹22408è€ƒç ”ï¼‰ã€‚
            4. ä½¿ç”¨Markdownæ ¼å¼ï¼Œå¤šç”¨emojiã€‚`;

            reportBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> ç”Ÿæˆä¸­...';
            reportArea.classList.remove('hidden');
            
            try {
                const response = await callGemini(prompt, "coach");
                reportArea.innerHTML = marked.parse(response);
                reportBtn.innerHTML = 'âœ¨ é‡æ–°ç”Ÿæˆæˆ˜æŠ¥';
            } catch (e) {
                reportArea.innerHTML = "ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Keyã€‚";
                reportBtn.innerHTML = 'âœ¨ ç”Ÿæˆä»Šæ—¥æˆ˜æŠ¥';
            }
        }

        async function callGemini(userQuery, persona, imageData = null, legacyMime = null) {
            const userKey = getUserKey();
            if (!userKey) {
                toggleKeyModal(); // Show modal if key is missing
                throw new Error("Missing API Key");
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey}`;
            
            let systemPrompt = "ä½ æ˜¯è€ƒç ”å¤‡è€ƒå°çªçš„æ™ºèƒ½åŠ©æ‰‹ã€‚";
            if(persona === "duck") {
                systemPrompt += "ä½ çš„è¯´è¯é£æ ¼è¦å¯çˆ±ã€æ²»æ„ˆã€å¹½é»˜ï¼ˆå¶å°”å¸¦ç‚¹'å˜'ï¼‰ã€‚ä½ çš„ä¸»è¦ä»»åŠ¡æ˜¯é¼“åŠ±æ­£åœ¨å¤‡è€ƒ22408çš„è€ƒç”Ÿã€‚è¯·ä¿æŒå›å¤ç®€çŸ­ç²¾ç‚¼ï¼ˆ150å­—ä»¥å†…ï¼‰ï¼Œå¤šç”¨emojiã€‚";
            } else if (persona === "tutor") {
                systemPrompt += "You are a professional Chinese Graduate Entrance Exam tutor. Output strictly in Chinese. IMPORTANT: Use standard LaTeX format for math expressions. Use single $ for inline math (e.g. $a+b$) and double $$ for display math (e.g. $$a+b$$). Do NOT use code blocks for math.";
            } else if (persona === "coach") {
                systemPrompt += "ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„è€ƒç ”æ•™ç»ƒï¼Œè¯´è¯é£æ ¼ä¸“ä¸šã€åšå®šä½†å……æ»¡é¼“åŠ±ã€‚";
            } else if (persona === "vision") {
                systemPrompt += "You are an expert tutor who can analyze images of study materials (handwritten or printed) and explain them clearly in Chinese.";
            } else if (persona === "grader") {
                systemPrompt += "You are a strict grader for the Chinese Postgraduate Entrance Exam. Analyze handwriting, logic, and content. Output in Chinese Markdown. IMPORTANT: Use standard LaTeX format for math expressions. Use single $ for inline math (e.g. $a+b$) and double $$ for display math (e.g. $$a+b$$).";
            }

            const parts = [{ text: userQuery }];
            
            // Flexible Image Handling
            let images = [];
            
            if (Array.isArray(imageData)) {
                images = imageData;
            } else if (imageData && typeof imageData === 'object' && imageData.base64) {
                images = [imageData];
            } else if (imageData && typeof imageData === 'string') {
                images = [{ base64: imageData, mimeType: legacyMime }];
            }

            // Append images to parts
            images.forEach(img => {
                if (img.base64 && img.mimeType) {
                    parts.push({ inlineData: { mimeType: img.mimeType, data: img.base64 } });
                }
            });

            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "é¸­é¸­æ²¡å¬æ¸…ï¼Œå†è¯´ä¸€éï¼Ÿ";
            } catch (e) {
                throw e;
            }
        }

        // --- GREETING ---
        function setGreeting() {
            const h = new Date().getHours();
            let t = "æ™šä¸Šå¥½ ğŸŒ™";
            let s = "ä»Šå¤©ä¹Ÿæ˜¯å……å®çš„ä¸€å¤©ã€‚";
            if(h<12) { t="æ—©ä¸Šå¥½ â˜€ï¸"; s="æ–°çš„å¼€å§‹ï¼Œå…ƒæ°”æ»¡æ»¡ï¼"; }
            else if(h<18) { t="ä¸‹åˆå¥½ â˜•ï¸"; s="åšæŒå°±æ˜¯èƒœåˆ©ã€‚"; }
            
            const titleEl = document.getElementById('greeting-title');
            const subEl = document.getElementById('greeting-sub');
            if(titleEl) titleEl.innerText = t;
            if(subEl) subEl.innerText = s;
        }

        // --- TIMER ---
        let tInt, tLeft = 45*60, isRunning = false;
        function setTimer(m) { resetTimer(); tLeft = m*60; updateT(); }
        function setCustomTimer() {
            const val = parseInt(document.getElementById('custom-min').value);
            if(val > 0) setTimer(val);
        }
        function toggleTimer() {
            if(isRunning) { clearInterval(tInt); isRunning = false; document.getElementById('timer-status').innerText = "å·²æš‚åœ"; }
            else {
                isRunning = true; document.getElementById('timer-status').innerText = "ä¸“æ³¨ä¸­...";
                tInt = setInterval(() => {
                    tLeft--; updateT();
                    if(tLeft<=0) { clearInterval(tInt); alert("å®Œæˆï¼â˜•ï¸"); resetTimer(); }
                }, 1000);
            }
        }
        function resetTimer() { clearInterval(tInt); isRunning = false; tLeft = 45*60; updateT(); document.getElementById('timer-status').innerText = "ç‚¹å‡»å¼€å§‹"; }
        function updateT() {
            const m = Math.floor(tLeft/60).toString().padStart(2,'0');
            const s = (tLeft%60).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
        }

        // --- COUNTDOWN ---
        function startCountdown() {
            setInterval(() => {
                const now = new Date().getTime();
                const dist = examDate - now;
                if (dist < 0) return;
                const d = Math.floor(dist / (1000 * 60 * 60 * 24));
                const h = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((dist % (1000 * 60)) / 1000);
                
                document.getElementById('main-countdown-days').innerHTML = `${d} <span class="text-sm text-slate-400 font-sans font-normal">Days</span>`;
                document.getElementById('main-countdown-time').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }, 1000);
        }

        // --- DATA & CALC ---
        function calcTotal() {
            if (!document.getElementById('total-score')) return;
            let t = 0;
            ['pol','eng','math','cs'].forEach(k => {
                const el = document.getElementById(`s-${k}`);
                if (el) t += parseInt(el.value)||0;
            });
            document.getElementById('total-score').innerText = t;
            saveData();
        }
        function saveProgress() { saveData(); updateProgress(); }
        function updateProgress() {
            let checked = 0;
            const ids = ['t1','t2','t3','t4','t5','t6'];
            ids.forEach(id => { if(document.getElementById(id).checked) checked++; });
            document.getElementById('done-count').innerText = checked;
            const pct = Math.round((checked / 6) * 100);
            const c = 2 * Math.PI * 28; 
            const offset = c - (pct / 100) * c;
            document.getElementById('progress-ring').style.strokeDashoffset = offset;
            document.getElementById('progress-text').innerText = pct + '%';
        }
        function toggleWellness(id) {
            const btn = document.getElementById(id);
            btn.classList.toggle('done');
            saveData();
        }
        
        function saveData() {
            const data = { scores: {}, tasks: {}, wellness: {} };
            ['pol','eng','math','cs'].forEach(k => {
                const el = document.getElementById(`s-${k}`);
                if (el) data.scores[k] = el.value;
            });
            ['t1','t2','t3','t4','t5','t6'].forEach(k => {
                const el = document.getElementById(k);
                if (el) data.tasks[k] = el.checked;
            });
            ['w-water','w-fruit','w-eye','w-sleep'].forEach(k => {
                const el = document.getElementById(k);
                if (el) data.wellness[k] = el.classList.contains('done');
            });
            localStorage.setItem('22408_v23_data', JSON.stringify(data));
        }
        
        function loadData() {
            const d = JSON.parse(localStorage.getItem('22408_v23_data') || '{}');
            // Default Scores
            if(!d.scores) {
                if(document.getElementById('s-pol')) document.getElementById('s-pol').value = 65;
                if(document.getElementById('s-eng')) document.getElementById('s-eng').value = 75;
                if(document.getElementById('s-math')) document.getElementById('s-math').value = 120;
                if(document.getElementById('s-cs')) document.getElementById('s-cs').value = 120;
            } else {
                ['pol','eng','math','cs'].forEach(k => { if(d.scores[k] && document.getElementById(`s-${k}`)) document.getElementById(`s-${k}`).value = d.scores[k]; });
            }
            if(d.tasks) for(let k in d.tasks) { if(document.getElementById(k)) document.getElementById(k).checked = d.tasks[k]; }
            if(d.wellness) for(let k in d.wellness) { if(d.wellness[k] && document.getElementById(k)) document.getElementById(k).classList.add('done'); }
            calcTotal(); updateProgress();
        }
        
        function resetTasks() {
            if(confirm("å¼€å¯æ–°çš„ä¸€å¤©ï¼Ÿ")) {
                ['t1','t2','t3','t4','t5','t6'].forEach(k => { if(document.getElementById(k)) document.getElementById(k).checked = false; });
                ['w-water','w-fruit','w-eye','w-sleep'].forEach(k => { if(document.getElementById(k)) document.getElementById(k).classList.remove('done'); });
                saveProgress();
            }
        }

        function toggleDarkMode() {
            if(document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                document.getElementById('theme-text').innerText = 'åˆ‡æ¢å¤œé—´æ¨¡å¼';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                document.getElementById('theme-text').innerText = 'åˆ‡æ¢æ—¥é—´æ¨¡å¼';
            }
        }
    </script>
</body>
</html>
